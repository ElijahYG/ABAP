<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=GBK" />
<title>ZFIRP0140_GET</title>
<style type="text/css">
.code{ font-family:"Courier New", Courier, monospace; color:#000; font-size:14px; background-color:#F2F4F7 }
  .codeComment {font-family:"Courier New", Courier, monospace; color:#0000F0; font-size:14px; background-color:#F2F4F7 }
  .normalBold{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:12px; font-weight:800 }
  .normalBoldLarge{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:16px; font-weight:800 }
</style>
<style type="text/css">
  .normal{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:12px }
  .footer{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:12px; text-align: center }
  h2{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:16px; font-weight:800 }
  h3{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:14px; font-weight:800 }
  .outerTable{
   background-color:#E0E7ED;
   width:100%;
   border-top-width: thin;
   border-right-width: thin;
   border-right-width: thin;
   border-left-width: thin;
   border-top-style: solid;
   border-right-style: solid;
   border-bottom-style: solid;
   border-left-style: solid;
  }
  .innerTable{
   background-color:#F2F4F7;
   width:100%;
   border-top-width: thin;
   border-right-width: thin;
   border-bottom-width: thin;
   border-left-width: thin;
   border-top-style: solid;
   border-right-style: solid;
   border-bottom-style: solid;
   border-left-style: solid;
  }
</style>
</head>
<body>
<table class="outerTable">
  <tr class="normalBoldLarge">
     <td><h2>Code listing for: ZFIRP0140_GET</h2>
<h3> Description: INCLUDE_联营结算取数_FORM</h3></td>
   </tr>
  <tr>
     <td>
     <table class="innerTable">
       <tr>
          <td>
   <div class="codeComment">
***********************************************************************************************************<br />
*----------------------SD相关取数-------------------------<br />
***********************************************************************************************************<br />
   </div>
   <div class="code">
FORM FM_GET_SDDATA TABLES IT_SD_TAB.<br />
   </div>
   <div class="codeComment">
*定义MSEG取数类型<br />
   </div>
   <div class="code">
&nbsp;&nbsp;TYPES:&nbsp;BEGIN&nbsp;OF&nbsp;STRU_MSEG,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"取MSEG相关数据<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MATNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MSEG-MATNR,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"物料号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CHARG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MSEG-CHARG,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"批号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AUFNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MSEG-AUFNR,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"内部订单号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BWART&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MSEG-BWART,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"移动类型<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WERKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MSEG-WERKS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"地点<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUKRS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MSEG-BUKRS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"销售公司代码<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MENGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MSEG-MENGE,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEINS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MSEG-MEINS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"单位<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SHKZG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MSEG-SHKZG,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"借贷标识,是否是退货的标记<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUDAT_MKPF&nbsp;TYPE&nbsp;MKPF-BUDAT,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"过账日期<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MBLNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MSEG-MBLNR,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"凭证编号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MJAHR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MSEG-MJAHR,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"凭证年度<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZEILE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MSEG-ZEILE,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"凭证行项目<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERV_TYPE&nbsp;&nbsp;TYPE&nbsp;CHAR10,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"业务类型<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BWKEY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;T001W-BWKEY,&nbsp;&nbsp;&nbsp;&nbsp;"评估范围<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;STRU_MSEG.<br />
<br />
   </div>
   <div class="codeComment">
*定义VBRK取数类型<br />
   </div>
   <div class="code">
&nbsp;&nbsp;TYPES:&nbsp;BEGIN&nbsp;OF&nbsp;STRU_MA_CH,<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MATNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-MATNR,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"物料号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CHARG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-CHARG,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"批号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUKRS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRK-BUKRS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"销售公司代码<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KUNAG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRK-KUNAG,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"门店编码<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WERKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-WERKS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"销售地点<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBELN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRK-VBELN,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"收入凭证<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EX_POSNUM&nbsp;TYPE&nbsp;VBRK-EX_POSNUM,&nbsp;"POS单号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ARKTX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-ARKTX,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"商品名称<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FKIMG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-FKIMG,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VRKME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-VRKME,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"单位<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SHKZG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-SHKZG,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"退货标识<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FKDAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRK-FKDAT,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"销售日期<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KZWI1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-KZWI1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"实销价格<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KZWI2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-KZWI2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"商品成本(POS发票)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KZWI3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-KZWI3,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"商场回款<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KZWI4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-KZWI4,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"优惠合计<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KZWI5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-KZWI5,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KZWI6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-KZWI6,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"标签价/零售价<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;POSNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-POSNR,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"行项目号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KNUMV&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRK-KNUMV,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"单据条件数<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AUFNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MSEG-AUFNR,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"内部订单号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERV_TYPE&nbsp;TYPE&nbsp;CHAR10,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"业务类型<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZB00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-KZWI1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"投资克基础价<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZKSG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-KZWI1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"销售克工费档加价<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZD01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-KZWI1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"以旧换新抵值<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VKP0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;VBRP-KZWI1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"参考零售价<br />
<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MBLNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MSEG-MBLNR,&nbsp;&nbsp;&nbsp;&nbsp;"凭证编号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MJAHR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MSEG-MJAHR,&nbsp;&nbsp;&nbsp;&nbsp;"凭证年度<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZEILE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MSEG-ZEILE,&nbsp;&nbsp;&nbsp;&nbsp;"凭证行项目<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;STRU_MA_CH,<br />
<br />
   </div>
   <div class="codeComment">
*定义结算方式类型<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN&nbsp;OF&nbsp;STRU_JSFS,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BM&nbsp;TYPE&nbsp;ZMMDG0010_JSFS-BM,<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SFLY&nbsp;TYPE&nbsp;ZMMDG0010_JSFS-SFLY,<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;STRU_JSFS.<br />
   </div>
   <div class="codeComment">
*定义内表<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;IT_BWART&nbsp;&nbsp;&nbsp;TYPE&nbsp;RANGE&nbsp;OF&nbsp;BWART,<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_BWART&nbsp;&nbsp;&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;&nbsp;IT_BWART,<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IT_LYJSFS&nbsp;&nbsp;TYPE&nbsp;RANGE&nbsp;OF&nbsp;ZMMDG0010_JSFS-BM,<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_LYJSFS&nbsp;&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;&nbsp;IT_LYJSFS,<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IT_JSFS&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;STRU_JSFS,<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_JSFS&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STRU_JSFS,<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IT_MSEGTAB&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;STRU_MSEG,<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_MSEGTAB&nbsp;TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STRU_MSEG,<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IT_MACHTAB&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;STRU_MA_CH,<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_MACHTAB&nbsp;TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STRU_MA_CH,<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IT_TAB_CAL&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;ZSDRP0020_CAL,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"联营商品结算输入输出表<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_TAB_CAL&nbsp;TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZSDRP0020_CAL.<br />
<br />
&nbsp;&nbsp;DATA:&nbsp;IT_ALV_TAB&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;STRU_ALV.<br />
<br />
   </div>
   <div class="codeComment">
*定义宏<br />
*给移动类型赋值<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DEFINE&nbsp;DF_ADD_BWART.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;WA_BWART.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_BWART-SIGN&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_BWART-OPTION&nbsp;&nbsp;=&nbsp;'EQ'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_BWART-LOW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&nbsp;&1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;WA_BWART&nbsp;TO&nbsp;IT_BWART.<br />
&nbsp;&nbsp;END-OF-DEFINITION.<br />
&nbsp;&nbsp;DF_ADD_BWART:<br />
&nbsp;&nbsp;'Z61','Z62'.<br />
<br />
   </div>
   <div class="codeComment">
*1.取MSEG相关数据<br />
*&nbsp;&nbsp;SELECT&nbsp;A~MATNR<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~CHARG<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~AUFNR<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~BWART<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~WERKS<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~BUKRS<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~MENGE<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~MEINS<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~SHKZG<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~BUDAT_MKPF<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~MBLNR<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~MJAHR<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~ZEILE<br />
*&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;MSEG&nbsp;AS&nbsp;A<br />
*&nbsp;&nbsp;&nbsp;&nbsp;INNER&nbsp;JOIN&nbsp;MARA&nbsp;AS&nbsp;B&nbsp;ON&nbsp;A~MATNR&nbsp;=&nbsp;B~MATNR<br />
*&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;IT_MSEGTAB<br />
*&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;A~BUDAT_MKPF&nbsp;IN&nbsp;RT_DATE<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;B~EXTWG&nbsp;IN&nbsp;S_EXTWG<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;B~RAUBE&nbsp;IN&nbsp;S_RAUBE<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;A~BWART&nbsp;IN&nbsp;IT_BWART<br />
**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;A~BUKRS&nbsp;IN&nbsp;S_BUKRS<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
*&nbsp;1,取联营结算方式<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SELECT&nbsp;BM<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;IT_JSFS<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;ZMMDG0010_JSFS<br />
&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;SFLY&nbsp;=&nbsp;'X'<br />
&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_JSFS&nbsp;INTO&nbsp;WA_JSFS.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;WA_LYJSFS.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_LYJSFS-SIGN&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_LYJSFS-OPTION&nbsp;&nbsp;=&nbsp;'EQ'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_LYJSFS-LOW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&nbsp;WA_JSFS-BM.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;WA_LYJSFS&nbsp;TO&nbsp;IT_LYJSFS.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;SELECT&nbsp;A~MATNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~CHARG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~AUFNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~BWART<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~WERKS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~MENGE<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~MEINS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~SHKZG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~BUDAT_MKPF<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~MBLNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~MJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~ZEILE<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;MSEG&nbsp;AS&nbsp;A<br />
&nbsp;&nbsp;&nbsp;&nbsp;INNER&nbsp;JOIN&nbsp;MARA&nbsp;AS&nbsp;B&nbsp;ON&nbsp;A~MATNR&nbsp;=&nbsp;B~MATNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;INNER&nbsp;JOIN&nbsp;ZMMRP0210_BATCH&nbsp;AS&nbsp;C&nbsp;ON&nbsp;A~MATNR&nbsp;=&nbsp;C~MATNR&nbsp;AND&nbsp;A~CHARG&nbsp;=&nbsp;C~CHARG<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;IT_MSEGTAB<br />
&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;A~BUDAT_MKPF&nbsp;IN&nbsp;RT_DATE<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;B~EXTWG&nbsp;&nbsp;&nbsp;IN&nbsp;S_EXTWG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;B~RAUBE&nbsp;&nbsp;&nbsp;IN&nbsp;S_RAUBE<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;A~BWART&nbsp;&nbsp;&nbsp;IN&nbsp;IT_BWART<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;C~ZGYSDM&nbsp;&nbsp;IN&nbsp;S_LIFNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;C~ZLYJSFS&nbsp;IN&nbsp;IT_LYJSFS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_MSEGTAB&nbsp;INTO&nbsp;WA_MSEGTAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;WA_MSEGTAB-BWART&nbsp;EQ&nbsp;'Z61'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_MSEGTAB-SERV_TYPE&nbsp;=&nbsp;'组合商品'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSEIF&nbsp;WA_MSEGTAB-BWART&nbsp;EQ&nbsp;'Z62'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_MSEGTAB-SERV_TYPE&nbsp;=&nbsp;'拆分商品'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;WA_MSEGTAB-SHKZG&nbsp;=&nbsp;'S'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_MSEGTAB-SHKZG&nbsp;=&nbsp;ABAP_TRUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSEIF&nbsp;WA_MSEGTAB-SHKZG&nbsp;=&nbsp;'H'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_MSEGTAB-SHKZG&nbsp;=&nbsp;ABAP_FALSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;IT_MSEGTAB&nbsp;FROM&nbsp;WA_MSEGTAB&nbsp;INDEX&nbsp;SY-TABIX&nbsp;TRANSPORTING&nbsp;SERV_TYPE&nbsp;SHKZG.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
*2.取VBRK相关数据<br />
<br />
*2.2,取VBRP中的销售数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SELECT&nbsp;VBRP~MATNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRP~CHARG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRK~BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRK~KUNAG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRP~WERKS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRK~VBELN<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRK~EX_POSNUM<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRP~ARKTX<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRP~FKIMG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRP~VRKME<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRP~SHKZG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRK~FKDAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRP~KZWI1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRP~KZWI2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRP~KZWI3<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRP~KZWI4<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRP~KZWI5<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRP~KZWI6<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRP~POSNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRK~KNUMV<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;IT_MACHTAB<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;VBRK<br />
&nbsp;&nbsp;&nbsp;&nbsp;INNER&nbsp;JOIN&nbsp;VBRP&nbsp;ON&nbsp;VBRK~VBELN&nbsp;=&nbsp;VBRP~VBELN<br />
&nbsp;&nbsp;&nbsp;&nbsp;INNER&nbsp;JOIN&nbsp;ZMMRP0210_BATCH&nbsp;AS&nbsp;A&nbsp;ON&nbsp;&nbsp;VBRP~MATNR&nbsp;=&nbsp;A~MATNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;VBRP~CHARG&nbsp;=&nbsp;A~CHARG<br />
&nbsp;&nbsp;&nbsp;&nbsp;INNER&nbsp;JOIN&nbsp;MARA&nbsp;ON&nbsp;VBRP~MATNR&nbsp;=&nbsp;MARA~MATNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;"VBRK~FKART&nbsp;=&nbsp;'FP'&nbsp;&nbsp;&nbsp;&nbsp;"20160901&nbsp;by&nbsp;李楠&nbsp;解除凭证类型限制让农商行的业务也能结算<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VBRK~FKDAT&nbsp;IN&nbsp;RT_DATE<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;VBRK~KUNAG&nbsp;IN&nbsp;S_KUNAG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;A~ZGYSDM&nbsp;&nbsp;&nbsp;IN&nbsp;S_LIFNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;MARA~EXTWG&nbsp;IN&nbsp;S_EXTWG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;MARA~RAUBE&nbsp;IN&nbsp;S_RAUBE<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;A~ZLYJSFS&nbsp;&nbsp;IN&nbsp;IT_LYJSFS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
<br />
   </div>
   <div class="codeComment">
*3.整理调用函数传入表<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_MSEGTAB&nbsp;INTO&nbsp;WA_MSEGTAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;WA_MACHTAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_MACHTAB-MATNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MSEGTAB-MATNR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_MACHTAB-CHARG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MSEGTAB-CHARG.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_MACHTAB-AUFNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MSEGTAB-AUFNR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_MACHTAB-BUKRS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MSEGTAB-BUKRS.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_MACHTAB-SERV_TYPE&nbsp;=&nbsp;WA_MSEGTAB-SERV_TYPE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_MACHTAB-FKIMG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MSEGTAB-MENGE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_MACHTAB-VRKME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MSEGTAB-MEINS.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_MACHTAB-SHKZG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MSEGTAB-SHKZG.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_MACHTAB-FKDAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MSEGTAB-BUDAT_MKPF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_MACHTAB-WERKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MSEGTAB-WERKS.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_MACHTAB-MBLNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MSEGTAB-MBLNR.&nbsp;&nbsp;&nbsp;&nbsp;"凭证编号<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_MACHTAB-MJAHR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MSEGTAB-MJAHR.&nbsp;&nbsp;&nbsp;&nbsp;"凭证年度<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_MACHTAB-ZEILE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MSEGTAB-ZEILE.&nbsp;&nbsp;&nbsp;&nbsp;"凭证行项目<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;WA_MACHTAB&nbsp;TO&nbsp;IT_MACHTAB.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
************************************************************************************<br />
*&nbsp;筛选投资订单配置表<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DATA:&nbsp;LT_ZSDRP0020_DD&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;ZSDRP0020_DD,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LS_ZSDRP0020_DD&nbsp;TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZSDRP0020_DD,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LT_MACHTAB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;STRU_MA_CH<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
<br />
&nbsp;&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;ZSDRP0020_DD&nbsp;INTO&nbsp;TABLE&nbsp;LT_ZSDRP0020_DD.<br />
<br />
&nbsp;&nbsp;SORT&nbsp;LT_ZSDRP0020_DD&nbsp;BY&nbsp;MATNR&nbsp;CHARG.<br />
<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_MACHTAB&nbsp;INTO&nbsp;WA_MACHTAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LS_ZSDRP0020_DD.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_ZSDRP0020_DD&nbsp;INTO&nbsp;LS_ZSDRP0020_DD&nbsp;WITH&nbsp;KEY&nbsp;MATNR&nbsp;=&nbsp;WA_MACHTAB-MATNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CHARG&nbsp;=&nbsp;WA_MACHTAB-CHARG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;NE&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;WA_MACHTAB&nbsp;TO&nbsp;LT_MACHTAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;CLEAR&nbsp;IT_MACHTAB.<br />
&nbsp;&nbsp;IT_MACHTAB&nbsp;=&nbsp;LT_MACHTAB.<br />
   </div>
   <div class="codeComment">
**************************************************************************************<br />
<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_MACHTAB&nbsp;INTO&nbsp;WA_MACHTAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;WA_TAB_CAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_TAB_CAL-WERKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-WERKS.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_TAB_CAL-FKDAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-FKDAT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_TAB_CAL-MATNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-MATNR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_TAB_CAL-CHARG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-CHARG.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_TAB_CAL-FKIMG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-FKIMG.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_TAB_CAL-SHKZG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-SHKZG.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_TAB_CAL-ZTZKJCJ_IN&nbsp;=&nbsp;WA_MACHTAB-KZWI5.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_TAB_CAL-ZCKLSJ_IN&nbsp;&nbsp;=&nbsp;WA_MACHTAB-KZWI6.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;WA_TAB_CAL&nbsp;TO&nbsp;IT_TAB_CAL.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;IF&nbsp;IT_TAB_CAL&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;S000(ZCB)&nbsp;WITH&nbsp;'未找到需要结算的商品'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LEAVE&nbsp;LIST-PROCESSING.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
   </div>
   <div class="codeComment">
*调用计算函数<br />
   </div>
   <div class="code">
&nbsp;&nbsp;call&nbsp;function&nbsp;<a&nbsp;href&nbsp;="zsdrp0020_fm/zsdrp0020_fm.html">'ZSDRP0020_FM'</a><br />
&nbsp;&nbsp;&nbsp;&nbsp;TABLES<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CT_TABLE&nbsp;=&nbsp;IT_TAB_CAL.<br />
<br />
   </div>
   <div class="codeComment">
******************以旧换新计算逻辑*******************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;TYPES:&nbsp;BEGIN&nbsp;OF&nbsp;STRU_KONV,<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KNUMV&nbsp;TYPE&nbsp;KONV-KNUMV,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KPOSN&nbsp;TYPE&nbsp;KONV-KPOSN,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KBETR&nbsp;TYPE&nbsp;KONV-KBETR,<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;STRU_KONV.<br />
<br />
&nbsp;&nbsp;DATA:&nbsp;IT_KONV&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;STRU_KONV,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IT_HZ&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;STRU_KONV,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_KONV&nbsp;&nbsp;TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STRU_KONV,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_TMP_K&nbsp;TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STRU_KONV.<br />
<br />
&nbsp;&nbsp;DATA:&nbsp;L_ZF94&nbsp;TYPE&nbsp;ZDE_ZJE.<br />
<br />
&nbsp;&nbsp;SELECT&nbsp;KNUMV<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KPOSN<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KBETR<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;IT_KONV<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;KONV<br />
&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;IT_MACHTAB<br />
&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;KNUMV&nbsp;=&nbsp;IT_MACHTAB-KNUMV<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;KPOSN&nbsp;=&nbsp;IT_MACHTAB-POSNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;KSCHL&nbsp;=&nbsp;'ZF94'.<br />
<br />
&nbsp;&nbsp;SORT&nbsp;IT_KONV&nbsp;BY&nbsp;KNUMV&nbsp;KPOSN.<br />
&nbsp;&nbsp;SORT&nbsp;IT_MACHTAB&nbsp;BY&nbsp;KNUMV&nbsp;POSNR.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_KONV&nbsp;INTO&nbsp;WA_TMP_K.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;WA_KONV.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_KONV&nbsp;=&nbsp;WA_TMP_K.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_ZF94&nbsp;=&nbsp;L_ZF94&nbsp;+&nbsp;WA_KONV-KBETR.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;AT&nbsp;END&nbsp;OF&nbsp;KPOSN.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_TMP_K-KNUMV&nbsp;=&nbsp;WA_KONV-KNUMV.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_TMP_K-KPOSN&nbsp;=&nbsp;WA_KONV-KPOSN.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_TMP_K-KBETR&nbsp;=&nbsp;L_ZF94.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;WA_TMP_K&nbsp;TO&nbsp;IT_HZ.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;L_ZF94.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDAT.<br />
<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_MACHTAB&nbsp;INTO&nbsp;WA_MACHTAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;WA_KONV.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;IT_HZ&nbsp;INTO&nbsp;WA_KONV&nbsp;WITH&nbsp;KEY&nbsp;KNUMV&nbsp;=&nbsp;WA_MACHTAB-KNUMV<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KPOSN&nbsp;=&nbsp;WA_MACHTAB-POSNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_MACHTAB-ZD01&nbsp;=&nbsp;WA_KONV-KBETR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;IT_MACHTAB&nbsp;FROM&nbsp;WA_MACHTAB&nbsp;TRANSPORTING&nbsp;ZD01.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
***********************END**************************<br />
<br />
*4.整合数据到输出表<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DATA&nbsp;L_NUM&nbsp;TYPE&nbsp;NUM4.<br />
<br />
&nbsp;&nbsp;CLEAR&nbsp;L_NUM.<br />
&nbsp;&nbsp;SORT&nbsp;IT_TAB_CAL&nbsp;BY&nbsp;SHKZG&nbsp;ZTZKJCJ_IN&nbsp;ZCKLSJ_IN&nbsp;WERKS&nbsp;FKDAT&nbsp;MATNR&nbsp;CHARG&nbsp;FKIMG.<br />
   </div>
   <div class="codeComment">
*将IT_TAB_CAL整合到ALV<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_MACHTAB&nbsp;INTO&nbsp;WA_MACHTAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;WA_TAB_CAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;IT_TAB_CAL&nbsp;INTO&nbsp;WA_TAB_CAL&nbsp;WITH&nbsp;KEY&nbsp;SHKZG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&nbsp;WA_MACHTAB-SHKZG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"退货标识<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZTZKJCJ_IN&nbsp;=&nbsp;&nbsp;WA_MACHTAB-KZWI5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"投资克基础价<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZCKLSJ_IN&nbsp;&nbsp;=&nbsp;&nbsp;WA_MACHTAB-KZWI6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"参考零售价<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WERKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&nbsp;WA_MACHTAB-WERKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"销售地点<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FKDAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&nbsp;WA_MACHTAB-FKDAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"过账日期/销售日期<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MATNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&nbsp;WA_MACHTAB-MATNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"物料编号/款号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CHARG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&nbsp;WA_MACHTAB-CHARG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"批次号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FKIMG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&nbsp;WA_MACHTAB-FKIMG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;WA_ALV_TAB.<br />
   </div>
   <div class="codeComment">
*取数数据&nbsp;&nbsp;合并<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-SERV_TYPE&nbsp;=&nbsp;WA_MACHTAB-SERV_TYPE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-AUFNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-AUFNR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-XBLNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-EX_POSNUM.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-VBELN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-VBELN.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZD01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-ZD01.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-POSNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-POSNR&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-KZWI1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-KZWI1&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-KZWI2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-KZWI2&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-KZWI3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-KZWI3&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-KZWI4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-KZWI4&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-KZWI5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-KZWI5&nbsp;.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-KZWI6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-KZWI6&nbsp;.<br />
<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZMBLNR&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-MBLNR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZMJAHR&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-MJAHR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZZEILE&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_MACHTAB-ZEILE.<br />
<br />
   </div>
   <div class="codeComment">
*批次计算属性数据&nbsp;&nbsp;合并<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-WERKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-WERKS.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"销售地点<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-FKDAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-FKDAT.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"销售日期<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-MATNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-MATNR.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"物料编号/款号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-CHARG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-CHARG.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"批次号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-FKIMG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-FKIMG.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-SHKZG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-SHKZG.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"退货项目<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZTZKJCJ&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZTZKJCJ_OUT.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"投资克基础价<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZCKLSJ&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZCKLSJ_OUT.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"参考零售价<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-KZWI6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZCKLSJ_OUT.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"参考零售价<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZLYJSFS&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZLYJSFS.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"联营结算方式<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-SFLY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-SFLY.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"是否联营<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-EXTWG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-EXTWG.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"商品大类<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-RAUBE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-RAUBE.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"小类<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ARKTX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZBQMC.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"标签名称<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZGYSDM&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZGYSDM.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"供应商代码<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZJZ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZJZ.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"单品金重<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZJSJJ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZJSJJ.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"结算克金价<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZJSKGF&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZJSKGF.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"结算克工费<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZJSDKZ&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZJSDKZ.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"结算克倒扣值<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZLYJSYKJ&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZLYJSYKJ.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"联营结算一口价<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZJSKL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZJSKL.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"结算扣率<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZXSKGFD&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZXSKGFD.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"销售克工费档<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZKLTZ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZJSKL_WERKS.&nbsp;&nbsp;&nbsp;"扣率调整<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZXSKGF&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZXSKGF.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"销售克工费<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZXSJS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZXSJS.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"销售件数<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZXSKZ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZXSKZ.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"销售克重<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-MEINS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-MEINS.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"基本计量单位<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-MBLNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-MBLNR.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"商品凭证编号/入库单号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-MJAHR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-MJAHR.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"商品凭证年度<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-PO_BUKRS&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZBUKRS_PUR.&nbsp;&nbsp;&nbsp;&nbsp;"采购公司<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-BUKRS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZBUKRS_SAL.&nbsp;&nbsp;&nbsp;&nbsp;"销售公司<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-WERKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZWERKS_SAL.&nbsp;&nbsp;&nbsp;&nbsp;"销售地点<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZWERKS_SAL_TAX&nbsp;=&nbsp;WA_TAB_CAL-ZWERKS_SAL_TAX.&nbsp;&nbsp;&nbsp;"销售地点税分类<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-KUNAG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-KUNNR.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"门店编号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZIC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZIC.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"是否跨公司<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZJSJE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZPUR_AMT.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"结算金额/采购金额<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZPUR_TAX&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZPUR_TAX.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"采购税率<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZPUR_COST&nbsp;=&nbsp;WA_TAB_CAL-ZPUR_COST.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"采购成本<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZIC_ADD_RATE&nbsp;=&nbsp;WA_TAB_CAL-ZIC_ADD_RATE.&nbsp;&nbsp;&nbsp;&nbsp;"公司间加价率<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZIC_ADD_PRIC&nbsp;=&nbsp;WA_TAB_CAL-ZIC_ADD_PRIC.&nbsp;&nbsp;&nbsp;&nbsp;"公司间加价克单价<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZIC_AMT&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZIC_AMT.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"公司间采购/销售金额<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZIC_SAL_COST&nbsp;=&nbsp;WA_TAB_CAL-ZIC_SAL_COST.&nbsp;&nbsp;&nbsp;&nbsp;"公司间销售成本<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZIC_PUR_COST&nbsp;=&nbsp;WA_TAB_CAL-ZIC_PUR_COST.&nbsp;&nbsp;&nbsp;&nbsp;"公司间采购成本<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZSAL_COST&nbsp;=&nbsp;WA_TAB_CAL-ZSAL_COST.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"最终销售成本<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZBUKRS_PUR&nbsp;=&nbsp;WA_TAB_CAL-ZBUKRS_PUR.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"采购公司<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZEKORG_PUR&nbsp;=&nbsp;WA_TAB_CAL-ZEKORG_PUR.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"采购地点的采购组织<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZVKORG_PUR&nbsp;=&nbsp;WA_TAB_CAL-ZVKORG_PUR.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"采购地点的销售组织<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZWERKS_PUR&nbsp;=&nbsp;WA_TAB_CAL-ZWERKS_PUR.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"采购地点<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZBUKRS_SAL&nbsp;=&nbsp;WA_TAB_CAL-ZBUKRS_SAL.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"销售公司<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZWERKS_SAL&nbsp;=&nbsp;WA_TAB_CAL-ZWERKS_SAL.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"销售地点<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;WA_ALV_TAB-ZXSKZ&nbsp;NE&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZB00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;WA_TAB_CAL-ZTZKJCJ_OUT&nbsp;/&nbsp;WA_ALV_TAB-ZXSKZ.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"投资克基础价<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;WA_ALV_TAB&nbsp;TO&nbsp;IT_ALV_TAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
*5.对输出表进行计算和整理<br />
*&nbsp;&nbsp;DATA:&nbsp;WA_TMP_ALV&nbsp;TYPE&nbsp;&nbsp;ZSDRP0020_ALV.<br />
<br />
**计算优惠金额<br />
*&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_ALV_TAB&nbsp;INTO&nbsp;WA_TMP_ALV.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;WA_ALV_TAB.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-KZWI1&nbsp;=&nbsp;WA_TMP_ALV-KZWI1&nbsp;-&nbsp;WA_TMP_ALV-ZD01.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZYHJG&nbsp;=&nbsp;WA_TMP_ALV-KZWI6&nbsp;-&nbsp;WA_ALV_TAB-KZWI1.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;IT_ALV_TAB&nbsp;FROM&nbsp;WA_ALV_TAB&nbsp;INDEX&nbsp;SY-TABIX&nbsp;TRANSPORTING&nbsp;ZYHJG&nbsp;KZWI1.<br />
*&nbsp;&nbsp;ENDLOOP.<br />
**确定业务类型<br />
*&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_ALV_TAB&nbsp;INTO&nbsp;WA_ALV_TAB.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;WA_ALV_TAB-SHKZG&nbsp;=&nbsp;'H'&nbsp;OR&nbsp;WA_ALV_TAB-SHKZG&nbsp;IS&nbsp;INITIAL.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-SERV_TYPE&nbsp;=&nbsp;'商品销售'.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ELSEIF&nbsp;WA_ALV_TAB-SHKZG&nbsp;=&nbsp;'S'&nbsp;OR&nbsp;WA_ALV_TAB-SHKZG&nbsp;=&nbsp;'X'.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-SERV_TYPE&nbsp;=&nbsp;'商品退货'.<br />
****************20151027增加退货克重负显示***************<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZXSKZ&nbsp;=&nbsp;-1&nbsp;*&nbsp;WA_ALV_TAB-ZXSKZ.<br />
*********************************************************<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;IT_ALV_TAB&nbsp;FROM&nbsp;WA_ALV_TAB&nbsp;INDEX&nbsp;SY-TABIX&nbsp;TRANSPORTING&nbsp;SERV_TYPE&nbsp;ZXSKZ.<br />
*&nbsp;&nbsp;ENDLOOP.<br />
<br />
*---------------------------------------------------------------------------------------<br />
   </div>
   <div class="code">
&nbsp;&nbsp;FIELD-SYMBOLS:&nbsp;&lt;WA_TMP_TAB&gt;&nbsp;TYPE&nbsp;STRU_ALV.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_ALV_TAB&nbsp;ASSIGNING&nbsp;&lt;WA_TMP_TAB&gt;.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;WA_TMP_TAB&gt;-KZWI1&nbsp;=&nbsp;&lt;WA_TMP_TAB&gt;-KZWI1&nbsp;-&nbsp;&lt;WA_TMP_TAB&gt;-ZD01.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;WA_TMP_TAB&gt;-ZYHJG&nbsp;=&nbsp;&lt;WA_TMP_TAB&gt;-KZWI6&nbsp;-&nbsp;&lt;WA_TMP_TAB&gt;-KZWI1.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;WA_TMP_TAB&gt;-SERV_TYPE&nbsp;IS&nbsp;INITIAL&nbsp;AND&nbsp;&nbsp;&lt;WA_TMP_TAB&gt;-SHKZG&nbsp;IS&nbsp;INITIAL&nbsp;."&nbsp;(&nbsp;&lt;WA_TMP_TAB&gt;-SHKZG&nbsp;=&nbsp;'H'&nbsp;OR&nbsp;&lt;WA_TMP_TAB&gt;-SHKZG&nbsp;IS&nbsp;INITIAL&nbsp;).<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;WA_TMP_TAB&gt;-SERV_TYPE&nbsp;=&nbsp;'商品销售'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSEIF&nbsp;&lt;WA_TMP_TAB&gt;-SERV_TYPE&nbsp;IS&nbsp;INITIAL&nbsp;AND&nbsp;&lt;WA_TMP_TAB&gt;-SHKZG&nbsp;=&nbsp;'X'."&nbsp;(&nbsp;&lt;WA_TMP_TAB&gt;-SHKZG&nbsp;=&nbsp;'S'&nbsp;OR&nbsp;&lt;WA_TMP_TAB&gt;-SHKZG&nbsp;=&nbsp;'X'&nbsp;).<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;WA_TMP_TAB&gt;-SERV_TYPE&nbsp;=&nbsp;'商品退货'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;WA_TMP_TAB&gt;-SHKZG&nbsp;=&nbsp;'X'.<br />
   </div>
   <div class="codeComment">
***************20151027增加退货克重负显示***************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;WA_TMP_TAB&gt;-ZXSKZ&nbsp;=&nbsp;-1&nbsp;*&nbsp;&lt;WA_TMP_TAB&gt;-ZXSKZ.<br />
   </div>
   <div class="codeComment">
********************************************************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
*---------------------------------------------------------------------------------------<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DATA:&nbsp;IT_BM&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;ZFIRP0140_TY_BM,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_BM&nbsp;TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZFIRP0140_TY_BM.<br />
<br />
&nbsp;&nbsp;FIELD-SYMBOLS:&nbsp;&lt;WA_ALV_TAB&gt;&nbsp;TYPE&nbsp;STRU_ALV.<br />
<br />
&nbsp;&nbsp;MOVE-CORRESPONDING&nbsp;IT_ALV_TAB&nbsp;TO&nbsp;IT_BM.<br />
<br />
&nbsp;&nbsp;call&nbsp;function&nbsp;<a&nbsp;href&nbsp;="zfirp0140_fg_modify/zfirp0140_fg_modify.html">'ZFIRP0140_FG_MODIFY'</a><br />
&nbsp;&nbsp;&nbsp;&nbsp;TABLES<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IT_BM&nbsp;=&nbsp;IT_BM.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_BM&nbsp;INTO&nbsp;WA_BM.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'CONVERSION_EXIT_ALPHA_OUTPUT'<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INPUT&nbsp;&nbsp;=&nbsp;WA_BM-KUNAG<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMPORTING<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OUTPUT&nbsp;=&nbsp;WA_BM-KUNAG.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;&nbsp;IT_BM&nbsp;FROM&nbsp;&nbsp;WA_BM&nbsp;TRANSPORTING&nbsp;KUNAG.<br />
*&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_ALV_TAB&nbsp;ASSIGNING&nbsp;&lt;WA_ALV_TAB&gt;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;WA_BM.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;IT_BM&nbsp;INTO&nbsp;WA_BM&nbsp;WITH&nbsp;KEY&nbsp;EXTWG&nbsp;=&nbsp;&lt;WA_ALV_TAB&gt;-EXTWG&nbsp;ZLYJSFS&nbsp;&nbsp;=&nbsp;&lt;WA_ALV_TAB&gt;-ZLYJSFS.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;WA_ALV_TAB&gt;-EWBEZ&nbsp;=&nbsp;WA_BM-EWBEZ.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;WA_ALV_TAB&gt;-BMTXT&nbsp;=&nbsp;WA_BM-BMTXT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;WA_ALV_TAB&gt;-RAUBE&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;IT_BM&nbsp;INTO&nbsp;WA_BM&nbsp;WITH&nbsp;KEY&nbsp;RAUBE&nbsp;=&nbsp;&lt;WA_ALV_TAB&gt;-RAUBE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;WA_ALV_TAB&gt;-RBTXT&nbsp;=&nbsp;WA_BM-RBTXT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;WA_ALV_TAB&gt;-MATKL&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;IT_BM&nbsp;INTO&nbsp;WA_BM&nbsp;WITH&nbsp;KEY&nbsp;MATKL&nbsp;=&nbsp;&lt;WA_ALV_TAB&gt;-MATKL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;WA_ALV_TAB&gt;-WGBEZ&nbsp;=&nbsp;WA_BM-WGBEZ.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;WA_ALV_TAB&gt;-KUNAG&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;IT_BM&nbsp;INTO&nbsp;WA_BM&nbsp;WITH&nbsp;KEY&nbsp;KUNAG&nbsp;=&nbsp;&lt;WA_ALV_TAB&gt;-KUNAG.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;WA_ALV_TAB&gt;-SORTL&nbsp;=&nbsp;WA_BM-SORTL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
*整理销售公司代码<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DELETE&nbsp;IT_ALV_TAB&nbsp;WHERE&nbsp;ZBUKRS_PUR&nbsp;NOT&nbsp;IN&nbsp;S_BUKRS.<br />
   </div>
   <div class="codeComment">
**整理大类<br />
*&nbsp;&nbsp;DELETE&nbsp;IT_ALV_TAB&nbsp;WHERE&nbsp;EXTWG&nbsp;NOT&nbsp;IN&nbsp;S_EXTWG&nbsp;OR&nbsp;EXTWG&nbsp;IS&nbsp;INITIAL.<br />
**整理小类<br />
*&nbsp;&nbsp;IF&nbsp;S_LIFNR&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;IT_ALV_TAB&nbsp;WHERE&nbsp;ZGYSDM&nbsp;NOT&nbsp;IN&nbsp;S_LIFNR&nbsp;OR&nbsp;ZGYSDM&nbsp;IS&nbsp;INITIAL.<br />
*&nbsp;&nbsp;ENDIF.<br />
<br />
*&nbsp;&nbsp;PERFORM&nbsp;FM_SERV_TYPE&nbsp;TABLES&nbsp;IT_ALV_TAB.<br />
<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_ALV_TAB&nbsp;INTO&nbsp;WA_ALV_TAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;WA_ALV_TAB-SERV_TYPE&nbsp;=&nbsp;'商品退货'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-KZWI6&nbsp;=&nbsp;-1&nbsp;*&nbsp;ABS(&nbsp;WA_ALV_TAB-KZWI6&nbsp;).<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZYHJG&nbsp;=&nbsp;WA_ALV_TAB-KZWI6&nbsp;-&nbsp;WA_ALV_TAB-KZWI1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;WA_ALV_TAB-BUKRS&nbsp;=&nbsp;'7000'&nbsp;AND&nbsp;WA_ALV_TAB-ZYHJG&nbsp;&lt;&nbsp;0&nbsp;AND&nbsp;WA_ALV_TAB-SHKZG&nbsp;=&nbsp;ABAP_FALSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZYHJG&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSEIF&nbsp;WA_ALV_TAB-BUKRS&nbsp;=&nbsp;'7000'&nbsp;AND&nbsp;WA_ALV_TAB-ZYHJG&nbsp;&gt;&nbsp;0&nbsp;AND&nbsp;WA_ALV_TAB-SHKZG&nbsp;=&nbsp;ABAP_TRUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_ALV_TAB-ZYHJG&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;IT_ALV_TAB&nbsp;FROM&nbsp;WA_ALV_TAB&nbsp;TRANSPORTING&nbsp;ZYHJG&nbsp;KZWI6.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
*-------------20160120.修改联营结算一口价结算金额---------------<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_ALV_TAB&nbsp;ASSIGNING&nbsp;&lt;WA_ALV_TAB&gt;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;WA_ALV_TAB&gt;-ZLYJSFS&nbsp;=&nbsp;'Z06'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;WA_ALV_TAB&gt;-ZJSJE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;WA_ALV_TAB&gt;-ZJSJE&nbsp;*&nbsp;&lt;WA_ALV_TAB&gt;-ZXSJS.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"结算金额(含税)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;WA_ALV_TAB&gt;-ZSAL_COST&nbsp;=&nbsp;&lt;WA_ALV_TAB&gt;-ZSAL_COST&nbsp;*&nbsp;&lt;WA_ALV_TAB&gt;-ZXSJS.&nbsp;&nbsp;&nbsp;&nbsp;"最终销售成本<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;WA_ALV_TAB&gt;-ZPUR_COST&nbsp;=&nbsp;&lt;WA_ALV_TAB&gt;-ZPUR_COST&nbsp;*&nbsp;&lt;WA_ALV_TAB&gt;-ZXSJS.&nbsp;&nbsp;&nbsp;&nbsp;"采购成本<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;WA_ALV_TAB&gt;-SHKZG&nbsp;=&nbsp;ABAP_TRUE&nbsp;AND&nbsp;&lt;WA_ALV_TAB&gt;-KZWI6&nbsp;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;WA_ALV_TAB&gt;-KZWI6&nbsp;=&nbsp;ABS(&nbsp;&lt;WA_ALV_TAB&gt;-KZWI6&nbsp;)&nbsp;*&nbsp;-1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
*---------------------------end---------------------------------<br />
<br />
*-------------------20160317&nbsp;MODIFY&nbsp;BY&nbsp;LINAN&nbsp;更新合同号筛选-----------------<br />
   </div>
   <div class="code">
&nbsp;&nbsp;TYPES:&nbsp;BEGIN&nbsp;OF&nbsp;STRU_HTH,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MATNR&nbsp;TYPE&nbsp;MATNR,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CHARG&nbsp;TYPE&nbsp;CHARG_D,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZHTH&nbsp;&nbsp;TYPE&nbsp;ZDE_ZXQPSBM4,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;STRU_HTH,<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN&nbsp;OF&nbsp;STRU_CABN,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ATINN&nbsp;TYPE&nbsp;CABN-ATINN,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ATNAM&nbsp;TYPE&nbsp;CABN-ATNAM,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;STRU_CABN,<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN&nbsp;OF&nbsp;STRU_AUSP,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ATINN&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;AUSP-ATINN,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ATWRT&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;AUSP-ATWRT,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OBJEK&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;AUSP-OBJEK,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CUOBJ_BM&nbsp;TYPE&nbsp;MCH1-CUOBJ_BM,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;STRU_AUSP,<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN&nbsp;OF&nbsp;STRU_MCH1,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MATNR&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MCH1-MATNR,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CHARG&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;MCH1-CHARG,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CUOBJ_BM&nbsp;TYPE&nbsp;MCH1-CUOBJ_BM,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OBJEK&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;AUSP-OBJEK,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;STRU_MCH1.<br />
<br />
&nbsp;&nbsp;DATA:&nbsp;LT_CHARG&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;ZMM_CHARG,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LT_HTH&nbsp;&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;STRU_HTH,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LS_HTH&nbsp;&nbsp;&nbsp;TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STRU_HTH,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LT_CABN&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;STRU_CABN,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LS_CABN&nbsp;&nbsp;TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STRU_CABN,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LT_AUSP&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;STRU_AUSP,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LS_AUSP&nbsp;&nbsp;TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STRU_AUSP,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LT_MCH1&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;STRU_MCH1,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LS_MCH1&nbsp;&nbsp;TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STRU_MCH1,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LT_TAB&nbsp;&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;STRU_ALV.<br />
<br />
&nbsp;&nbsp;IF&nbsp;S_ZHTH[]&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;MOVE-CORRESPONDING&nbsp;IT_ALV_TAB[]&nbsp;TO&nbsp;LT_CHARG.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;LT_CHARG&nbsp;BY&nbsp;MATNR&nbsp;CHARG.<br />
&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;LT_CHARG&nbsp;COMPARING&nbsp;MATNR&nbsp;CHARG.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;取批次特性字段对应的内部特性<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;SINGLE&nbsp;ATINN<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ATNAM<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;CABN<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;LS_CABN<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ATNAM&nbsp;EQ&nbsp;'ZXQPSBM4'.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;通过物料批次取出特性对象编码<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;MATNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CHARG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CUOBJ_BM<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CUOBJ_BM<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;MCH1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;LT_MCH1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;LT_CHARG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;MATNR&nbsp;=&nbsp;LT_CHARG-MATNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;CHARG&nbsp;=&nbsp;LT_CHARG-CHARG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
   </div>
   <div class="codeComment">
*&nbsp;取所有符合条件的所有合同号<br />
*&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_MCH1&nbsp;INTO&nbsp;LS_MCH1.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;LS_MCH1-OBJEK&nbsp;=&nbsp;LS_MCH1-CUOBJ_BM.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;LT_MCH1&nbsp;FROM&nbsp;LS_MCH1&nbsp;TRANSPORTING&nbsp;OBJEK.<br />
*&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;ATINN<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ATWRT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OBJEK<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OBJEK<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;AUSP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;LT_AUSP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;LT_MCH1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;OBJEK&nbsp;=&nbsp;LT_MCH1-OBJEK<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ATINN&nbsp;=&nbsp;LS_CABN-ATINN<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ATWRT&nbsp;IN&nbsp;S_ZHTH[]<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LT_AUSP&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;S000(ZCB)&nbsp;WITH&nbsp;'没有找到相应商品'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LEAVE&nbsp;LIST-PROCESSING.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;LT_MCH1&nbsp;BY&nbsp;OBJEK.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;LT_AUSP&nbsp;BY&nbsp;OBJEK.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_MCH1&nbsp;INTO&nbsp;LS_MCH1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LS_AUSP.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_AUSP&nbsp;INTO&nbsp;LS_AUSP&nbsp;WITH&nbsp;KEY&nbsp;OBJEK&nbsp;=&nbsp;LS_MCH1-OBJEK&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LS_HTH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LS_HTH-MATNR&nbsp;=&nbsp;LS_MCH1-MATNR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LS_HTH-CHARG&nbsp;=&nbsp;LS_MCH1-CHARG.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LS_HTH-ZHTH&nbsp;&nbsp;=&nbsp;LS_AUSP-ATWRT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;LS_HTH&nbsp;TO&nbsp;LT_HTH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;筛选合同号对应的商品<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LT_TAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;LT_HTH&nbsp;BY&nbsp;MATNR&nbsp;CHARG.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_ALV_TAB&nbsp;INTO&nbsp;WA_ALV_TAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LS_HTH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_HTH&nbsp;INTO&nbsp;LS_HTH&nbsp;WITH&nbsp;KEY&nbsp;MATNR&nbsp;=&nbsp;WA_ALV_TAB-MATNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CHARG&nbsp;=&nbsp;WA_ALV_TAB-CHARG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;WA_ALV_TAB&nbsp;TO&nbsp;LT_TAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LT_TAB&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;S000(ZCB)&nbsp;WITH&nbsp;'没有找到符合条件的商品'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LEAVE&nbsp;LIST-PROCESSING.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IT_SD_TAB[]&nbsp;=&nbsp;LT_TAB[].<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ELSE.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;EXPORT&nbsp;LT_HTH&nbsp;TO&nbsp;MEMORY&nbsp;ID&nbsp;'ZFIRP0140_ZHTH'.<br />
*---------------------------------END--------------------------------------<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;IT_SD_TAB[]&nbsp;=&nbsp;IT_ALV_TAB[].<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
ENDFORM.<br />
            </div>
          </td>
        </tr>
      </table>
      </td>
      </tr>
   <tr>
<td class="footer">www.bjcaibai.com.cn201609</td>
   </tr>
</table>
</body>
</html>
