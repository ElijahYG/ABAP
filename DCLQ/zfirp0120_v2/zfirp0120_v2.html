<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=GBK" />
<title>ZFIRP0120_V2</title>
<style type="text/css">
.code{ font-family:"Courier New", Courier, monospace; color:#000; font-size:14px; background-color:#F2F4F7 }
  .codeComment {font-family:"Courier New", Courier, monospace; color:#0000F0; font-size:14px; background-color:#F2F4F7 }
  .normalBold{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:12px; font-weight:800 }
  .normalBoldLarge{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:16px; font-weight:800 }
</style>
<style type="text/css">
  .normal{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:12px }
  .footer{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:12px; text-align: center }
  h2{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:16px; font-weight:800 }
  h3{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:14px; font-weight:800 }
  .outerTable{
   background-color:#E0E7ED;
   width:100%;
   border-top-width: thin;
   border-right-width: thin;
   border-right-width: thin;
   border-left-width: thin;
   border-top-style: solid;
   border-right-style: solid;
   border-bottom-style: solid;
   border-left-style: solid;
  }
  .innerTable{
   background-color:#F2F4F7;
   width:100%;
   border-top-width: thin;
   border-right-width: thin;
   border-bottom-width: thin;
   border-left-width: thin;
   border-top-style: solid;
   border-right-style: solid;
   border-bottom-style: solid;
   border-left-style: solid;
  }
</style>
</head>
<body>
<table class="outerTable">
  <tr class="normalBoldLarge">
     <td><h2>Code listing for: ZFIRP0120_V2</h2>
<h3> Description: 会计凭证归档</h3></td>
   </tr>
  <tr>
     <td>
     <table class="innerTable">
       <tr>
          <td>
   <div class="code">
REPORT ZFIRP0120_V2.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;REPORT&nbsp;&nbsp;ZFIRP0120_V2<br />
*&nbsp;Application&nbsp;&nbsp;&nbsp;&nbsp;:<br />
*&nbsp;Subject&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;会计凭证归档<br />
*&nbsp;Author&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;liquan<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;DATE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AUTHOR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DESCRIPTION<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;----&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;----------&nbsp;&nbsp;&nbsp;&nbsp;-----------------<br />
*&&nbsp;2015/10/19&nbsp;&nbsp;&nbsp;&nbsp;liquan&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Initial<br />
*&---------------------------------------------------------------------*<br />
<br />
   </div>
   <div class="code">
include <a href ="zfi_common_form.html">ZFI_COMMON_FORM</a>.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&引入表<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
TABLES:<br />
&nbsp;&nbsp;ZFIRP0121_DOC,<br />
&nbsp;&nbsp;SETNODE,<br />
&nbsp;&nbsp;BKPF.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&定义类型<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
TYPES:<br />
&nbsp;&nbsp;BEGIN&nbsp;OF&nbsp;TY_OUT_TAB,<br />
&nbsp;&nbsp;&nbsp;&nbsp;SEL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;CHAR1,<br />
&nbsp;&nbsp;&nbsp;&nbsp;BUKRS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC-BUKRS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"公司代码<br />
&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC-BELNR,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"凭证编号<br />
&nbsp;&nbsp;&nbsp;&nbsp;BUZEI&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC-BUZEI,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"凭证行项目编号<br />
&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC-GJAHR,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"会计年度<br />
&nbsp;&nbsp;&nbsp;&nbsp;MONAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC-MONAT,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"会计期间<br />
&nbsp;&nbsp;&nbsp;&nbsp;DOC_NUMBER&nbsp;TYPE&nbsp;ZFIRP0121_DOC-DOC_NUMBER,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"归档编号<br />
&nbsp;&nbsp;&nbsp;&nbsp;BUDAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC-BUDAT,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"过账日期<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;BUTXT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC-BUTXT,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"会计凭证行项目文本<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;ZGROUP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC-ZGROUP,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"所属账套<br />
&nbsp;&nbsp;&nbsp;&nbsp;ZMONAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC-ZMONAT&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"所属会计期间<br />
&nbsp;&nbsp;&nbsp;&nbsp;ZHZZ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC-ZHZZ,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"汇总组<br />
&nbsp;&nbsp;&nbsp;&nbsp;ZHZBH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC-ZHZBH,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"虚拟汇总编号<br />
&nbsp;&nbsp;&nbsp;&nbsp;PRCTR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;FAGLFLEXA-PRCTR,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"利润中心<br />
&nbsp;&nbsp;&nbsp;&nbsp;BLART&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;BKPF-BLART,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"凭证类型<br />
&nbsp;&nbsp;&nbsp;&nbsp;DRCRK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;FAGLFLEXA-DRCRK,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"借贷标识<br />
&nbsp;&nbsp;&nbsp;&nbsp;HKONT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;FAGLFLEXA-RACCT,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"会计科目<br />
&nbsp;&nbsp;&nbsp;&nbsp;HSL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;FAGLFLEXA-HSL,<br />
&nbsp;&nbsp;&nbsp;&nbsp;STYTLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;LVC_T_STYL,<br />
&nbsp;&nbsp;END&nbsp;OF&nbsp;TY_OUT_TAB,<br />
&nbsp;&nbsp;TYT_OUT_TAB&nbsp;TYPE&nbsp;TY_OUT_TAB&nbsp;OCCURS&nbsp;0.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&定义全局数据<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
DATA:<br />
&nbsp;&nbsp;GT_ORI_TAB&nbsp;TYPE&nbsp;TYT_OUT_TAB,<br />
&nbsp;&nbsp;GT_DOC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;GT_OUT_TAB&nbsp;TYPE&nbsp;TYT_OUT_TAB.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&选择屏幕<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
SELECTION-SCREEN BEGIN OF BLOCK BK1 WITH FRAME TITLE TEXT-T01.<br />
SELECT-OPTIONS:<br />
&nbsp;&nbsp;S_SNAME&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;SETNODE-SETNAME&nbsp;NO-EXTENSION&nbsp;NO&nbsp;INTERVALS&nbsp;OBLIGATORY,&nbsp;&nbsp;&nbsp;"利润中心组<br />
&nbsp;&nbsp;S_BUDAT&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;BKPF-BUDAT&nbsp;OBLIGATORY,<br />
&nbsp;&nbsp;S_DOCNUM&nbsp;&nbsp;&nbsp;FOR&nbsp;ZFIRP0121_DOC-DOC_NUMBER.<br />
SELECTION-SCREEN END OF BLOCK BK1.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&初始化<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
INITIALIZATION.<br />
&nbsp;&nbsp;PERFORM&nbsp;FM_INIT.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&帮助<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
AT SELECTION-SCREEN ON VALUE-REQUEST FOR S_SNAME-LOW.<br />
&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'K_GROUP_SELECT'<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLASS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'0106'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FIELD_NAME&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'PRCTR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TABLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'CCSS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<br />
&nbsp;&nbsp;&nbsp;&nbsp;IMPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SET_NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;S_SNAME-LOW<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NO_SET_PICKED&nbsp;=&nbsp;1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&数据检查<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
AT SELECTION-SCREEN.<br />
&nbsp;&nbsp;IF&nbsp;SY-UCOMM&nbsp;=&nbsp;'ONLI'.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;数据检查<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;FM_CHECK_DATA.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;权限检查<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;FM_AUTH_CHECK&nbsp;USING&nbsp;&nbsp;''&nbsp;''&nbsp;&nbsp;S_SNAME[].<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&F8<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
START-OF-SELECTION.<br />
   </div>
   <div class="codeComment">
*&nbsp;数据查询<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;FM_GET_DATA.<br />
   </div>
   <div class="codeComment">
*&nbsp;锁表<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;FM_LOCK.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&选择屏幕结束<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
END-OF-SELECTION.<br />
&nbsp;&nbsp;PERFORM&nbsp;FM_SHOW_ALV.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&初始化：清空全局变量<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_INIT.<br />
&nbsp;&nbsp;CLEAR:<br />
&nbsp;&nbsp;&nbsp;&nbsp;GT_OUT_TAB.<br />
&nbsp;&nbsp;IF&nbsp;S_BUDAT[]&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;S_BUDAT-LOW&nbsp;=&nbsp;SY-DATUM.<br />
&nbsp;&nbsp;&nbsp;&nbsp;S_BUDAT-LOW+6(2)&nbsp;=&nbsp;'01'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'LAST_DAY_OF_MONTHS'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DAY_IN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;S_BUDAT-LOW<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LAST_DAY_OF_MONTH&nbsp;=&nbsp;S_BUDAT-HIGH<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DAY_IN_NO_DATE&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;S_BUDAT.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&数据检查<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_CHECK_DATA.<br />
   </div>
   <div class="codeComment">
*&nbsp;利润中心组检查<br />
*&nbsp;取CBAIDY下的利润中心组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SELECT&nbsp;COUNT(*)<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;SETNODE<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;SETCLASS&nbsp;=&nbsp;'0106'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;SETNAME&nbsp;&nbsp;=&nbsp;'CBAIDY'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;SUBSETNAME&nbsp;IN&nbsp;S_SNAME<br />
&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;E000(ZCB)&nbsp;WITH&nbsp;'只能选择CBAIDY组下的利润中心组'&nbsp;.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&取数<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_GET_DATA.<br />
   </div>
   <div class="codeComment">
*&nbsp;1.根据条件取原始会计凭证<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;FM_GET_ORI_DATA.<br />
   </div>
   <div class="codeComment">
*********&nbsp;MODIFY&nbsp;BY&nbsp;LIQUAN&nbsp;2015.12.02&nbsp;START&nbsp;*****************<br />
*&nbsp;删除同一期间已冲销凭证<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;FM_DEL_WRITE_OFF.<br />
   </div>
   <div class="codeComment">
*********&nbsp;MODIFY&nbsp;BY&nbsp;LIQUAN&nbsp;2015.12.02&nbsp;&nbsp;&nbsp;END&nbsp;*****************<br />
*&nbsp;2.计算所属账套、所属会计期间<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;FM_CAL_ZGROUP_ZMONAT.<br />
   </div>
   <div class="codeComment">
*&nbsp;3.获取、计算汇总组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;FM_GET_ZHZZ.<br />
   </div>
   <div class="codeComment">
*&nbsp;4.获取已归档数据的归档编号<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;FM_GET_RESULT.<br />
   </div>
   <div class="codeComment">
*&nbsp;5.计算虚拟汇总编号<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;FM_CAL_HZBH.<br />
   </div>
   <div class="codeComment">
*&nbsp;6.过滤<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;FM_FILTER.<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&删除已冲销凭证<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_DEL_WRITE_OFF.<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;BEGIN&nbsp;OF&nbsp;LW_BKPF,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUKRS&nbsp;TYPE&nbsp;BKPF-BUKRS,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;TYPE&nbsp;BKPF-BELNR,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;TYPE&nbsp;BKPF-GJAHR,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MONAT&nbsp;TYPE&nbsp;BKPF-MONAT,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STBLG&nbsp;TYPE&nbsp;BKPF-STBLG,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STJAH&nbsp;TYPE&nbsp;BKPF-STJAH,<br />
&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;LW_BKPF,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_DOC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_OUT_TAB&nbsp;LIKE&nbsp;GT_OUT_TAB,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_BKPF_CX&nbsp;LIKE&nbsp;LW_BKPF&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_BKPF_CX&nbsp;LIKE&nbsp;LW_BKPF,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_TMP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIKE&nbsp;LW_BKPF&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_BKPF&nbsp;&nbsp;&nbsp;&nbsp;LIKE&nbsp;LW_BKPF&nbsp;OCCURS&nbsp;0.<br />
   </div>
   <div class="codeComment">
*&nbsp;删除重复凭证<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LT_OUT_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR&nbsp;.<br />
&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;LT_OUT_TAB&nbsp;COMPARING&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR.<br />
   </div>
   <div class="codeComment">
*&nbsp;取凭证抬头<br />
   </div>
   <div class="code">
&nbsp;&nbsp;IF&nbsp;LT_OUT_TAB&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STBLG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STJAH<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;BKPF<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;LT_BKPF<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;LT_OUT_TAB<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;BUKRS&nbsp;=&nbsp;LT_OUT_TAB-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;BELNR&nbsp;=&nbsp;LT_OUT_TAB-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;GJAHR&nbsp;=&nbsp;LT_OUT_TAB-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;STBLG&nbsp;&lt;&gt;&nbsp;''<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*&nbsp;取冲销凭证<br />
   </div>
   <div class="code">
&nbsp;&nbsp;IF&nbsp;LT_BKPF&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STBLG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STJAH<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;BKPF<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;LT_BKPF_CX<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;LT_BKPF<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;BUKRS&nbsp;=&nbsp;LT_BKPF-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;BELNR&nbsp;=&nbsp;LT_BKPF-STBLG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;GJAHR&nbsp;=&nbsp;LT_BKPF-STJAH<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*&nbsp;确定冲销凭证:LT_TMP<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SORT&nbsp;LT_BKPF_CX&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR&nbsp;.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_BKPF&nbsp;INTO&nbsp;LW_BKPF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LW_BKPF_CX.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_BKPF_CX&nbsp;INTO&nbsp;LW_BKPF_CX<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;LW_BKPF-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;LW_BKPF-STBLG<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;LW_BKPF-STJAH<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CHECK&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LW_BKPF-MONAT&nbsp;BETWEEN&nbsp;12&nbsp;AND&nbsp;16.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LW_BKPF-MONAT&nbsp;=&nbsp;12.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LW_BKPF_CX-MONAT&nbsp;BETWEEN&nbsp;12&nbsp;AND&nbsp;16.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LW_BKPF_CX-MONAT&nbsp;=&nbsp;12.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;冲销和被冲销凭证期间相同，则不需要归档<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LW_BKPF-MONAT&nbsp;=&nbsp;LW_BKPF_CX-MONAT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;LW_BKPF&nbsp;TO&nbsp;LT_TMP.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
*&nbsp;删除同一期间已冲销的会计凭证<br />
   </div>
   <div class="code">
&nbsp;&nbsp;IF&nbsp;LT_TMP&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;查看已冲销凭证是否归档<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;ZFIRP0121_DOC<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;LT_DOC<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;LT_TMP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;BUKRS&nbsp;=&nbsp;LT_TMP-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;BELNR&nbsp;=&nbsp;LT_TMP-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;GJAHR&nbsp;=&nbsp;LT_TMP-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;弹出窗口确认是否删除已冲销凭证<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;FM_CONFIRM_WRITE_OFF&nbsp;TABLES&nbsp;LT_DOC.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;删除已冲销凭证<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;GT_OUT_TAB&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_TMP&nbsp;INTO&nbsp;LW_BKPF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DO&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;GT_OUT_TAB&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;LW_BKPF-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;LW_BKPF-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;LW_BKPF-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;GT_OUT_TAB&nbsp;INDEX&nbsp;SY-TABIX.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDDO.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&弹出窗口确认是否清空数据<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_CONFIRM_WRITE_OFF TABLES T_DOC STRUCTURE  ZFIRP0121_DOC .<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_DOC&nbsp;&nbsp;&nbsp;LIKE&nbsp;GT_DOC,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_DOC&nbsp;&nbsp;&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;LT_DOC,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_TMP&nbsp;&nbsp;&nbsp;LIKE&nbsp;GT_DOC,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_HEAD&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_HEAD&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_MSG&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;CHAR100,<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_ANSWER&nbsp;TYPE&nbsp;CHAR1.<br />
&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'POPUP_TO_CONFIRM'<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TITLEBAR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'确认'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT_QUESTION&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'已归档数据中存在已冲销凭证，是否删除这些凭证？'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT_BUTTON_1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'是'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT_BUTTON_2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'否'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DISPLAY_CANCEL_BUTTON&nbsp;=&nbsp;''<br />
&nbsp;&nbsp;&nbsp;&nbsp;IMPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ANSWER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;L_ANSWER<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT_NOT_FOUND&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2.<br />
&nbsp;&nbsp;CASE&nbsp;L_ANSWER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;'1'.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;ZFIRP0121_DOC&nbsp;FROM&nbsp;TABLE&nbsp;GT_DOC.<br />
<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;删除数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;T_DOC[]&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;ZFIRP0121_DOC&nbsp;FROM&nbsp;TABLE&nbsp;&nbsp;T_DOC.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;ID&nbsp;SY-MSGID<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;SY-MSGTY<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NUMBER&nbsp;SY-MSGNO<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;SY-MSGV1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SY-MSGV2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SY-MSGV3<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SY-MSGV4<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;L_MSG.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;S000(ZCB)&nbsp;WITH&nbsp;'清空数据失败，请重试:'&nbsp;L_MSG&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROLLBACK&nbsp;WORK.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LEAVE&nbsp;LIST-PROCESSING.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;删除附件张数数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;T_DOC[]&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;查看该归档号下，是否还存在其他未删除凭证<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;T_DOC&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;T_DOC&nbsp;COMPARING&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;ZFIRP0121_DOC<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;LT_DOC<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;T_DOC<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ZGROUP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;T_DOC-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;GJAHR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;T_DOC-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ZMONAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;T_DOC-ZMONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;DOC_NUMBER&nbsp;=&nbsp;T_DOC-DOC_NUMBER<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;确定完全没有凭证的归档编号，并删除<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;LT_DOC&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;LT_DOC&nbsp;COMPARING&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;T_DOC&nbsp;INTO&nbsp;LW_DOC.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_DOC&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;ZGROUP&nbsp;=&nbsp;LW_DOC-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;LW_DOC-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZMONAT&nbsp;=&nbsp;LW_DOC-ZMONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DOC_NUMBER&nbsp;=&nbsp;LW_DOC-DOC_NUMBER<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;LW_DOC&nbsp;TO&nbsp;LT_TMP.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;删除<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LT_TMP&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;LT_HEAD<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;ZFIRP0121_HEAD<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;LT_TMP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ZGROUP&nbsp;=&nbsp;LT_TMP-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;GJAHR&nbsp;&nbsp;=&nbsp;LT_TMP-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ZMONAT&nbsp;=&nbsp;LT_TMP-ZMONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LT_HEAD&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;ZFIRP0121_HEAD&nbsp;FROM&nbsp;TABLE&nbsp;LT_HEAD.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;ID&nbsp;SY-MSGID<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;SY-MSGTY<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NUMBER&nbsp;SY-MSGNO<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;SY-MSGV1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SY-MSGV2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SY-MSGV3<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SY-MSGV4<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;L_MSG.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;S000(ZCB)&nbsp;WITH&nbsp;'清空数据失败，请重试:'&nbsp;L_MSG&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROLLBACK&nbsp;WORK.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LEAVE&nbsp;LIST-PROCESSING.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COMMIT&nbsp;WORK&nbsp;AND&nbsp;WAIT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;'2'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;S000(ZCB)&nbsp;WITH&nbsp;'取消归档'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LEAVE&nbsp;LIST-PROCESSING.<br />
&nbsp;&nbsp;ENDCASE.<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&过滤<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_FILTER.<br />
&nbsp;&nbsp;IF&nbsp;S_DOCNUM[]&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;GT_OUT_TAB&nbsp;WHERE&nbsp;DOC_NUMBER&nbsp;NOT&nbsp;IN&nbsp;S_DOCNUM[].<br />
&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;IF&nbsp;GT_OUT_TAB&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;S000(ZCB)&nbsp;WITH&nbsp;'没有符合条件的会计凭证'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LEAVE&nbsp;LIST-PROCESSING.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&锁表<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_LOCK.<br />
&nbsp;&nbsp;DATA&nbsp;L_MSG&nbsp;TYPE&nbsp;CHAR100.<br />
&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'ENQUEUE_EZ_ZFIRP0121_DOC'<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOREIGN_LOCK&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SYSTEM_FAILURE&nbsp;=&nbsp;2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3.<br />
&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;ID&nbsp;SY-MSGID<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;SY-MSGTY<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NUMBER&nbsp;SY-MSGNO<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;SY-MSGV1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SY-MSGV2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SY-MSGV3<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SY-MSGV4<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;L_MSG.<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_MSG&nbsp;=&nbsp;'锁定失败：'&nbsp;&&&nbsp;L_MSG.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;S000(ZCB)&nbsp;WITH&nbsp;L_MSG&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LEAVE&nbsp;LIST-PROCESSING.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&取原始凭证<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_GET_ORI_DATA.<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;BEGIN&nbsp;OF&nbsp;LW_FAGA,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUKRS&nbsp;TYPE&nbsp;FAGLFLEXA-RBUKRS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"公司代码<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;TYPE&nbsp;FAGLFLEXA-DOCNR,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"凭证编号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUZEI&nbsp;TYPE&nbsp;FAGLFLEXA-DOCLN,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"凭证行项目编号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;TYPE&nbsp;FAGLFLEXA-RYEAR,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"会计年度<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUDAT&nbsp;TYPE&nbsp;FAGLFLEXA-BUDAT,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"过账日期<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DRCRK&nbsp;TYPE&nbsp;FAGLFLEXA-DRCRK,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"借贷标识<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRCTR&nbsp;TYPE&nbsp;FAGLFLEXA-PRCTR,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"利润中心<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HKONT&nbsp;TYPE&nbsp;FAGLFLEXA-RACCT,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"会计科目<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HSL&nbsp;&nbsp;&nbsp;TYPE&nbsp;FAGLFLEXA-HSL,<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MONAT&nbsp;TYPE&nbsp;BKPF-MONAT,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"期间<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BLART&nbsp;TYPE&nbsp;BKPF-BLART,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"凭证类型<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;LW_FAGA,<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_R_BLART&nbsp;TYPE&nbsp;RANGE&nbsp;OF&nbsp;BLART,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"凭证类型<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_R_BLART&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;LT_R_BLART,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_DTYPE&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DTYPE&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_DTYPE&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DTYPE,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_R_PRCTR&nbsp;TYPE&nbsp;RANGE&nbsp;OF&nbsp;PRCTR,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_R_PRCTR&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;LT_R_PRCTR,<br />
   </div>
   <div class="codeComment">
************************增加;20160728************************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;T_FAGA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIKE&nbsp;LW_FAGA&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;IT_FAGA&nbsp;&nbsp;&nbsp;&nbsp;LIKE&nbsp;LW_FAGA&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;S_FAGA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIKE&nbsp;LW_FAGA&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;Y_FAGA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIKE&nbsp;LW_FAGA&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;FIN_FAGA&nbsp;&nbsp;&nbsp;LIKE&nbsp;LW_FAGA&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;GT_FAGA&nbsp;&nbsp;&nbsp;&nbsp;LIKE&nbsp;LW_FAGA&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_FAGA&nbsp;&nbsp;&nbsp;&nbsp;LIKE&nbsp;LW_FAGA&nbsp;OCCURS&nbsp;0.<br />
   </div>
   <div class="codeComment">
*************************************************************<br />
**************STEP1:编辑取数条件******************<br />
*&nbsp;取利润中心组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;FM_GET_PRCTR&nbsp;USING&nbsp;S_SNAME[]&nbsp;LT_R_PRCTR.<br />
&nbsp;&nbsp;IF&nbsp;LT_R_PRCTR&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;S000(ZCB)&nbsp;WITH&nbsp;'没有符合条件的会计凭证'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LEAVE&nbsp;LIST-PROCESSING.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;取不需要的凭证类型<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;ZFIRP0121_DTYPE<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;LT_DTYPE<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;DOC_TP&nbsp;=&nbsp;'X'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
   </div>
   <div class="codeComment">
*&nbsp;生成选择表<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_DTYPE&nbsp;INTO&nbsp;LW_DTYPE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_R_BLART-SIGN&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_R_BLART-OPTION&nbsp;&nbsp;=&nbsp;'BT'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_R_BLART-LOW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;LW_DTYPE-BLART.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_R_BLART-HIGH&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;LW_DTYPE-BLART.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;LW_R_BLART&nbsp;TO&nbsp;LT_R_BLART.<br />
&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
**************STEP2:取数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;******************<br />
*&nbsp;取FAGA表<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SELECT&nbsp;A~RBUKRS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"公司代码<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~DOCNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"凭证编号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~DOCLN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"凭证行项目编号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~RYEAR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"会计年度<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~BUDAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"过账日期<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~DRCRK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"借贷标识<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~PRCTR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"利润中心<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~RACCT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"科目<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A~HSL<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B~MONAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"期间<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B~BLART&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"凭证类型<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;LT_FAGA<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;FAGLFLEXA&nbsp;AS&nbsp;A<br />
&nbsp;&nbsp;&nbsp;INNER&nbsp;JOIN&nbsp;BKPF&nbsp;AS&nbsp;B<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;A~RBUKRS&nbsp;=&nbsp;B~BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;A~DOCNR&nbsp;&nbsp;=&nbsp;B~BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;A~RYEAR&nbsp;&nbsp;=&nbsp;B~GJAHR<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;A~PRCTR&nbsp;IN&nbsp;LT_R_PRCTR&nbsp;&nbsp;"利润中心<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;B~BLART&nbsp;NOT&nbsp;IN&nbsp;LT_R_BLART&nbsp;&nbsp;"凭证类型<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;A~BUDAT&nbsp;IN&nbsp;S_BUDAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"过账日期<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
<br />
   </div>
   <div class="codeComment">
****************20160713&nbsp;修改：删除同一凭证编号&nbsp;借贷金额相等&nbsp;科目为2202099001(应付暂估)&nbsp;不进行归档*******************************************************<br />
****************20160728&nbsp;修改：当同一凭证编号下的科目为2202099001(应付暂估)且产生内部往来科目1122009001时，若1122009001的借贷金额合计为0，同样不归档********<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_DMBTR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;FAGLFLEXA-HSL,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LA_FAGA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIKE&nbsp;LW_FAGA,<br />
&nbsp;&nbsp;&nbsp;&nbsp;WA_FAGA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIKE&nbsp;LW_FAGA,<br />
&nbsp;&nbsp;&nbsp;&nbsp;IW_FAGA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIKE&nbsp;LW_FAGA,<br />
&nbsp;&nbsp;&nbsp;&nbsp;TW_FAGA&nbsp;LIKE&nbsp;LW_FAGA,<br />
&nbsp;&nbsp;&nbsp;&nbsp;SW_FAGA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIKE&nbsp;LW_FAGA,<br />
&nbsp;&nbsp;&nbsp;&nbsp;GW_FAGA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIKE&nbsp;LW_FAGA,<br />
&nbsp;&nbsp;&nbsp;&nbsp;YW_FAGA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIKE&nbsp;LW_FAGA,<br />
&nbsp;&nbsp;&nbsp;&nbsp;FIW_FAGA&nbsp;&nbsp;&nbsp;&nbsp;LIKE&nbsp;LW_FAGA,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_FAGA_TMP&nbsp;LIKE&nbsp;LW_FAGA.<br />
<br />
&nbsp;&nbsp;T_FAGA&nbsp;=&nbsp;LT_FAGA.<br />
<br />
&nbsp;&nbsp;DELETE&nbsp;T_FAGA&nbsp;WHERE&nbsp;HKONT&nbsp;&lt;&gt;&nbsp;'2202099001'.<br />
<br />
   </div>
   <div class="codeComment">
*判断T_FAGA表中涉及的会计凭证的行项目是否含有1122009001<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SORT&nbsp;T_FAGA&nbsp;&nbsp;BY&nbsp;BELNR&nbsp;HKONT&nbsp;.<br />
<br />
&nbsp;&nbsp;CLEAR&nbsp;TW_FAGA.<br />
&nbsp;&nbsp;CLEAR&nbsp;LA_FAGA.<br />
<br />
&nbsp;&nbsp;SORT&nbsp;T_FAGA&nbsp;BY&nbsp;BELNR.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_FAGA&nbsp;INTO&nbsp;LA_FAGA.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;T_FAGA&nbsp;INTO&nbsp;TW_FAGA&nbsp;WITH&nbsp;KEY&nbsp;BELNR&nbsp;=&nbsp;LA_FAGA-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_FAGA-BELNR&nbsp;=&nbsp;LA_FAGA-BELNR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_FAGA-BUZEI&nbsp;=&nbsp;LA_FAGA-BUZEI.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_FAGA-GJAHR&nbsp;=&nbsp;LA_FAGA-GJAHR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_FAGA-BUDAT&nbsp;=&nbsp;LA_FAGA-BUDAT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_FAGA-DRCRK&nbsp;=&nbsp;LA_FAGA-DRCRK.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_FAGA-PRCTR&nbsp;=&nbsp;LA_FAGA-PRCTR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_FAGA-HKONT&nbsp;=&nbsp;LA_FAGA-HKONT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_FAGA-HSL&nbsp;&nbsp;&nbsp;=&nbsp;LA_FAGA-HSL&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_FAGA-MONAT&nbsp;=&nbsp;LA_FAGA-MONAT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WA_FAGA-BLART&nbsp;=&nbsp;LA_FAGA-BLART.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;WA_FAGA&nbsp;TO&nbsp;IT_FAGA.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"含有2202099001的凭证及这些凭证下的其它科目的行项目&nbsp;C表<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;GT_FAGA&nbsp;=&nbsp;IT_FAGA.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"B表<br />
<br />
&nbsp;&nbsp;CLEAR&nbsp;WA_FAGA.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;如果同一凭证号中，科目为1122009001和2202099001的行项目，借贷方金额合计为0，则删除<br />
   </div>
   <div class="code">
&nbsp;&nbsp;CLEAR&nbsp;SW_FAGA.<br />
&nbsp;&nbsp;CLEAR&nbsp;IW_FAGA&nbsp;.<br />
<br />
&nbsp;&nbsp;S_FAGA&nbsp;=&nbsp;IT_FAGA.<br />
<br />
&nbsp;&nbsp;SORT&nbsp;S_FAGA&nbsp;BY&nbsp;BELNR&nbsp;HKONT.<br />
<br />
&nbsp;&nbsp;DELETE&nbsp;S_FAGA&nbsp;WHERE&nbsp;HKONT&nbsp;&lt;&gt;&nbsp;'2202099001'.<br />
<br />
&nbsp;&nbsp;CLEAR&nbsp;SW_FAGA.<br />
<br />
&nbsp;&nbsp;SORT&nbsp;S_FAGA&nbsp;BY&nbsp;BELNR&nbsp;HKONT.<br />
<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;S_FAGA&nbsp;INTO&nbsp;SW_FAGA.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SW_FAGA&nbsp;=&nbsp;'S'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_DMBTR&nbsp;=&nbsp;L_DMBTR&nbsp;+&nbsp;SW_FAGA-HSL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSE&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_DMBTR&nbsp;=&nbsp;L_DMBTR&nbsp;+&nbsp;SW_FAGA-HSL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AT&nbsp;END&nbsp;OF&nbsp;BELNR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;L_DMBTR&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;S_FAGA&nbsp;WHERE&nbsp;BELNR&nbsp;=&nbsp;&nbsp;SW_FAGA-BELNR&nbsp;AND&nbsp;HKONT&nbsp;='2202099001'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;L_DMBTR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDAT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;CLEAR&nbsp;SW_FAGA.<br />
<br />
&nbsp;&nbsp;IF&nbsp;S_FAGA&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;IT_FAGA&nbsp;WHERE&nbsp;&nbsp;HKONT&nbsp;=&nbsp;'2202099001'.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;IT_FAGA&nbsp;BY&nbsp;BELNR&nbsp;HKONT.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;IT_FAGA&nbsp;WHERE&nbsp;HKONT&nbsp;&lt;&gt;&nbsp;'1122009001'.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"删除1122009001&nbsp;H=S&nbsp;行项目<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;SW_FAGA.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;IT_FAGA&nbsp;BY&nbsp;BELNR&nbsp;HKONT.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_FAGA&nbsp;INTO&nbsp;SW_FAGA.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SW_FAGA&nbsp;=&nbsp;'S'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_DMBTR&nbsp;=&nbsp;L_DMBTR&nbsp;+&nbsp;SW_FAGA-HSL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_DMBTR&nbsp;=&nbsp;L_DMBTR&nbsp;+&nbsp;SW_FAGA-HSL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AT&nbsp;END&nbsp;OF&nbsp;BELNR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;L_DMBTR&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;IT_FAGA&nbsp;WHERE&nbsp;BELNR&nbsp;=&nbsp;&nbsp;SW_FAGA-BELNR&nbsp;AND&nbsp;HKONT&nbsp;='1122009001'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;L_DMBTR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDAT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;SW_FAGA.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LW_FAGA_TMP.<br />
<br />
   </div>
   <div class="codeComment">
************************************************&nbsp;Y_FAGA&nbsp;再往&nbsp;LT_FAGA&nbsp;进行更新*********************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;SW_FAGA.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LA_FAGA.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LW_FAGA_TMP.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;IW_FAGA.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;IT_FAGA&nbsp;BY&nbsp;BELNR&nbsp;BUZEI.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_FAGA&nbsp;INTO&nbsp;GW_FAGA&nbsp;.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"GT_FAGA&nbsp;为&nbsp;含有2202099001的凭证及这些凭证下的其它科目的行项目表&nbsp;C表<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;IT_FAGA&nbsp;INTO&nbsp;IW_FAGA&nbsp;WITH&nbsp;KEY&nbsp;BELNR&nbsp;=&nbsp;GW_FAGA-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUZEI&nbsp;=&nbsp;GW_FAGA-BUZEI<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GW_FAGA&nbsp;TO&nbsp;Y_FAGA.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
<br />
SORT Y_FAGA BY BELNR BUZEI.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_FAGA&nbsp;INTO&nbsp;LA_FAGA.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;Y_FAGA&nbsp;INTO&nbsp;YW_FAGA&nbsp;WITH&nbsp;KEY&nbsp;BELNR&nbsp;=&nbsp;LA_FAGA-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUZEI&nbsp;=&nbsp;LA_FAGA-BUZEI<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;LA_FAGA&nbsp;TO&nbsp;FIN_FAGA.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;赋值到out表<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;MOVE-CORRESPONDING&nbsp;FIN_FAGA&nbsp;TO&nbsp;GT_OUT_TAB.<br />
<br />
&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;S_FAGA&nbsp;BY&nbsp;BELNR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_FAGA&nbsp;INTO&nbsp;IW_FAGA.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;S_FAGA&nbsp;INTO&nbsp;SW_FAGA&nbsp;WITH&nbsp;KEY&nbsp;BELNR&nbsp;=&nbsp;IW_FAGA-BELNR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"BUZEI与BELNR为确定一行的主键<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUZEI&nbsp;=&nbsp;IW_FAGA-BUZEI<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MOVE-CORRESPONDING&nbsp;IW_FAGA&nbsp;TO&nbsp;LW_FAGA_TMP.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;IT_FAGA&nbsp;WHERE&nbsp;BELNR&nbsp;=&nbsp;&nbsp;LW_FAGA_TMP-BELNR&nbsp;AND&nbsp;HKONT&nbsp;=&nbsp;'2202099001'.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"剩1122009001<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;SW_FAGA.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;IT_FAGA&nbsp;BY&nbsp;BELNR&nbsp;HKONT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;IT_FAGA&nbsp;INTO&nbsp;SW_FAGA.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SW_FAGA&nbsp;=&nbsp;'S'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_DMBTR&nbsp;=&nbsp;L_DMBTR&nbsp;+&nbsp;SW_FAGA-HSL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_DMBTR&nbsp;=&nbsp;L_DMBTR&nbsp;+&nbsp;SW_FAGA-HSL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AT&nbsp;END&nbsp;OF&nbsp;BELNR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;L_DMBTR&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;IT_FAGA&nbsp;WHERE&nbsp;BELNR&nbsp;=&nbsp;&nbsp;SW_FAGA-BELNR&nbsp;AND&nbsp;HKONT&nbsp;='1122009001'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;L_DMBTR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDAT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
************************************************&nbsp;IT_FAGA&nbsp;再往&nbsp;LT_FAGA&nbsp;进行更新*********************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;SW_FAGA.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LA_FAGA.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LW_FAGA_TMP.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;IW_FAGA.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;IT_FAGA&nbsp;BY&nbsp;BELNR&nbsp;BUZEI.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_FAGA&nbsp;INTO&nbsp;GW_FAGA&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;IT_FAGA&nbsp;INTO&nbsp;IW_FAGA&nbsp;WITH&nbsp;KEY&nbsp;BELNR&nbsp;=&nbsp;GW_FAGA-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUZEI&nbsp;=&nbsp;GW_FAGA-BUZEI<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GW_FAGA&nbsp;TO&nbsp;Y_FAGA.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
<br />
SORT Y_FAGA BY BELNR BUZEI.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_FAGA&nbsp;INTO&nbsp;LA_FAGA.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;Y_FAGA&nbsp;INTO&nbsp;YW_FAGA&nbsp;WITH&nbsp;KEY&nbsp;BELNR&nbsp;=&nbsp;LA_FAGA-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUZEI&nbsp;=&nbsp;LA_FAGA-BUZEI<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;LA_FAGA&nbsp;TO&nbsp;FIN_FAGA.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;赋值到out表<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;MOVE-CORRESPONDING&nbsp;FIN_FAGA&nbsp;TO&nbsp;GT_OUT_TAB.<br />
<br />
&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;CLEAR&nbsp;SW_FAGA.<br />
&nbsp;&nbsp;CLEAR&nbsp;LW_FAGA_TMP.<br />
&nbsp;&nbsp;CLEAR&nbsp;IW_FAGA.<br />
<br />
&nbsp;&nbsp;IF&nbsp;GT_OUT_TAB&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;S000(ZCB)&nbsp;WITH&nbsp;'没有符合条件的会计凭证'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LEAVE&nbsp;LIST-PROCESSING.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&计算所属账套、所属会计期间<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_CAL_ZGROUP_ZMONAT.<br />
&nbsp;&nbsp;FIELD-SYMBOLS&nbsp;&lt;FS&gt;&nbsp;&nbsp;&nbsp;TYPE&nbsp;TY_OUT_TAB.<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_R_SETNAME&nbsp;TYPE&nbsp;RANGE&nbsp;OF&nbsp;SETNAMENEW,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_R_SETNAME&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;LT_R_SETNAME,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_R_PRCTR&nbsp;&nbsp;&nbsp;TYPE&nbsp;RANGE&nbsp;OF&nbsp;PRCTR,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_R_PRCTR&nbsp;&nbsp;&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;&nbsp;LT_R_PRCTR,<br />
&nbsp;&nbsp;&nbsp;&nbsp;BEGIN&nbsp;OF&nbsp;LW_SETNODE,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUBSETNAME&nbsp;TYPE&nbsp;SETNODE-SUBSETNAME,<br />
&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;LW_SETNODE,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_SETNODE&nbsp;LIKE&nbsp;LW_SETNODE&nbsp;OCCURS&nbsp;0.<br />
   </div>
   <div class="codeComment">
*&nbsp;获取符合条件的利润中心组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SELECT&nbsp;SUBSETNAME<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;SETNODE<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;LT_SETNODE<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;SETCLASS&nbsp;=&nbsp;'0106'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;SETNAME&nbsp;&nbsp;=&nbsp;'CBAIDY'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;SUBSETNAME&nbsp;IN&nbsp;S_SNAME<br />
&nbsp;&nbsp;&nbsp;&nbsp;.<br />
   </div>
   <div class="codeComment">
*&nbsp;编辑所属账套（利润中心组）<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_SETNODE&nbsp;INTO&nbsp;LW_SETNODE.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;编辑利润中心组选择表<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LT_R_SETNAME.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LT_R_PRCTR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LW_R_SETNAME.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_R_SETNAME-SIGN&nbsp;&nbsp;&nbsp;=&nbsp;'I'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_R_SETNAME-OPTION&nbsp;=&nbsp;'EQ'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_R_SETNAME-LOW&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;LW_SETNODE-SUBSETNAME.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;LW_R_SETNAME&nbsp;TO&nbsp;LT_R_SETNAME.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;取利润中心组下的所有利润中心<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;FM_GET_PRCTR&nbsp;USING&nbsp;LT_R_SETNAME&nbsp;LT_R_PRCTR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LT_R_PRCTR&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;更新利润中心组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;&nbsp;WHERE&nbsp;PRCTR&nbsp;IN&nbsp;LT_R_PRCTR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZGROUP&nbsp;=&nbsp;LW_SETNODE-SUBSETNAME.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;编辑所属会计期间<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZMONAT&nbsp;=&nbsp;&lt;FS&gt;-MONAT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;FS&gt;-MONAT&nbsp;BETWEEN&nbsp;'13'&nbsp;AND&nbsp;'16'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZMONAT&nbsp;=&nbsp;'12'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&汇总组<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_GET_ZHZZ.<br />
&nbsp;&nbsp;FIELD-SYMBOLS&nbsp;&lt;FS&gt;&nbsp;TYPE&nbsp;TY_OUT_TAB.<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_OUT_TAB&nbsp;&nbsp;TYPE&nbsp;TYT_OUT_TAB,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_OUT_TAB2&nbsp;TYPE&nbsp;TYT_OUT_TAB,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_OUT_TAB3&nbsp;TYPE&nbsp;TYT_OUT_TAB,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_OUT_TAB&nbsp;&nbsp;TYPE&nbsp;TY_OUT_TAB,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_RE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DTYPE,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_DTYPE&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DTYPE&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_DTYPE&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DTYPE.<br />
<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;取汇总规则表<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;LT_DTYPE<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;ZFIRP0121_DTYPE<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;DOC_TP&nbsp;=&nbsp;''<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ZHZZ&nbsp;&nbsp;&nbsp;&lt;&gt;&nbsp;''<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;SORT&nbsp;LT_DTYPE&nbsp;BY&nbsp;BLART.<br />
   </div>
   <div class="codeComment">
*&nbsp;更新汇总组到OUT表<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LW_DTYPE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_DTYPE&nbsp;INTO&nbsp;LW_DTYPE<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BLART&nbsp;=&nbsp;&lt;FS&gt;-BLART<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZHZZ&nbsp;=&nbsp;LW_DTYPE-ZHZZ.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
*******凭证编号按照汇总组顺序编号，汇总组01为第一顺序、汇总组05为第二顺序，汇总组07为第三顺序************************<br />
************2016.04.07&nbsp;王岩&nbsp;修改********************************************************************************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;CLEAR:LW_OUT_TAB.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;INTO&nbsp;&nbsp;LW_OUT_TAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LW_OUT_TAB-ZHZZ&nbsp;=&nbsp;5.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LW_OUT_TAB-ZHZZ&nbsp;=&nbsp;2.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LW_OUT_TAB-ZHZZ&nbsp;=&nbsp;7.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LW_OUT_TAB-ZHZZ&nbsp;=&nbsp;5.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;GT_OUT_TAB&nbsp;FROM&nbsp;LW_OUT_TAB&nbsp;TRANSPORTING&nbsp;ZHZZ.<br />
&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
***********************特殊规则处理*******************************************<br />
*&nbsp;规则1：WA类型、且有任意行项目的会计科目为6401001000~6401004999，就归到RV类型对应的汇总组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;CLEAR&nbsp;LW_RE.<br />
&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_DTYPE&nbsp;INTO&nbsp;LW_RE<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BLART&nbsp;=&nbsp;'RV'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_OUT_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;保留归结到RE类型的会计凭证<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB&nbsp;WHERE&nbsp;BLART&nbsp;&lt;&gt;&nbsp;'WA'&nbsp;OR&nbsp;HKONT&nbsp;NOT&nbsp;BETWEEN&nbsp;'6401001000'&nbsp;AND&nbsp;'6401004999'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;读取归结到RE的会计凭证，如果有，则更新汇总组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;&lt;FS&gt;-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;&lt;FS&gt;-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;&lt;FS&gt;-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
   </div>
   <div class="codeComment">
*-------------------------20151222修改--------------------------------------<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZHZZ&nbsp;=&nbsp;'01'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*-------------------------20151222修改--------------------------------------<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
   </div>
   <div class="codeComment">
*---20160319&nbsp;修改：WA类型、且有任意行项目的会计科目为（1403*或6401009099）且包含科目5*，就归到01汇总组&nbsp;--<br />
*&nbsp;规则2：WA类型、且有任意行项目的会计科目为（1403*或6401009099）&nbsp;且包含科目5*，就归到04汇总组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LT_OUT_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
   </div>
   <div class="codeComment">
*&nbsp;保留归结到RE类型的会计凭证<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB&nbsp;WHERE&nbsp;BLART&nbsp;&lt;&gt;&nbsp;'WA'&nbsp;OR&nbsp;(&nbsp;HKONT&nbsp;NP&nbsp;'1403*'&nbsp;AND&nbsp;HKONT&nbsp;&lt;&gt;&nbsp;'6401009099').<br />
<br />
&nbsp;&nbsp;LT_OUT_TAB2&nbsp;=&nbsp;GT_OUT_TAB.<br />
&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB2&nbsp;WHERE&nbsp;BLART&nbsp;&lt;&gt;&nbsp;'WA'&nbsp;OR&nbsp;HKONT&nbsp;NP&nbsp;'5*'.<br />
<br />
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;如果有，则更新汇总组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;&lt;FS&gt;-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;&lt;FS&gt;-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;&lt;FS&gt;-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;如果有，则继续<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB2&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;&lt;FS&gt;-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;&lt;FS&gt;-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;&lt;FS&gt;-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZHZZ&nbsp;=&nbsp;'01'.<br />
<br />
&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
*-----------------------------------------------------------------------------------------------------<br />
<br />
********************************20160526&nbsp;修改：为方便后面再次修正汇总组，将05汇总组改为02组**************<br />
*--------20160319&nbsp;修改：WA类型、且有任意行项目的会计科目为5*且包含2202*，就归到05汇总组-------------------<br />
*&nbsp;规则3：WA类型、且有任意行项目的会计科目为5*且包含2202*，就归到06汇总组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LT_OUT_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
   </div>
   <div class="codeComment">
*&nbsp;保留归结到RE类型的会计凭证<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB&nbsp;WHERE&nbsp;BLART&nbsp;&lt;&gt;&nbsp;'WA'&nbsp;OR&nbsp;(&nbsp;HKONT&nbsp;NP&nbsp;'5*'&nbsp;AND&nbsp;HKONT&nbsp;NP&nbsp;'2202*').<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;LT_OUT_TAB2&nbsp;=&nbsp;GT_OUT_TAB.<br />
*&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB2&nbsp;WHERE&nbsp;BLART&nbsp;&lt;&gt;&nbsp;'WA'&nbsp;OR&nbsp;HKONT&nbsp;NP&nbsp;'2202*'.<br />
<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB2&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR.<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;如果有，则继续<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;&lt;FS&gt;-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;&lt;FS&gt;-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;&lt;FS&gt;-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZHZZ&nbsp;=&nbsp;'02'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;如果有，则继续<br />
*&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB2&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;&lt;FS&gt;-BUKRS<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;&lt;FS&gt;-BELNR<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;&lt;FS&gt;-GJAHR<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZHZZ&nbsp;=&nbsp;'02'.<br />
   </div>
   <div class="code">
&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
*---------------------------------------------------------------------------------------------------<br />
<br />
******************20160602&nbsp;修改：WA类型、且有任意行项目的会计科目2202003*，就不分配汇总组*****************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LT_OUT_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB&nbsp;WHERE&nbsp;BLART&nbsp;&lt;&gt;&nbsp;'WA'&nbsp;OR&nbsp;HKONT&nbsp;NOT&nbsp;BETWEEN&nbsp;&nbsp;'2202003000'&nbsp;AND&nbsp;'2202003999'.<br />
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;如果有，则更新汇总组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;&lt;FS&gt;-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;&lt;FS&gt;-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;&lt;FS&gt;-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZHZZ&nbsp;=&nbsp;''.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
******************************************************************************************************<br />
<br />
<br />
*********20160601&nbsp;修改：WA类型、且有任意行项目的会计科目包含2202003*，不再分配汇总组********************<br />
*&nbsp;&nbsp;&nbsp;&nbsp;LT_OUT_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
*<br />
*&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB&nbsp;WHERE&nbsp;BLART&nbsp;&lt;&gt;&nbsp;'WA'&nbsp;OR&nbsp;HKONT&nbsp;BETWEEN&nbsp;'2202003000'&nbsp;AND&nbsp;'2202003999'.<br />
*&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR.<br />
*&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;.<br />
**&nbsp;&nbsp;&nbsp;如果有，则更新汇总组<br />
*&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;&lt;FS&gt;-BUKRS<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;&lt;FS&gt;-BELNR<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;&lt;FS&gt;-GJAHR<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZHZZ&nbsp;=&nbsp;''.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*&nbsp;&nbsp;ENDLOOP.<br />
****************************************************************************************************<br />
<br />
*-----------------20160207&nbsp;修改：删除规则4，将WL类型汇总到01组-----------------------------------------<br />
*&nbsp;原有规则4：WL类型、且有任意行项目的会计科目为6401*，不汇总<br />
<br />
*新规则：将WL类型汇总到01组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LT_OUT_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
   </div>
   <div class="codeComment">
*&nbsp;保留归结到RE类型的会计凭证<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB&nbsp;WHERE&nbsp;BLART&nbsp;&lt;&gt;&nbsp;'WL'.<br />
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;如果有，则更新汇总组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;&lt;FS&gt;-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;&lt;FS&gt;-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;&lt;FS&gt;-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZHZZ&nbsp;=&nbsp;'01'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
*----------------------------------------------------------------------------------------------------<br />
<br />
********************************20160526&nbsp;修改：为方便后面再次修正汇总组，将05汇总组改为02组**************<br />
**规则5：凭证类型为WE,科目为1408001002&nbsp;，汇总组归结到05<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LT_OUT_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
   </div>
   <div class="codeComment">
*&nbsp;保留归结到RE类型的会计凭证<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB&nbsp;WHERE&nbsp;BLART&nbsp;&lt;&gt;&nbsp;'WE'&nbsp;OR&nbsp;HKONT&nbsp;NP&nbsp;'1408001002'.<br />
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR.<br />
&nbsp;&nbsp;IF&nbsp;LT_OUT_TAB&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;读取归结到RE的会计凭证，如果有，则更新汇总组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;&lt;FS&gt;-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;&lt;FS&gt;-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;&lt;FS&gt;-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZHZZ&nbsp;=&nbsp;'02'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
   </div>
   <div class="codeComment">
**规则6：凭证类型为WA，行项目存在科目1405001003时，归档到01组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LT_OUT_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
   </div>
   <div class="codeComment">
*&nbsp;保留归结到WA类型的会计凭证<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB&nbsp;WHERE&nbsp;BLART&nbsp;&lt;&gt;&nbsp;'WA'&nbsp;OR&nbsp;&nbsp;HKONT&nbsp;&lt;&gt;&nbsp;'1405001003'.<br />
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;读取归结到RE的会计凭证，如果有，则更新汇总组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;&lt;FS&gt;-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;&lt;FS&gt;-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;&lt;FS&gt;-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZHZZ&nbsp;=&nbsp;'01'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
*------------------20160319&nbsp;修改：凭证类型为WA，含有科目1405001001，且金额&nbsp;贷方=借方&nbsp;时，归档到01组<br />
**规则7：凭证类型为WA，含有科目1405001001，且金额&nbsp;贷方=借方&nbsp;时，归档到01组************************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_LINE&nbsp;&nbsp;TYPE&nbsp;I,<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_END&nbsp;&nbsp;&nbsp;TYPE&nbsp;CHAR1,<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_TABIX&nbsp;TYPE&nbsp;I,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_NEXT&nbsp;LIKE&nbsp;LW_OUT_TAB,<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_DMBTR&nbsp;TYPE&nbsp;BSEG-DMBTR.<br />
&nbsp;&nbsp;LT_OUT_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB&nbsp;WHERE&nbsp;BLART&nbsp;&lt;&gt;&nbsp;'WA'&nbsp;OR&nbsp;HKONT&nbsp;&lt;&gt;&nbsp;'1405001001'.<br />
&nbsp;&nbsp;CLEAR&nbsp;LT_OUT_TAB2.<br />
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR.<br />
&nbsp;&nbsp;L_LINE&nbsp;=&nbsp;LINES(&nbsp;LT_OUT_TAB&nbsp;).<br />
&nbsp;&nbsp;CLEAR&nbsp;L_DMBTR.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_OUT_TAB&nbsp;INTO&nbsp;LW_OUT_TAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_TABIX&nbsp;=&nbsp;SY-TABIX.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;L_END.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;判断是否为凭证最后一行<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;L_TABIX&nbsp;=&nbsp;L_LINE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_END&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_TABIX&nbsp;=&nbsp;L_TABIX&nbsp;+&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;INTO&nbsp;LW_NEXT&nbsp;INDEX&nbsp;L_TABIX.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LW_OUT_TAB-BUKRS&nbsp;&lt;&gt;&nbsp;LW_NEXT-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;LW_OUT_TAB-BELNR&nbsp;&lt;&gt;&nbsp;LW_NEXT-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;LW_OUT_TAB-GJAHR&nbsp;&lt;&gt;&nbsp;LW_NEXT-GJAHR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_END&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LW_OUT_TAB-DRCRK&nbsp;=&nbsp;'S'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_DMBTR&nbsp;=&nbsp;L_DMBTR&nbsp;+&nbsp;ABS(&nbsp;LW_OUT_TAB-HSL&nbsp;).<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_DMBTR&nbsp;=&nbsp;L_DMBTR&nbsp;-&nbsp;ABS(&nbsp;LW_OUT_TAB-HSL&nbsp;).<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;L_END&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;L_DMBTR&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;LW_OUT_TAB&nbsp;TO&nbsp;LT_OUT_TAB2.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;LT_OUT_TAB&nbsp;=&nbsp;LT_OUT_TAB2.<br />
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;读取归结到RE的会计凭证，如果有，则更新汇总组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;&lt;FS&gt;-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;&lt;FS&gt;-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;&lt;FS&gt;-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZHZZ&nbsp;=&nbsp;'01'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
**20160321&nbsp;新增规则8：将WA类型,行项目的科目存在66*，汇总到06组-------------<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LT_OUT_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
   </div>
   <div class="codeComment">
*&nbsp;保留归结到WA类型的会计凭证<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB&nbsp;WHERE&nbsp;BLART&nbsp;&lt;&gt;&nbsp;'WA'&nbsp;OR&nbsp;HKONT&nbsp;NP&nbsp;'66*'.<br />
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;如果有，则更新汇总组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;&lt;FS&gt;-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;&lt;FS&gt;-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;&lt;FS&gt;-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZHZZ&nbsp;=&nbsp;'06'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
**20160425&nbsp;新增规则9：凭证类型为WA，且有任意行项目的会计科目为1122009001，汇总到01组************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LT_OUT_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
   </div>
   <div class="codeComment">
*&nbsp;保留归结到RE类型的会计凭证<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB&nbsp;WHERE&nbsp;BLART&nbsp;&lt;&gt;&nbsp;'WA'&nbsp;OR&nbsp;HKONT&nbsp;NP&nbsp;'1122009001'.<br />
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR.<br />
&nbsp;&nbsp;IF&nbsp;LT_OUT_TAB&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;读取归结到RE的会计凭证，如果有，则更新汇总组<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;&lt;FS&gt;-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;&lt;FS&gt;-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;&lt;FS&gt;-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZHZZ&nbsp;=&nbsp;'01'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
******************************************************************************************<br />
<br />
   </div>
   <div class="code">
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&获取已归档的数据<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_GET_GT_DOC.<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_OUT_TAB&nbsp;TYPE&nbsp;TYT_OUT_TAB.<br />
<br />
&nbsp;&nbsp;REFRESH&nbsp;GT_DOC.<br />
   </div>
   <div class="codeComment">
*&nbsp;按所属账套、会计年度、会计期间取数<br />
<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LT_OUT_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT.<br />
&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;LT_OUT_TAB&nbsp;COMPARING&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT.<br />
   </div>
   <div class="codeComment">
*&nbsp;取已归档数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;IF&nbsp;LT_OUT_TAB&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;ZFIRP0121_DOC<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;GT_DOC<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;LT_OUT_TAB<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ZGROUP&nbsp;=&nbsp;LT_OUT_TAB-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;GJAHR&nbsp;&nbsp;=&nbsp;LT_OUT_TAB-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ZMONAT&nbsp;=&nbsp;LT_OUT_TAB-ZMONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&获取已归档的数据<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_GET_RESULT.<br />
&nbsp;&nbsp;FIELD-SYMBOLS&nbsp;&lt;FS&gt;&nbsp;TYPE&nbsp;TY_OUT_TAB.<br />
<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_DOC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_OUT_TAB&nbsp;TYPE&nbsp;TYT_OUT_TAB.<br />
<br />
&nbsp;&nbsp;PERFORM&nbsp;FM_GET_GT_DOC.<br />
   </div>
   <div class="codeComment">
**************判断归档规则是否已修改**********************<br />
*&nbsp;如果归档规则已经修改，已归档的数据必定不符合当前的归档规则<br />
*&nbsp;在这个基础之上归档，数据肯定是混乱的，所以必须清空当前账套已归档的数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SORT&nbsp;GT_DOC&nbsp;BY&nbsp;BUKRS&nbsp;GJAHR&nbsp;BELNR&nbsp;BUZEI.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LW_DOC.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;GT_DOC&nbsp;INTO&nbsp;LW_DOC<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;&lt;FS&gt;-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;&lt;FS&gt;-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;&lt;FS&gt;-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUZEI&nbsp;=&nbsp;&lt;FS&gt;-BUZEI<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;FS&gt;-ZHZZ&nbsp;&lt;&gt;&nbsp;LW_DOC-ZHZZ.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;FM_CONFIRM.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
   </div>
   <div class="codeComment">
*******modify&nbsp;by&nbsp;liquan&nbsp;2015.11.24&nbsp;start&nbsp;*************<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bug修正：如果有汇总组，且虚拟编号=凭证编号，则报错<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LW_DOC-ZHZZ&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&nbsp;LW_DOC-ZHZBH&nbsp;=&nbsp;LW_DOC-BELNR.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;FM_CONFIRM.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*******modify&nbsp;by&nbsp;liquan&nbsp;2015.11.24&nbsp;&nbsp;&nbsp;end&nbsp;*************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
**************判断归档规则是否已修改**********************<br />
*&nbsp;将已归档数据更新到输出表中<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SORT&nbsp;GT_DOC&nbsp;BY&nbsp;BUKRS&nbsp;GJAHR&nbsp;BELNR&nbsp;BUZEI.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LW_DOC.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;GT_DOC&nbsp;INTO&nbsp;LW_DOC<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;&lt;FS&gt;-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;&lt;FS&gt;-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;&lt;FS&gt;-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUZEI&nbsp;=&nbsp;&lt;FS&gt;-BUZEI<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-DOC_NUMBER&nbsp;=&nbsp;LW_DOC-DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZHZBH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;LW_DOC-ZHZBH.<br />
&nbsp;&nbsp;ENDLOOP.<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&弹出窗口确认是否清空数据<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_CONFIRM.<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_DOC&nbsp;&nbsp;&nbsp;LIKE&nbsp;GT_DOC,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_TMP&nbsp;&nbsp;&nbsp;LIKE&nbsp;GT_DOC,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_HEAD&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_HEAD&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_MSG&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;CHAR100,<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_ANSWER&nbsp;TYPE&nbsp;CHAR1.<br />
&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'POPUP_TO_CONFIRM'<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TITLEBAR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'确认'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT_QUESTION&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'归档规则已变更，如需重新归档，须清空选中账套、期间所有已归档数据，是否清空'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT_BUTTON_1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'是'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT_BUTTON_2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'否'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DISPLAY_CANCEL_BUTTON&nbsp;=&nbsp;''<br />
&nbsp;&nbsp;&nbsp;&nbsp;IMPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ANSWER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;L_ANSWER<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT_NOT_FOUND&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2.<br />
&nbsp;&nbsp;CASE&nbsp;L_ANSWER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;'1'.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;ZFIRP0121_DOC&nbsp;FROM&nbsp;TABLE&nbsp;GT_DOC.<br />
<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;确定删除数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LT_DOC&nbsp;=&nbsp;GT_DOC.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;LT_DOC&nbsp;BY&nbsp;BUKRS&nbsp;GJAHR&nbsp;ZGROUP&nbsp;ZMONAT&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;LT_DOC&nbsp;COMPARING&nbsp;&nbsp;BUKRS&nbsp;GJAHR&nbsp;ZGROUP&nbsp;ZMONAT&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LT_DOC&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;LT_TMP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;ZFIRP0121_DOC<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;LT_DOC<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;BUKRS&nbsp;&nbsp;=&nbsp;LT_DOC-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;GJAHR&nbsp;&nbsp;=&nbsp;LT_DOC-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ZGROUP&nbsp;=&nbsp;LT_DOC-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ZMONAT&nbsp;=&nbsp;LT_DOC-ZMONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;LT_HEAD<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;ZFIRP0121_HEAD<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;LT_DOC<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ZGROUP&nbsp;=&nbsp;LT_DOC-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;GJAHR&nbsp;&nbsp;=&nbsp;LT_DOC-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ZMONAT&nbsp;=&nbsp;LT_DOC-ZMONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LT_TMP&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;ZFIRP0121_DOC&nbsp;FROM&nbsp;TABLE&nbsp;LT_TMP.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;ID&nbsp;SY-MSGID<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;SY-MSGTY<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NUMBER&nbsp;SY-MSGNO<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;SY-MSGV1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SY-MSGV2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SY-MSGV3<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SY-MSGV4<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;L_MSG.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;S000(ZCB)&nbsp;WITH&nbsp;'清空数据失败，请重试:'&nbsp;L_MSG&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROLLBACK&nbsp;WORK.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LEAVE&nbsp;LIST-PROCESSING.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LT_HEAD&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;ZFIRP0121_HEAD&nbsp;FROM&nbsp;TABLE&nbsp;LT_HEAD.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;ID&nbsp;SY-MSGID<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;SY-MSGTY<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NUMBER&nbsp;SY-MSGNO<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;SY-MSGV1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SY-MSGV2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SY-MSGV3<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SY-MSGV4<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;L_MSG.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;S000(ZCB)&nbsp;WITH&nbsp;'清空数据失败，请重试:'&nbsp;L_MSG&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROLLBACK&nbsp;WORK.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LEAVE&nbsp;LIST-PROCESSING.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COMMIT&nbsp;WORK&nbsp;AND&nbsp;WAIT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GT_DOC.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;'2'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;S000(ZCB)&nbsp;WITH&nbsp;'取消归档'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LEAVE&nbsp;LIST-PROCESSING.<br />
&nbsp;&nbsp;ENDCASE.<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&虚拟汇总编号<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_CAL_HZBH.<br />
&nbsp;&nbsp;FIELD-SYMBOLS&nbsp;&lt;FS&gt;&nbsp;TYPE&nbsp;TY_OUT_TAB.<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_PRE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;TY_OUT_TAB,<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_NEW_ZHZBH&nbsp;TYPE&nbsp;CHAR1,<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_ZHZBH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC-ZHZBH,<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_LINE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;I,<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_TABIX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;I,<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_CURRENT&nbsp;&nbsp;&nbsp;TYPE&nbsp;I,<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_NEW_GROUP&nbsp;TYPE&nbsp;CHAR1,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_OUT_TAB&nbsp;&nbsp;TYPE&nbsp;TYT_OUT_TAB,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_MAX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_MAX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_DOC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_OUT_TAB&nbsp;&nbsp;TYPE&nbsp;TY_OUT_TAB.<br />
<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_OUT_TAB1&nbsp;TYPE&nbsp;TYT_OUT_TAB,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_OUT_TAB2&nbsp;TYPE&nbsp;TYT_OUT_TAB,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_OUT_TAB3&nbsp;TYPE&nbsp;TYT_OUT_TAB.<br />
<br />
<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;&nbsp;WHERE&nbsp;ZHZZ&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZHZBH&nbsp;=&nbsp;&lt;FS&gt;-BELNR.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
**********STEP1：&nbsp;数据准备*****************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LT_OUT_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
   </div>
   <div class="codeComment">
*&nbsp;删除不需要汇总数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB&nbsp;WHERE&nbsp;ZHZZ&nbsp;IS&nbsp;INITIAL.<br />
   </div>
   <div class="codeComment">
*&nbsp;删除已有虚拟汇总编号的数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB&nbsp;WHERE&nbsp;ZHZBH&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
   </div>
   <div class="codeComment">
*&nbsp;如果所有数据都已有虚拟汇总编号，则不再处理<br />
   </div>
   <div class="code">
&nbsp;&nbsp;CHECK&nbsp;LT_OUT_TAB&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
   </div>
   <div class="codeComment">
*&nbsp;计算当前账套中&nbsp;最大的虚拟汇总编号<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LT_MAX&nbsp;=&nbsp;GT_DOC.<br />
&nbsp;&nbsp;DELETE&nbsp;LT_MAX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ZHZZ&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;DELETE&nbsp;LT_MAX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ZHZBH&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;SORT&nbsp;LT_MAX&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;ZHZBH&nbsp;DESCENDING.<br />
&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;LT_MAX&nbsp;COMPARING&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT.<br />
<br />
   </div>
   <div class="codeComment">
*********STEP2：&nbsp;计算*********************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SORT&nbsp;LT_MAX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;.<br />
   </div>
   <div class="codeComment">
******2016.04.14&nbsp;王岩&nbsp;改****************************************************************<br />
*&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;ZHZZ&nbsp;BUDAT&nbsp;."DRCRK.<br />
*&nbsp;&nbsp;SORT&nbsp;GT_DOC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;ZHZZ&nbsp;BUDAT&nbsp;."DRCRK.<br />
<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;ZHZZ&nbsp;BUDAT&nbsp;&nbsp;."DRCRK.<br />
&nbsp;&nbsp;SORT&nbsp;GT_DOC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;ZHZZ&nbsp;BUDAT&nbsp;."DRCRK.<br />
   </div>
   <div class="codeComment">
***************************************************************************************<br />
*****2016.04.11&nbsp;wangyan&nbsp;EDIT**********************************************************<br />
*&nbsp;&nbsp;LT_OUT_TAB1&nbsp;=&nbsp;LT_OUT_TAB.<br />
*&nbsp;&nbsp;LT_OUT_TAB2&nbsp;=&nbsp;LT_OUT_TAB.<br />
*&nbsp;&nbsp;LT_OUT_TAB3&nbsp;=&nbsp;LT_OUT_TAB.<br />
**&nbsp;&nbsp;LT_OUT_TAB4&nbsp;=&nbsp;LT_OUT_TAB.<br />
*<br />
*&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB&nbsp;&nbsp;WHERE&nbsp;ZHZZ&nbsp;&lt;&gt;&nbsp;1.<br />
*&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB1&nbsp;WHERE&nbsp;ZHZZ&nbsp;&lt;&gt;&nbsp;2.<br />
*&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB2&nbsp;WHERE&nbsp;ZHZZ&nbsp;&lt;&gt;&nbsp;5.<br />
*&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB3&nbsp;WHERE&nbsp;ZHZZ&nbsp;&lt;&gt;&nbsp;6.<br />
*<br />
*&nbsp;&nbsp;APPEND&nbsp;LINES&nbsp;OF&nbsp;&nbsp;LT_OUT_TAB1&nbsp;TO&nbsp;LT_OUT_TAB.<br />
*&nbsp;&nbsp;APPEND&nbsp;LINES&nbsp;OF&nbsp;&nbsp;LT_OUT_TAB2&nbsp;TO&nbsp;LT_OUT_TAB.<br />
*&nbsp;&nbsp;APPEND&nbsp;LINES&nbsp;OF&nbsp;&nbsp;LT_OUT_TAB3&nbsp;TO&nbsp;LT_OUT_TAB.<br />
<br />
**************************************************************************************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;L_LINE&nbsp;=&nbsp;LINES(&nbsp;LT_OUT_TAB&nbsp;).<br />
<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_OUT_TAB&nbsp;INTO&nbsp;LW_OUT_TAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_TABIX&nbsp;=&nbsp;SY-TABIX.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_NEW_ZHZBH,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_NEW_GROUP.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;判断是否为新的账套<br />
*&nbsp;&nbsp;&nbsp;判断是否需要重新编号<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;L_TABIX&nbsp;=&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_NEW_GROUP&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_NEW_ZHZBH&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_TABIX&nbsp;=&nbsp;L_TABIX&nbsp;-&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;INTO&nbsp;LW_PRE&nbsp;INDEX&nbsp;L_TABIX.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LW_OUT_TAB-ZGROUP&nbsp;&lt;&gt;&nbsp;LW_PRE-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;LW_OUT_TAB-GJAHR&nbsp;&nbsp;&lt;&gt;&nbsp;LW_PRE-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;LW_OUT_TAB-ZMONAT&nbsp;&lt;&gt;&nbsp;LW_PRE-ZMONAT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_NEW_GROUP&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LW_OUT_TAB-ZGROUP&nbsp;&lt;&gt;&nbsp;LW_PRE-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;LW_OUT_TAB-GJAHR&nbsp;&nbsp;&lt;&gt;&nbsp;LW_PRE-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;LW_OUT_TAB-ZMONAT&nbsp;&lt;&gt;&nbsp;LW_PRE-ZMONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;LW_OUT_TAB-ZHZZ&nbsp;&nbsp;&nbsp;&lt;&gt;&nbsp;LW_PRE-ZHZZ<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;LW_OUT_TAB-BUDAT&nbsp;&nbsp;&lt;&gt;&nbsp;LW_PRE-BUDAT<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;LW_OUT_TAB-DRCRK&nbsp;&nbsp;&lt;&gt;&nbsp;LW_PRE-DRCRK<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_NEW_ZHZBH&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;若是新的账套<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;L_NEW_GROUP&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LW_MAX.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_MAX&nbsp;INTO&nbsp;LW_MAX<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;ZGROUP&nbsp;=&nbsp;LW_OUT_TAB-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;&nbsp;=&nbsp;LW_OUT_TAB-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZMONAT&nbsp;=&nbsp;LW_OUT_TAB-ZMONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TRY.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_ZHZBH&nbsp;=&nbsp;LW_MAX-ZHZBH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_CURRENT&nbsp;=&nbsp;LW_MAX-ZHZBH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CATCH&nbsp;CX_ROOT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;S000(ZCB)&nbsp;WITH&nbsp;'归档规则已修改,如需修改,请先删除当前账套所有已归档的数据'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'W'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;L_CURRENT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDTRY.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;若需要重新编号<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;L_NEW_ZHZBH&nbsp;=&nbsp;'X'.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;看已归档数据中是否已有虚拟汇总编号<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LW_DOC.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;GT_DOC&nbsp;INTO&nbsp;LW_DOC<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;ZGROUP&nbsp;=&nbsp;LW_PRE-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;&nbsp;=&nbsp;LW_PRE-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZMONAT&nbsp;=&nbsp;LW_PRE-ZMONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZHZZ&nbsp;&nbsp;&nbsp;=&nbsp;LW_PRE-ZHZZ<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUDAT&nbsp;&nbsp;=&nbsp;LW_PRE-BUDAT<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DRCRK&nbsp;&nbsp;=&nbsp;LW_PRE-DRCRK<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_ZHZBH&nbsp;=&nbsp;LW_DOC-ZHZBH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;没有则重新产生<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;L_CURRENT&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_CURRENT&nbsp;=&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_ZHZBH&nbsp;=&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_CURRENT&nbsp;=&nbsp;L_CURRENT&nbsp;+&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_ZHZBH&nbsp;&nbsp;&nbsp;=&nbsp;L_CURRENT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONDENSE&nbsp;L_ZHZBH&nbsp;NO-GAPS.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_OUT_TAB-ZHZBH&nbsp;=&nbsp;L_ZHZBH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;LT_OUT_TAB&nbsp;FROM&nbsp;LW_OUT_TAB.<br />
&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
*&nbsp;将虚拟汇总编号更新至内表<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;BUKRS&nbsp;GJAHR&nbsp;BELNR&nbsp;BUZEI.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;&nbsp;WHERE&nbsp;ZHZBH&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LW_OUT_TAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;INTO&nbsp;LW_OUT_TAB<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;&lt;FS&gt;-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;&lt;FS&gt;-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;&lt;FS&gt;-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUZEI&nbsp;=&nbsp;&lt;FS&gt;-BUZEI<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZHZBH&nbsp;=&nbsp;LW_OUT_TAB-ZHZBH.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ZHZBH&nbsp;=&nbsp;&lt;FS&gt;-BELNR.<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&显示<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_SHOW_ALV.<br />
&nbsp;&nbsp;FIELD-SYMBOLS:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS_TAB&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE.<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_FIELDCAT&nbsp;TYPE&nbsp;LVC_S_FCAT,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_FIELDCAT&nbsp;TYPE&nbsp;LVC_T_FCAT,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_LAYOUT&nbsp;&nbsp;&nbsp;TYPE&nbsp;LVC_S_LAYO.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;宏<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DEFINE&nbsp;DF_ADD_FIELDCAT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LW_FIELDCAT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_FIELDCAT-COL_POS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&1.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"列位置<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_FIELDCAT-FIELDNAME&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&2.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"要显示的字段<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_FIELDCAT-COLTEXT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&3.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"字段名<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_FIELDCAT-JUST&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&4.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"对齐方式<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_FIELDCAT-EDIT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&5.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"可编辑<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_FIELDCAT-REF_TABLE&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&6.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"引用表<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_FIELDCAT-REF_FIELD&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&7.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"引用字段<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;LW_FIELDCAT&nbsp;TO&nbsp;LT_FIELDCAT.<br />
&nbsp;&nbsp;END-OF-DEFINITION.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;数据转换（GT_IN_TAB=&gt;GT_OUT_TAB）<br />
*&nbsp;STEP1:创建FIELDCAT<br />
*&nbsp;固定部分<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DF_ADD_FIELDCAT:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;&nbsp;'ZGROUP'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT-001&nbsp;&nbsp;&nbsp;'L'&nbsp;''&nbsp;''&nbsp;&nbsp;''&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;&nbsp;'PRCTR'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT-002&nbsp;&nbsp;&nbsp;'L'&nbsp;''&nbsp;''&nbsp;&nbsp;''&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;&nbsp;'BELNR'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT-003&nbsp;&nbsp;&nbsp;'L'&nbsp;''&nbsp;''&nbsp;&nbsp;''&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;&nbsp;'BUZEI'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT-004&nbsp;&nbsp;&nbsp;'L'&nbsp;''&nbsp;''&nbsp;&nbsp;''&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;&nbsp;'GJAHR'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT-005&nbsp;&nbsp;&nbsp;'L'&nbsp;''&nbsp;''&nbsp;&nbsp;''&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6&nbsp;&nbsp;'MONAT'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT-006&nbsp;&nbsp;&nbsp;'L'&nbsp;''&nbsp;''&nbsp;&nbsp;''&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7&nbsp;&nbsp;'DRCRK'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT-007&nbsp;&nbsp;&nbsp;'L'&nbsp;''&nbsp;''&nbsp;&nbsp;''&nbsp;,<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7&nbsp;&nbsp;'DMBTR'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT-014&nbsp;&nbsp;&nbsp;'R'&nbsp;''&nbsp;''&nbsp;&nbsp;''&nbsp;,<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8&nbsp;&nbsp;'BUDAT'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT-008&nbsp;&nbsp;&nbsp;'L'&nbsp;''&nbsp;''&nbsp;&nbsp;''&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9&nbsp;&nbsp;'HKONT'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT-009&nbsp;&nbsp;&nbsp;'L'&nbsp;''&nbsp;''&nbsp;&nbsp;''&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10&nbsp;'BLART'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT-010&nbsp;&nbsp;&nbsp;'L'&nbsp;''&nbsp;''&nbsp;&nbsp;''&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;11&nbsp;'ZHZZ&nbsp;'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT-011&nbsp;&nbsp;&nbsp;'L'&nbsp;''&nbsp;''&nbsp;&nbsp;''&nbsp;,<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;11&nbsp;'ZHZBH'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT-013&nbsp;&nbsp;&nbsp;'L'&nbsp;''&nbsp;''&nbsp;&nbsp;''&nbsp;,<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12&nbsp;'DOC_NUMBER'&nbsp;TEXT-012&nbsp;&nbsp;&nbsp;'L'&nbsp;'X'&nbsp;''&nbsp;&nbsp;''&nbsp;.<br />
<br />
&nbsp;&nbsp;LW_LAYOUT-CWIDTH_OPT&nbsp;=&nbsp;ABAP_TRUE.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"优化列宽设置<br />
&nbsp;&nbsp;LW_LAYOUT-STYLEFNAME&nbsp;=&nbsp;'STYTLE'.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"设置样式<br />
&nbsp;&nbsp;LW_LAYOUT-BOX_FNAME&nbsp;&nbsp;=&nbsp;'SEL'.<br />
&nbsp;&nbsp;SORT&nbsp;GT_OUT_TAB&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;MONAT&nbsp;BUDAT&nbsp;ZHZBH&nbsp;BELNR&nbsp;BUZEI&nbsp;DRCRK.<br />
&nbsp;&nbsp;GT_ORI_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
   </div>
   <div class="codeComment">
*&nbsp;调用ALV<br />
   </div>
   <div class="code">
&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'REUSE_ALV_GRID_DISPLAY_LVC'<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I_CALLBACK_PROGRAM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;SY-REPID<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I_CALLBACK_PF_STATUS_SET&nbsp;=&nbsp;'FM_GUI_STATUS'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I_CALLBACK_USER_COMMAND&nbsp;&nbsp;=&nbsp;'FM_USER_COMMAND'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IS_LAYOUT_LVC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;LW_LAYOUT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IT_FIELDCAT_LVC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;LT_FIELDCAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;TABLES<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;T_OUTTAB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;GT_OUT_TAB<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROGRAM_ERROR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2.<br />
&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;E001(00)&nbsp;WITH&nbsp;'系统错误'&nbsp;SPACE&nbsp;SPACE&nbsp;SPACE.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&设置ALV的GUI状态<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_GUI_STATUS USING FU_EXTAB TYPE SLIS_T_EXTAB.<br />
&nbsp;&nbsp;SET&nbsp;PF-STATUS&nbsp;'STANDARD'.<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&设置用户命令<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_USER_COMMAND USING FU_UCOMM LIKE SY-UCOMM<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FU_SELFIELD&nbsp;TYPE&nbsp;SLIS_SELFIELD.<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_GRID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;REF&nbsp;TO&nbsp;CL_GUI_ALV_GRID.<br />
   </div>
   <div class="codeComment">
*&nbsp;刷新缺<br />
   </div>
   <div class="code">
&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'GET_GLOBALS_FROM_SLVC_FULLSCR'<br />
&nbsp;&nbsp;&nbsp;&nbsp;IMPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;E_GRID&nbsp;=&nbsp;L_GRID.<br />
&nbsp;&nbsp;CALL&nbsp;METHOD&nbsp;L_GRID-&gt;CHECK_CHANGED_DATA.<br />
&nbsp;&nbsp;CASE&nbsp;FU_UCOMM.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;'SAVE'.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;保存<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;FM_SAVE.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;更新GT_DOC<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;FM_GET_GT_DOC.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;'CAL'.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;分配归档编号<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;FM_CAL_DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;'DEL'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;FM_DEL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;'F03'&nbsp;OR&nbsp;'F15'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;FM_POP_UP_TO_CONFIRM&nbsp;USING&nbsp;FU_UCOMM.<br />
&nbsp;&nbsp;ENDCASE.<br />
<br />
&nbsp;&nbsp;SORT&nbsp;GT_OUT_TAB&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;MONAT&nbsp;BUDAT&nbsp;ZHZBH&nbsp;BELNR&nbsp;BUZEI&nbsp;DRCRK.<br />
&nbsp;&nbsp;FU_SELFIELD-REFRESH&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;FU_SELFIELD-ROW_STABLE&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;FU_SELFIELD-COL_STABLE&nbsp;=&nbsp;'X'.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&确认框<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_POP_UP_TO_CONFIRM USING FU_UCOMM.<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_ANSWER&nbsp;TYPE&nbsp;CHAR1.<br />
&nbsp;&nbsp;FU_UCOMM&nbsp;=&nbsp;'&'&nbsp;&&&nbsp;FU_UCOMM.<br />
&nbsp;&nbsp;IF&nbsp;GT_OUT_TAB&nbsp;&lt;&gt;&nbsp;GT_ORI_TAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'POPUP_TO_CONFIRM'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TITLEBAR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'确认'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT_QUESTION&nbsp;&nbsp;=&nbsp;'数据已更改,是否保存'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT_BUTTON_1&nbsp;&nbsp;=&nbsp;'是'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT_BUTTON_2&nbsp;&nbsp;=&nbsp;'否'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ANSWER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;L_ANSWER<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT_NOT_FOUND&nbsp;=&nbsp;1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CASE&nbsp;L_ANSWER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;'1'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;FM_SAVE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;'A'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FU_UCOMM&nbsp;=&nbsp;''.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDCASE.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&删除选中数据的归档编号<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_DEL.<br />
&nbsp;&nbsp;FIELD-SYMBOLS&nbsp;&lt;FS&gt;&nbsp;TYPE&nbsp;TY_OUT_TAB.<br />
   </div>
   <div class="codeComment">
*&nbsp;清空<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;&nbsp;WHERE&nbsp;SEL&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;&lt;FS&gt;-DOC_NUMBER.<br />
&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;E000(ZCB)&nbsp;WITH&nbsp;'请至少选中一条数据'.<br />
&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;S000(ZCB)&nbsp;WITH&nbsp;'已删除'.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&分配归档编号<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_CAL_DOC_NUMBER.<br />
&nbsp;&nbsp;FIELD-SYMBOLS&nbsp;&lt;FS&gt;&nbsp;TYPE&nbsp;TY_OUT_TAB.<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_NEW_GROUP&nbsp;&nbsp;TYPE&nbsp;CHAR1,&nbsp;"标识是否为新的账套<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_NEW_DOC&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;CHAR1,&nbsp;"标识是否为新的归档<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_DOC_NUMBER&nbsp;TYPE&nbsp;ZFIRP0121_DOC-DOC_NUMBER,<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_TABIX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;I,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_MAX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_MAX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_DOC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_DOC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIKE&nbsp;GT_DOC,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_OUT_TMP&nbsp;&nbsp;&nbsp;LIKE&nbsp;GT_OUT_TAB,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_MAX2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;TYT_OUT_TAB,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_MAX2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;TY_OUT_TAB,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_OUT_TAB&nbsp;&nbsp;&nbsp;TYPE&nbsp;TY_OUT_TAB,<br />
   </div>
   <div class="codeComment">
*************2016-05-26&nbsp;WANGYAN&nbsp;EDIT****************************************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;LA_OUT_TAB&nbsp;&nbsp;&nbsp;TYPE&nbsp;TY_OUT_TAB,<br />
   </div>
   <div class="codeComment">
****************************************************************************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;LW_PRE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;TY_OUT_TAB,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_TEMP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;TY_OUT_TAB,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_OUT_TAB&nbsp;&nbsp;&nbsp;TYPE&nbsp;TYT_OUT_TAB.<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_OUT_TAB1&nbsp;TYPE&nbsp;TYT_OUT_TAB.<br />
   </div>
   <div class="codeComment">
*************STEP1：数据准备***********************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LT_OUT_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB&nbsp;WHERE&nbsp;DOC_NUMBER&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
   </div>
   <div class="codeComment">
*&nbsp;确定数据库中当前的最大归档编号<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LT_MAX&nbsp;=&nbsp;GT_DOC.<br />
   </div>
   <div class="codeComment">
*****MODIFY&nbsp;BY&nbsp;LIQUAN&nbsp;&nbsp;2015.11.24&nbsp;START&nbsp;**********<br />
*&nbsp;BUG修正&nbsp;，删除已归档数据中和即将归档一致的数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_MAX_TMP&nbsp;&nbsp;LIKE&nbsp;LT_MAX.<br />
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR&nbsp;BUZEI.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_MAX&nbsp;INTO&nbsp;LW_MAX.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;LW_MAX-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;LW_MAX-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;LW_MAX-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUZEI&nbsp;=&nbsp;LW_MAX-BUZEI<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;找到了，表示该凭证行项目需要重新计算归档编号<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;LW_MAX&nbsp;TO&nbsp;LT_MAX_TMP.<br />
&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;LT_MAX&nbsp;=&nbsp;LT_MAX_TMP.<br />
   </div>
   <div class="codeComment">
*****MODIFY&nbsp;BY&nbsp;LIQUAN&nbsp;&nbsp;2015.11.24&nbsp;&nbsp;&nbsp;END&nbsp;**********<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SORT&nbsp;LT_MAX&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;DOC_NUMBER&nbsp;DESCENDING.<br />
&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;LT_MAX&nbsp;COMPARING&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT.<br />
   </div>
   <div class="codeComment">
*&nbsp;确定当前显示数据的最大编号<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LT_MAX2&nbsp;=&nbsp;GT_OUT_TAB.<br />
&nbsp;&nbsp;DELETE&nbsp;LT_MAX2&nbsp;WHERE&nbsp;DOC_NUMBER&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;SORT&nbsp;LT_MAX2&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;DOC_NUMBER&nbsp;DESCENDING.<br />
&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;LT_MAX2&nbsp;COMPARING&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT.<br />
<br />
&nbsp;&nbsp;LT_DOC&nbsp;=&nbsp;GT_DOC.<br />
&nbsp;&nbsp;DELETE&nbsp;LT_DOC&nbsp;WHERE&nbsp;DOC_NUMBER&nbsp;IS&nbsp;INITIAL.<br />
   </div>
   <div class="codeComment">
*****MODIFY&nbsp;BY&nbsp;LIQUAN&nbsp;&nbsp;2015.11.24&nbsp;START&nbsp;**********<br />
*&nbsp;BUG修正&nbsp;，删除已归档数据中和即将归档一致的数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;BUKRS&nbsp;BELNR&nbsp;GJAHR&nbsp;BUZEI.<br />
&nbsp;&nbsp;CLEAR&nbsp;LT_MAX_TMP.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_DOC&nbsp;INTO&nbsp;LW_DOC.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;LW_DOC-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;LW_DOC-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;LW_DOC-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUZEI&nbsp;=&nbsp;LW_DOC-BUZEI<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;找到了，表示该凭证行项目需要重新计算归档编号<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;LW_DOC&nbsp;TO&nbsp;LT_MAX_TMP.<br />
&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;LT_DOC&nbsp;=&nbsp;LT_MAX_TMP.<br />
   </div>
   <div class="codeComment">
*****MODIFY&nbsp;BY&nbsp;LIQUAN&nbsp;&nbsp;2015.11.24&nbsp;&nbsp;&nbsp;END&nbsp;**********<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SORT&nbsp;LT_DOC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;ZHZBH.<br />
<br />
&nbsp;&nbsp;LT_OUT_TMP&nbsp;&nbsp;=&nbsp;GT_OUT_TAB.<br />
&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TMP&nbsp;WHERE&nbsp;DOC_NUMBER&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TMP&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;ZHZBH&nbsp;BUDAT.<br />
   </div>
   <div class="codeComment">
*************STEP2：数据编辑***********************<br />
*&nbsp;按账套、会计年度、会计期间、虚拟汇总编号&nbsp;确定归档编号<br />
*******2016-04-18&nbsp;&nbsp;&nbsp;wangyan&nbsp;edit****************************<br />
*&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;BUDAT&nbsp;ZHZBH&nbsp;.<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;ZHZZ&nbsp;ZHZBH&nbsp;.<br />
<br />
&nbsp;&nbsp;LT_OUT_TAB1&nbsp;=&nbsp;LT_OUT_TAB.<br />
&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB&nbsp;&nbsp;&nbsp;WHERE&nbsp;ZHZZ&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB1&nbsp;&nbsp;WHERE&nbsp;ZHZZ&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;APPEND&nbsp;LINES&nbsp;OF&nbsp;&nbsp;LT_OUT_TAB1&nbsp;TO&nbsp;LT_OUT_TAB.<br />
<br />
   </div>
   <div class="codeComment">
*************2016.04.25&nbsp;王岩&nbsp;修改********************************************************************************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;FIELD-SYMBOLS:&nbsp;&lt;LW_OUT_TAB&gt;&nbsp;TYPE&nbsp;TY_OUT_TAB.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;LW_OUT_TAB&gt;.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;CASE&nbsp;'ZHZZ'.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;5.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;LW_OUT_TAB&gt;-ZHZZ&nbsp;=&nbsp;7.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;2.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;LW_OUT_TAB&gt;-ZHZZ&nbsp;=&nbsp;5.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDCASE.<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;LW_OUT_TAB&gt;-ZHZZ&nbsp;=&nbsp;5.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;LW_OUT_TAB&gt;-ZHZZ&nbsp;=&nbsp;7.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;LW_OUT_TAB&gt;-ZHZZ&nbsp;=&nbsp;2.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;LW_OUT_TAB&gt;-ZHZZ&nbsp;=&nbsp;5.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
****************************************************************************************************************<br />
****************2016-05-26&nbsp;WANGYAN&nbsp;将GT_OUT_TAB的汇总组改为正确的************************************************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;FIELD-SYMBOLS:&nbsp;&lt;LA_OUT_TAB&gt;&nbsp;TYPE&nbsp;TY_OUT_TAB.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;LA_OUT_TAB&gt;.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;LA_OUT_TAB&gt;-ZHZZ&nbsp;=&nbsp;5.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;LA_OUT_TAB&gt;-ZHZZ&nbsp;=&nbsp;7.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;LA_OUT_TAB&gt;-ZHZZ&nbsp;=&nbsp;2.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;LA_OUT_TAB&gt;-ZHZZ&nbsp;=&nbsp;5.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
****************************************************************************************************************<br />
<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_OUT_TAB&nbsp;INTO&nbsp;LW_OUT_TAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;L_TABIX&nbsp;=&nbsp;SY-TABIX.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;确定是否为新的账套、新的归档<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_NEW_GROUP,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_NEW_DOC.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;L_TABIX&nbsp;=&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_NEW_GROUP&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_NEW_DOC&nbsp;&nbsp;&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_TABIX&nbsp;=&nbsp;L_TABIX&nbsp;-&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;INTO&nbsp;LW_PRE<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INDEX&nbsp;L_TABIX.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LW_PRE-ZGROUP&nbsp;&lt;&gt;&nbsp;LW_OUT_TAB-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;LW_PRE-GJAHR&nbsp;&nbsp;&lt;&gt;&nbsp;LW_OUT_TAB-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;LW_PRE-ZMONAT&nbsp;&lt;&gt;&nbsp;LW_OUT_TAB-ZMONAT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_NEW_GROUP&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LW_PRE-ZGROUP&nbsp;&lt;&gt;&nbsp;LW_OUT_TAB-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;LW_PRE-GJAHR&nbsp;&nbsp;&lt;&gt;&nbsp;LW_OUT_TAB-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;LW_PRE-ZMONAT&nbsp;&lt;&gt;&nbsp;LW_OUT_TAB-ZMONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;LW_PRE-BUDAT&nbsp;&nbsp;&lt;&gt;&nbsp;LW_OUT_TAB-BUDAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;LW_PRE-ZHZBH&nbsp;&nbsp;&lt;&gt;&nbsp;LW_OUT_TAB-ZHZBH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_NEW_DOC&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;如果是新的账套，则获取当前账套的最大编号<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;L_NEW_GROUP&nbsp;=&nbsp;'X'.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;读数据库中最大编号<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LW_MAX.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_MAX&nbsp;INTO&nbsp;LW_MAX<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;ZGROUP&nbsp;=&nbsp;LW_OUT_TAB-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;&nbsp;=&nbsp;LW_OUT_TAB-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZMONAT&nbsp;=&nbsp;LW_OUT_TAB-ZMONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;读内存最大编号<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LW_MAX2.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_MAX2&nbsp;INTO&nbsp;LW_MAX2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;ZGROUP&nbsp;=&nbsp;LW_OUT_TAB-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;&nbsp;=&nbsp;LW_OUT_TAB-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZMONAT&nbsp;=&nbsp;LW_OUT_TAB-ZMONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;确定当前最大编号<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_DOC_NUMBER&nbsp;=&nbsp;LW_MAX-DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LW_MAX2-DOC_NUMBER&nbsp;&gt;&nbsp;L_DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_DOC_NUMBER&nbsp;=&nbsp;LW_MAX2-DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;如果是新的归档<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;L_NEW_DOC&nbsp;=&nbsp;'X'.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;查看内存中是否有同一归档的数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LW_TEMP.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TMP&nbsp;INTO&nbsp;LW_TEMP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;ZGROUP&nbsp;=&nbsp;LW_OUT_TAB-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;&nbsp;=&nbsp;LW_OUT_TAB-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZMONAT&nbsp;=&nbsp;LW_OUT_TAB-ZMONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZHZBH&nbsp;&nbsp;=&nbsp;LW_OUT_TAB-ZHZBH<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_DOC_NUMBER&nbsp;=&nbsp;LW_TEMP-DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;查看数据库中是否有同一归档<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LW_DOC.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_DOC&nbsp;INTO&nbsp;LW_DOC<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;ZGROUP&nbsp;=&nbsp;LW_OUT_TAB-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;&nbsp;=&nbsp;LW_OUT_TAB-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZMONAT&nbsp;=&nbsp;LW_OUT_TAB-ZMONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZHZBH&nbsp;&nbsp;=&nbsp;LW_OUT_TAB-ZHZBH<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_DOC_NUMBER&nbsp;=&nbsp;LW_DOC-DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L_DOC_NUMBER&nbsp;=&nbsp;L_DOC_NUMBER&nbsp;+&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_OUT_TAB-DOC_NUMBER&nbsp;=&nbsp;L_DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;LT_OUT_TAB&nbsp;FROM&nbsp;LW_OUT_TAB&nbsp;TRANSPORTING&nbsp;DOC_NUMBER.<br />
&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
*&nbsp;将归档编号更新至内表<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SORT&nbsp;LT_OUT_TAB&nbsp;BY&nbsp;BUKRS&nbsp;GJAHR&nbsp;BELNR&nbsp;BUZEI.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS&gt;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;LW_OUT_TAB.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_OUT_TAB&nbsp;INTO&nbsp;LW_OUT_TAB<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;BUKRS&nbsp;=&nbsp;&lt;FS&gt;-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;=&nbsp;&lt;FS&gt;-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BELNR&nbsp;=&nbsp;&lt;FS&gt;-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BUZEI&nbsp;=&nbsp;&lt;FS&gt;-BUZEI<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-DOC_NUMBER&nbsp;=&nbsp;LW_OUT_TAB-DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONDENSE&nbsp;&lt;FS&gt;-DOC_NUMBER&nbsp;NO-GAPS.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;MESSAGE&nbsp;S000(ZCB)&nbsp;WITH&nbsp;'已分配'.<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&保存<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_SAVE.<br />
&nbsp;&nbsp;FIELD-SYMBOLS&nbsp;&lt;FS&gt;&nbsp;TYPE&nbsp;ZFIRP0121_DOC.<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_OUT_TAB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;TYT_OUT_TAB,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_DELETE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_DELETEH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_HEAD&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_DELETEH_TMP&nbsp;TYPE&nbsp;ZFIRP0121_HEAD&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_DELETEH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_HEAD,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_INSERT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_INSERT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_DOC,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_INSERTH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_HEAD&nbsp;OCCURS&nbsp;0,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_INSERTH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ZFIRP0121_HEAD,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_INSERTH_TMP&nbsp;TYPE&nbsp;ZFIRP0121_HEAD&nbsp;OCCURS&nbsp;0.<br />
   </div>
   <div class="codeComment">
*&nbsp;确定删除数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LT_OUT_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
&nbsp;&nbsp;DELETE&nbsp;LT_OUT_TAB&nbsp;WHERE&nbsp;DOC_NUMBER&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;IF&nbsp;LT_OUT_TAB&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;ZFIRP0121_DOC<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;LT_DELETE<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;LT_OUT_TAB<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;BUKRS&nbsp;=&nbsp;LT_OUT_TAB-BUKRS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;BELNR&nbsp;=&nbsp;LT_OUT_TAB-BELNR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;BUZEI&nbsp;=&nbsp;LT_OUT_TAB-BUZEI<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;GJAHR&nbsp;=&nbsp;LT_OUT_TAB-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;MONAT&nbsp;=&nbsp;LT_OUT_TAB-MONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*&nbsp;确定新增数据、修改数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;MOVE-CORRESPONDING&nbsp;GT_OUT_TAB&nbsp;TO&nbsp;LT_INSERT.<br />
&nbsp;&nbsp;DELETE&nbsp;LT_INSERT&nbsp;WHERE&nbsp;DOC_NUMBER&nbsp;IS&nbsp;INITIAL.<br />
   </div>
   <div class="codeComment">
*&nbsp;更新数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DELETE&nbsp;ZFIRP0121_DOC&nbsp;FROM&nbsp;TABLE&nbsp;LT_DELETE.<br />
&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ROLLBACK&nbsp;WORK.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;E000(ZCB)&nbsp;WITH&nbsp;'更新失败，请重试'.<br />
&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*&nbsp;更新数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_INSERT&nbsp;ASSIGNING&nbsp;&lt;FS&gt;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;FS&gt;-ADNAM&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ADNAM&nbsp;=&nbsp;SY-UNAME.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ADDAT&nbsp;=&nbsp;SY-DATUM.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-ADTIM&nbsp;=&nbsp;SY-UZEIT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-UPNAM&nbsp;=&nbsp;SY-UNAME.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-UPDAT&nbsp;=&nbsp;SY-DATUM.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;FS&gt;-UPTIM&nbsp;=&nbsp;SY-UZEIT.<br />
&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;MODIFY&nbsp;ZFIRP0121_DOC&nbsp;FROM&nbsp;TABLE&nbsp;LT_INSERT.<br />
&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ROLLBACK&nbsp;WORK.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;E000(ZCB)&nbsp;WITH&nbsp;'更新失败，请重试'.<br />
&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
********************更新抬头表********************<br />
*&nbsp;只处理汇总组有的情况<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DELETE&nbsp;LT_INSERT&nbsp;WHERE&nbsp;ZHZZ&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;DELETE&nbsp;LT_DELETE&nbsp;WHERE&nbsp;ZHZZ&nbsp;IS&nbsp;INITIAL.<br />
<br />
&nbsp;&nbsp;IF&nbsp;LT_INSERT&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;LT_INSERT&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;LT_INSERT&nbsp;COMPARING&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;LT_INSERT&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;ZFIRP0121_HEAD<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;LT_INSERTH<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;LT_INSERT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ZGROUP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;LT_INSERT-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;GJAHR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;LT_INSERT-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ZMONAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;LT_INSERT-ZMONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;DOC_NUMBER&nbsp;=&nbsp;LT_INSERT-DOC_NUMBER<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;LT_INSERT&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_INSERT&nbsp;INTO&nbsp;LW_INSERT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_INSERTH&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;ZGROUP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;LW_INSERT-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;LW_INSERT-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZMONAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;LW_INSERT-ZMONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DOC_NUMBER&nbsp;=&nbsp;LW_INSERT-DOC_NUMBER<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MOVE-CORRESPONDING&nbsp;LW_INSERT&nbsp;TO&nbsp;LW_INSERTH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;LW_INSERTH&nbsp;TO&nbsp;LT_INSERTH_TMP.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;LINES&nbsp;OF&nbsp;LT_INSERTH_TMP&nbsp;TO&nbsp;LT_INSERTH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;ZFIRP0121_HEAD&nbsp;FROM&nbsp;TABLE&nbsp;LT_INSERTH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROLLBACK&nbsp;WORK.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;E000(ZCB)&nbsp;WITH&nbsp;'更新失败，请重试'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;IF&nbsp;LT_DELETE&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;LT_DELETE&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;LT_DELETE&nbsp;COMPARING&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MOVE-CORRESPONDING&nbsp;LT_DELETE&nbsp;TO&nbsp;LT_DELETEH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;LT_INSERTH&nbsp;BY&nbsp;ZGROUP&nbsp;GJAHR&nbsp;ZMONAT&nbsp;DOC_NUMBER.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;LT_DELETEH&nbsp;INTO&nbsp;LW_DELETEH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_INSERTH&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;ZGROUP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;LW_INSERT-ZGROUP<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GJAHR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;LW_INSERT-GJAHR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZMONAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;LW_INSERT-ZMONAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DOC_NUMBER&nbsp;=&nbsp;LW_INSERT-DOC_NUMBER<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;LW_DELETEH&nbsp;TO&nbsp;LT_DELETEH_TMP.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;ZFIRP0121_HEAD&nbsp;FROM&nbsp;TABLE&nbsp;LT_DELETEH_TMP.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROLLBACK&nbsp;WORK.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;E000(ZCB)&nbsp;WITH&nbsp;'更新失败，请重试'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
********************更新抬头表********************<br />
   </div>
   <div class="code">
&nbsp;&nbsp;COMMIT&nbsp;WORK&nbsp;AND&nbsp;WAIT.<br />
&nbsp;&nbsp;MESSAGE&nbsp;S000(ZCB)&nbsp;WITH&nbsp;'已保存'.<br />
&nbsp;&nbsp;GT_ORI_TAB&nbsp;=&nbsp;GT_OUT_TAB.<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&删除<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_DEL_SEL.<br />
<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&全选<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_ALL.<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_ENTRIES&nbsp;TYPE&nbsp;SLIS_T_FILTERED_ENTRIES,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_OUT_TAB&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;GT_OUT_TAB.<br />
&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'REUSE_ALV_GRID_LAYOUT_INFO_GET'<br />
&nbsp;&nbsp;&nbsp;&nbsp;IMPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ET_FILTERED_ENTRIES&nbsp;=&nbsp;LT_ENTRIES<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NO_INFOS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROGRAM_ERROR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3.<br />
&nbsp;&nbsp;SORT&nbsp;LT_ENTRIES.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;INTO&nbsp;LW_OUT_TAB.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;过滤掉的数据不做删选<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_ENTRIES&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;TABLE_LINE&nbsp;=&nbsp;SY-TABIX<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;可选的话<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LW_OUT_TAB-STYTLE[]&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;FIELDNAME&nbsp;=&nbsp;'SEL'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STYLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;CL_GUI_ALV_GRID=&gt;MC_STYLE_DISABLED<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LW_OUT_TAB-SEL&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;GT_OUT_TAB&nbsp;FROM&nbsp;LW_OUT_TAB&nbsp;TRANSPORTING&nbsp;SEL.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&全不选<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_DALL.<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;LT_ENTRIES&nbsp;TYPE&nbsp;SLIS_T_FILTERED_ENTRIES,<br />
&nbsp;&nbsp;&nbsp;&nbsp;LW_OUT_TAB&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;GT_OUT_TAB.<br />
&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'REUSE_ALV_GRID_LAYOUT_INFO_GET'<br />
&nbsp;&nbsp;&nbsp;&nbsp;IMPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ET_FILTERED_ENTRIES&nbsp;=&nbsp;LT_ENTRIES<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NO_INFOS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROGRAM_ERROR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3.<br />
&nbsp;&nbsp;SORT&nbsp;LT_ENTRIES.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;INTO&nbsp;LW_OUT_TAB.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;过滤掉的数据不做删选<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LT_ENTRIES&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;TABLE_LINE&nbsp;=&nbsp;SY-TABIX<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;可选的话<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;LW_OUT_TAB-STYTLE[]&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;FIELDNAME&nbsp;=&nbsp;'SEL'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STYLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;CL_GUI_ALV_GRID=&gt;MC_STYLE_DISABLED<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LW_OUT_TAB-SEL&nbsp;=&nbsp;''.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;GT_OUT_TAB&nbsp;FROM&nbsp;LW_OUT_TAB&nbsp;TRANSPORTING&nbsp;SEL.<br />
&nbsp;&nbsp;ENDLOOP.<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&设定是否可选<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FM_SET_VISIBLE.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;FIELD-SYMBOLS&nbsp;&lt;FS_OUT_TAB&gt;&nbsp;TYPE&nbsp;TY_OUT_TAB.<br />
*&nbsp;&nbsp;DATA:<br />
*&nbsp;&nbsp;&nbsp;&nbsp;LW_STYTLE&nbsp;&nbsp;TYPE&nbsp;LVC_S_STYL.<br />
*<br />
*&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_OUT_TAB&nbsp;ASSIGNING&nbsp;&lt;FS_OUT_TAB&gt;.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;&lt;FS_OUT_TAB&gt;-STYTLE.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;FS_OUT_TAB&gt;-SEL&nbsp;=&nbsp;'X'.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LW_STYTLE-FIELDNAME&nbsp;=&nbsp;'ZZCON'.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LW_STYTLE-STYLE&nbsp;=&nbsp;CL_GUI_ALV_GRID=&gt;MC_STYLE_DISABLED.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INSERT&nbsp;LW_STYTLE&nbsp;INTO&nbsp;TABLE&nbsp;&lt;FS_OUT_TAB&gt;-STYTLE.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LW_STYTLE-FIELDNAME&nbsp;=&nbsp;'ZZCON'.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LW_STYTLE-STYLE&nbsp;=&nbsp;CL_GUI_ALV_GRID=&gt;MC_STYLE_ENABLED.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INSERT&nbsp;LW_STYTLE&nbsp;INTO&nbsp;TABLE&nbsp;&lt;FS_OUT_TAB&gt;-STYTLE.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="code">
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*Text&nbsp;elements<br />
*----------------------------------------------------------<br />
*&nbsp;001&nbsp;利润中心组<br />
*&nbsp;002&nbsp;利润中心<br />
*&nbsp;003&nbsp;会计凭证号<br />
*&nbsp;004&nbsp;行项目号<br />
*&nbsp;005&nbsp;会计年度<br />
*&nbsp;006&nbsp;会计期间<br />
*&nbsp;007&nbsp;借贷标识<br />
*&nbsp;008&nbsp;过账日期<br />
*&nbsp;009&nbsp;科目<br />
*&nbsp;010&nbsp;凭证类型<br />
*&nbsp;011&nbsp;汇总组<br />
*&nbsp;012&nbsp;归档编号<br />
*&nbsp;013&nbsp;虚拟汇总编号<br />
*&nbsp;014&nbsp;金额<br />
*&nbsp;T01&nbsp;选择条件<br />
<br />
<br />
*Selection&nbsp;texts<br />
*----------------------------------------------------------<br />
*&nbsp;S_BUDAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;过账日期<br />
*&nbsp;S_DOCNUM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;归档号<br />
*&nbsp;S_SNAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;利润中心组<br />
<br />
<br />
*Messages<br />
*----------------------------------------------------------<br />
*<br />
*&nbsp;Message&nbsp;class:&nbsp;00<br />
*001&nbsp;&nbsp;&nbsp;&1&2&3&4&5&6&7&8<br />
*<br />
*&nbsp;Message&nbsp;class:&nbsp;ZCB<br />
*000&nbsp;&nbsp;&nbsp;&1&2&3&4<br />
            </div>
          </td>
        </tr>
      </table>
      </td>
      </tr>
   <tr>
<td class="footer">www.bjcaibai.com.cn201609</td>
   </tr>
</table>
</body>
</html>
