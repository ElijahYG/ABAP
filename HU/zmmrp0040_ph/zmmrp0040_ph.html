<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=GBK" />
<title>ZMMRP0040_PH</title>
<style type="text/css">
.code{ font-family:"Courier New", Courier, monospace; color:#000; font-size:14px; background-color:#F2F4F7 }
  .codeComment {font-family:"Courier New", Courier, monospace; color:#0000F0; font-size:14px; background-color:#F2F4F7 }
  .normalBold{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:12px; font-weight:800 }
  .normalBoldLarge{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:16px; font-weight:800 }
</style>
<style type="text/css">
  .normal{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:12px }
  .footer{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:12px; text-align: center }
  h2{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:16px; font-weight:800 }
  h3{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:14px; font-weight:800 }
  .outerTable{
   background-color:#E0E7ED;
   width:100%;
   border-top-width: thin;
   border-right-width: thin;
   border-right-width: thin;
   border-left-width: thin;
   border-top-style: solid;
   border-right-style: solid;
   border-bottom-style: solid;
   border-left-style: solid;
  }
  .innerTable{
   background-color:#F2F4F7;
   width:100%;
   border-top-width: thin;
   border-right-width: thin;
   border-bottom-width: thin;
   border-left-width: thin;
   border-top-style: solid;
   border-right-style: solid;
   border-bottom-style: solid;
   border-left-style: solid;
  }
</style>
</head>
<body>
<table class="outerTable">
  <tr class="normalBoldLarge">
     <td><h2>Code listing for: ZMMRP0040_PH</h2>
<h3> Description: 配货规则-要货单配货</h3></td>
   </tr>
  <tr>
     <td>
     <table class="innerTable">
       <tr>
          <td>
   <div class="code">
REPORT zmmrp0040_ph.<br />
<br />
TYPE-POOLS: slis, vrm.<br />
   </div>
   <div class="codeComment">
************************************************************************<br />
*&nbsp;Types<br />
************************************************************************<br />
   </div>
   <div class="code">
TYPES: BEGIN OF ty_yh,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doc_number&nbsp;TYPE&nbsp;zsdif0050_item-doc_number,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item_no&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_item-item_no,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_head-werks,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;extwg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_head-extwg,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orderid&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zmmdeli_config-orderid,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zrate&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zmmdeli_config-zrate,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;matnr,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ex_xnkh&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_item-ex_xnkh,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menge&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_item-menge,&nbsp;&nbsp;"需求数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menge_n&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_item-menge,&nbsp;&nbsp;"未满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menge_y&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_item-menge,&nbsp;&nbsp;"本款满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menge_t&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_item-menge,&nbsp;&nbsp;"推荐款满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;ty_yh,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN&nbsp;OF&nbsp;ty_store,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matnr&nbsp;&nbsp;&nbsp;TYPE&nbsp;matnr,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ex_xnkh&nbsp;TYPE&nbsp;zsdif0050_item-ex_xnkh,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;&nbsp;&nbsp;TYPE&nbsp;werks,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lgort&nbsp;&nbsp;&nbsp;TYPE&nbsp;lgort_d,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;char13,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clabs&nbsp;&nbsp;&nbsp;TYPE&nbsp;mchb-clabs,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;库存件数<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menge&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_item-menge,&nbsp;"&nbsp;要货件数<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zrate&nbsp;&nbsp;&nbsp;TYPE&nbsp;zmmdeli_config-zrate,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;ty_store,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN&nbsp;OF&nbsp;ty_tjk,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matnr&nbsp;&nbsp;&nbsp;TYPE&nbsp;matnr,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ex_xnkh&nbsp;TYPE&nbsp;zsdif0050_item-ex_xnkh,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;ty_tjk.<br />
<br />
   </div>
   <div class="codeComment">
************************************************************************<br />
*&nbsp;Tables<br />
************************************************************************<br />
   </div>
   <div class="code">
DATA: gt_lgort TYPE STANDARD TABLE OF zmm_delevlgort,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_lgort&nbsp;TYPE&nbsp;zmm_delevlgort,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_t001w&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;t001w,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_t001w&nbsp;TYPE&nbsp;t001w,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_rule&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zmmdeli_config,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_rule&nbsp;&nbsp;TYPE&nbsp;zmmdeli_config,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_yh&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;ty_yh,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ty_yh,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_store&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;ty_store,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store&nbsp;TYPE&nbsp;ty_store,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_tjk&nbsp;&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;ty_tjk,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_ph&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zmm_delevresult,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zmm_delevresult.<br />
<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;定义ALV显示字段属性内表和工作区<br />
   </div>
   <div class="code">
DATA: gt_fieldcat TYPE slis_t_fieldcat_alv,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_fieldcat&nbsp;TYPE&nbsp;slis_fieldcat_alv,<br />
   </div>
   <div class="codeComment">
*&nbsp;定义ALV屏幕布局工作区<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_layout&nbsp;TYPE&nbsp;slis_layout_alv,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_events&nbsp;&nbsp;&nbsp;TYPE&nbsp;slis_t_event,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_events&nbsp;&nbsp;&nbsp;TYPE&nbsp;slis_alv_event.<br />
DATA: gr_grid TYPE REF TO cl_gui_alv_grid.<br />
DATA:<br />
&nbsp;&nbsp;g_flg&nbsp;TYPE&nbsp;char1,<br />
&nbsp;&nbsp;g_datum&nbsp;TYPE&nbsp;sy-datum,<br />
&nbsp;&nbsp;g_uzeit&nbsp;TYPE&nbsp;sy-uzeit.<br />
<br />
   </div>
   <div class="codeComment">
************************************************************************<br />
*&nbsp;Parameters<br />
************************************************************************<br />
   </div>
   <div class="code">
PARAMETERS p_werks TYPE werks_d OBLIGATORY.<br />
<br />
<br />
   </div>
   <div class="codeComment">
************************************************************************<br />
*&nbsp;Start&nbsp;of&nbsp;Selection<br />
************************************************************************<br />
   </div>
   <div class="code">
START-OF-SELECTION.<br />
   </div>
   <div class="codeComment">
*&nbsp;取得数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_get_data.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_GET_DATA<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_get_data .<br />
&nbsp;&nbsp;CLEAR&nbsp;g_flg.<br />
   </div>
   <div class="codeComment">
*&nbsp;开始时间<br />
   </div>
   <div class="code">
&nbsp;&nbsp;g_datum&nbsp;=&nbsp;sy-datum.<br />
&nbsp;&nbsp;g_uzeit&nbsp;=&nbsp;sy-uzeit.<br />
   </div>
   <div class="codeComment">
*&nbsp;锁定地点<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_lock_werks.<br />
   </div>
   <div class="codeComment">
*&nbsp;取得配货地点<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_get_logrt.<br />
   </div>
   <div class="codeComment">
*&nbsp;取得门店<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_get_werks.<br />
   </div>
   <div class="codeComment">
*&nbsp;取得门店配货规则<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_get_rule.<br />
   </div>
   <div class="codeComment">
*&nbsp;获取要处理的门店要货清单<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_get_list.<br />
   </div>
   <div class="codeComment">
*&nbsp;整理要货库存表<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_sort_store.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;PERFORM&nbsp;frm_sort_store_new&nbsp;.<br />
*&nbsp;配货<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_ph.<br />
   </div>
   <div class="codeComment">
*&nbsp;推荐款匹配<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_tjk.<br />
   </div>
   <div class="codeComment">
*&nbsp;添加没有配货的单据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_add_ph.<br />
   </div>
   <div class="codeComment">
*&nbsp;更新配货结果<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_update_result.<br />
   </div>
   <div class="codeComment">
*&nbsp;解锁地点<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_unlock_werks.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_LOCK_WERKS<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_lock_werks .<br />
&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'ENQUEUE_EZMMRP0040_WERK'<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MODE_ZMMRP0040_LOCK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'S'<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MANDT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;SY-MANDT<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;p_werks<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;X_WERKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'&nbsp;'<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_SCOPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'2'<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_WAIT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'&nbsp;'<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_COLLECT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'&nbsp;'<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreign_lock&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;system_failure&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3.<br />
&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;ID&nbsp;sy-msgid<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;'S'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NUMBER&nbsp;sy-msgno<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;sy-msgv1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sy-msgv2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sy-msgv3<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sy-msgv4<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;g_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_GET_LOGRT<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_get_logrt.<br />
<br />
&nbsp;&nbsp;IF&nbsp;g_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;REFRESH&nbsp;gt_lgort.<br />
&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;gt_lgort<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmm_delevlgort<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;werks&nbsp;=&nbsp;p_werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;kcdflg&nbsp;=&nbsp;'01'.<br />
&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;'该发货地点在表ZMM_DELEVLGORT中没有配置!'&nbsp;TYPE&nbsp;'S'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;g_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&nbsp;Copy&nbsp;from&nbsp;old&nbsp;verion&nbsp;by&nbsp;huxiaowei&nbsp;@20150921<br />
   </div>
   <div class="code">
FORM frm_get_logrt_old_20150921.<br />
<br />
&nbsp;&nbsp;IF&nbsp;g_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;REFRESH&nbsp;gt_lgort.<br />
&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;gt_lgort<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmm_delevlgort<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;werks&nbsp;=&nbsp;p_werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;kcdflg&nbsp;=&nbsp;'01'.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_GET_WERKS<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_get_werks .<br />
<br />
&nbsp;&nbsp;IF&nbsp;g_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;REFRESH&nbsp;gt_t001w.<br />
&nbsp;&nbsp;SELECT&nbsp;t001w~werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;CORRESPONDING&nbsp;FIELDS&nbsp;OF&nbsp;TABLE&nbsp;gt_t001w<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;t001w&nbsp;INNER&nbsp;JOIN&nbsp;wrf3<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;t001w~kunnr&nbsp;=&nbsp;wrf3~locnr<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;wrf3~loclb&nbsp;=&nbsp;p_werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;wrf3~datbi&nbsp;&gt;=&nbsp;sy-datum<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;wrf3~datab&nbsp;&lt;=&nbsp;sy-datum.<br />
&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;'该发货地点没有对应的门店!'&nbsp;TYPE&nbsp;'S'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;g_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_GET_RULE<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_get_rule .<br />
&nbsp;&nbsp;IF&nbsp;g_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;gt_rule<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmdeli_config<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;gt_t001w<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;werks&nbsp;=&nbsp;gt_t001w-werks.<br />
&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;'该发货地点没有对应的门店配货规则!'&nbsp;TYPE&nbsp;'S'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;g_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_GET_LIST<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_get_list.<br />
&nbsp;&nbsp;IF&nbsp;g_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_head&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zsdif0050_head,<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_head&nbsp;TYPE&nbsp;zsdif0050_head,<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_item&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zsdif0050_item,<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_item&nbsp;TYPE&nbsp;zsdif0050_item.<br />
<br />
&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;lt_head<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zsdif0050_head<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;gt_t001w<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;werks&nbsp;&nbsp;&nbsp;=&nbsp;gt_t001w-werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ord_typ&nbsp;=&nbsp;'LX01'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;act_typ&nbsp;=&nbsp;'PH01'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;doc_ind&nbsp;=&nbsp;'0'.<br />
&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;'没有需要处理的门店要货单!'&nbsp;TYPE&nbsp;'S'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;g_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;lt_item<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zsdif0050_item<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;lt_head<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;doc_number&nbsp;=&nbsp;lt_head-doc_number.<br />
<br />
&nbsp;&nbsp;REFRESH&nbsp;gt_yh.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_item&nbsp;INTO&nbsp;ls_item.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_head.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;lt_head&nbsp;INTO&nbsp;ls_head<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;doc_number&nbsp;=&nbsp;ls_item-doc_number.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;gs_yh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-doc_number&nbsp;=&nbsp;ls_head-doc_number.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-item_no&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_item-item_no.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_head-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;SINGLE&nbsp;extwg<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;gs_yh-extwg<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;mara<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;matnr&nbsp;=&nbsp;ls_item-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;gt_rule&nbsp;INTO&nbsp;gs_rule<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;extwg&nbsp;=&nbsp;gs_yh-extwg<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;=&nbsp;gs_yh-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-orderid&nbsp;=&nbsp;gs_rule-orderid.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-zrate&nbsp;&nbsp;&nbsp;=&nbsp;gs_rule-zrate.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-orderid&nbsp;=&nbsp;'9999'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-zrate&nbsp;&nbsp;&nbsp;=&nbsp;'1'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-matnr&nbsp;=&nbsp;ls_item-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-ex_xnkh&nbsp;=&nbsp;ls_item-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-menge&nbsp;=&nbsp;gs_yh-menge_n&nbsp;=&nbsp;ls_item-menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_yh&nbsp;TO&nbsp;gt_yh.<br />
<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;SORT&nbsp;gt_yh&nbsp;BY&nbsp;ex_xnkh&nbsp;extwg&nbsp;orderid.<br />
&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;'没有需要处理的门店要货单!'&nbsp;TYPE&nbsp;'S'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;g_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
ENDFORM.<br />
<br />
FORM frm_sort_store .<br />
&nbsp;&nbsp;IF&nbsp;g_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_batch&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zmmrp0210_batch,<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_batch&nbsp;TYPE&nbsp;zmmrp0210_batch,<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_attr&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;/spe/batch_and_values,<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_attr&nbsp;&nbsp;TYPE&nbsp;/spe/batch_and_values,<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_lgort&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zmm_delevlgort,<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_mchb&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;mchb,<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_store&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;ty_store,<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_mchb&nbsp;&nbsp;TYPE&nbsp;mchb,<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_mara&nbsp;&nbsp;TYPE&nbsp;mara,<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_count&nbsp;&nbsp;TYPE&nbsp;i,<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_flg&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;char1,<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_menge&nbsp;&nbsp;TYPE&nbsp;menge_d,<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_message&nbsp;TYPE&nbsp;char255.<br />
<br />
&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;lt_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmrp0210_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;gt_yh<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;matnr&nbsp;&nbsp;&nbsp;=&nbsp;gt_yh-matnr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ex_xnkh&nbsp;=&nbsp;gt_yh-ex_xnkh.<br />
<br />
&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;'商品批次附加信息表没有数据!'&nbsp;TYPE&nbsp;'S'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;g_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;REFRESH:<br />
&nbsp;&nbsp;&nbsp;&nbsp;gt_store,<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_store.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_batch&nbsp;INTO&nbsp;ls_batch.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;批次特性<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;REFRESH&nbsp;lt_attr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'/SPE/READ_CLASSIFICATION_DATA'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_charg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-charg<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-matnr<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-werks<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TABLES<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e_values&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lt_attr<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_attr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lt_attr<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;E_BATCHES&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;no_classification&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;no_classtypes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nothing_found&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plant_missing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;4<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plant_unknown&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;5<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;some_attribs_missing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;6<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_attr_is_empty&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;7<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;8.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_attr&nbsp;INTO&nbsp;ls_attr&nbsp;WHERE&nbsp;(&nbsp;atnam&nbsp;=&nbsp;'抽屉1'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;atwrt&nbsp;&lt;&gt;&nbsp;''<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;atwrt&nbsp;&lt;&gt;&nbsp;'?'&nbsp;)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;(&nbsp;atnam&nbsp;=&nbsp;'抽屉2'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;atwrt&nbsp;&lt;&gt;&nbsp;''<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;atwrt&nbsp;&lt;&gt;&nbsp;'?').<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;SINGLE&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;ls_mara<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;mara<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;matnr&nbsp;=&nbsp;ls_batch-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;取得库存<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;REFRESH&nbsp;lt_lgort.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_lgort&nbsp;INTO&nbsp;gs_lgort&nbsp;WHERE&nbsp;extwg&nbsp;=&nbsp;ls_mara-extwg.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_lgort&nbsp;TO&nbsp;lt_lgort.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;REFRESH&nbsp;lt_mchb.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;lt_mchb<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;mchb<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;lt_lgort<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;matnr&nbsp;=&nbsp;ls_batch-matnr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;werks&nbsp;=&nbsp;lt_lgort-werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;lgort&nbsp;=&nbsp;lt_lgort-lgort<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;charg&nbsp;=&nbsp;ls_batch-charg.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_mchb&nbsp;INTO&nbsp;ls_mchb.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;gs_store.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-matnr&nbsp;&nbsp;&nbsp;=&nbsp;ls_mchb-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-ex_xnkh&nbsp;=&nbsp;ls_batch-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-werks&nbsp;&nbsp;&nbsp;=&nbsp;ls_mchb-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-lgort&nbsp;&nbsp;&nbsp;=&nbsp;ls_mchb-lgort.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;ls_mara-meins&nbsp;=&nbsp;'ST'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-clabs&nbsp;=&nbsp;ls_mchb-clabs.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;ls_mara-tempb&nbsp;=&nbsp;'01'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;ls_mchb-clabs&nbsp;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-clabs&nbsp;=&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSEIF&nbsp;ls_mara-tempb&nbsp;=&nbsp;'02'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;ls_mara-tempb&nbsp;=&nbsp;'03'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;lt_attr&nbsp;INTO&nbsp;ls_attr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;atnam&nbsp;=&nbsp;'金重'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;ls_attr-atwrt&nbsp;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-clabs&nbsp;=&nbsp;ls_mchb-clabs&nbsp;/&nbsp;ls_attr-atwrt.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-clabs&nbsp;=&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COLLECT&nbsp;gs_store&nbsp;INTO&nbsp;lt_store.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;汇总<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DELETE&nbsp;lt_store&nbsp;WHERE&nbsp;clabs&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;SORT&nbsp;lt_store&nbsp;BY&nbsp;matnr&nbsp;ex_xnkh&nbsp;clabs&nbsp;DESCENDING&nbsp;werks&nbsp;lgort.<br />
&nbsp;&nbsp;l_count&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_store&nbsp;INTO&nbsp;gs_store.<br />
&nbsp;&nbsp;&nbsp;&nbsp;AT&nbsp;NEW&nbsp;ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_count&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDAT.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_count&nbsp;=&nbsp;l_count&nbsp;+&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_flg&nbsp;=&nbsp;''.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;l_count&nbsp;&gt;&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;AT&nbsp;END&nbsp;OF&nbsp;ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;l_count&nbsp;&gt;&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDAT.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;l_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;l_message.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONCATENATE&nbsp;'商品'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-matnr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'虚拟款号'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-ex_xnkh<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'在多个库存地点有库存!'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;l_message.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;s001(00)&nbsp;WITH&nbsp;l_message.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;TABLE&nbsp;lt_store&nbsp;FROM&nbsp;gs_store.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
*&nbsp;编辑数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_store&nbsp;INTO&nbsp;gs_store.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;l_menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_yh&nbsp;INTO&nbsp;gs_yh&nbsp;WHERE&nbsp;matnr&nbsp;=&nbsp;gs_store-matnr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ex_xnkh&nbsp;=&nbsp;gs_store-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_menge&nbsp;=&nbsp;l_menge&nbsp;+&nbsp;gs_yh-menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;l_menge&nbsp;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-zrate&nbsp;=&nbsp;(&nbsp;gs_store-clabs&nbsp;/&nbsp;l_menge&nbsp;)&nbsp;*&nbsp;100.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_store-menge&nbsp;=&nbsp;gs_store-clabs.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;抽屉号<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;lt_batch&nbsp;INTO&nbsp;ls_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;matnr&nbsp;=&nbsp;gs_store-matnr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ex_xnkh&nbsp;=&nbsp;gs_store-ex_xnkh.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;REFRESH&nbsp;lt_attr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'/SPE/READ_CLASSIFICATION_DATA'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_charg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-charg<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-matnr<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-werks<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TABLES<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e_values&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lt_attr<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_attr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lt_attr<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;E_BATCHES&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;no_classification&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;no_classtypes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nothing_found&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plant_missing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;4<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plant_unknown&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;5<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;some_attribs_missing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;6<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_attr_is_empty&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;7<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;8.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;lt_attr&nbsp;INTO&nbsp;ls_attr&nbsp;WITH&nbsp;KEY&nbsp;atnam&nbsp;=&nbsp;'抽屉1'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-cth&nbsp;=&nbsp;ls_attr-atwrt.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;gs_store-cth&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;lt_attr&nbsp;INTO&nbsp;ls_attr&nbsp;WITH&nbsp;KEY&nbsp;atnam&nbsp;=&nbsp;'抽屉2'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-cth&nbsp;=&nbsp;ls_attr-atwrt.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_store&nbsp;TO&nbsp;gt_store.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_PH<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_ph .<br />
&nbsp;&nbsp;IF&nbsp;g_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;IF&nbsp;gt_store[]&nbsp;IS&nbsp;INITIAL&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_tabix&nbsp;TYPE&nbsp;sy-tabix,<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_menge&nbsp;TYPE&nbsp;menge_d,<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_char&nbsp;&nbsp;TYPE&nbsp;char20,<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_char1&nbsp;TYPE&nbsp;char20,<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_char2&nbsp;TYPE&nbsp;char20.<br />
<br />
&nbsp;&nbsp;REFRESH&nbsp;gt_ph.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_yh&nbsp;INTO&nbsp;gs_yh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;gt_store&nbsp;INTO&nbsp;gs_store<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;matnr&nbsp;=&nbsp;gs_yh-matnr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ex_xnkh&nbsp;=&nbsp;gs_yh-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_tabix&nbsp;=&nbsp;sy-tabix.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;gs_store-zrate&nbsp;&gt;=&nbsp;100.<br />
   </div>
   <div class="codeComment">
*&nbsp;库存需求比大于100%<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;gs_ph.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-doc_number&nbsp;=&nbsp;gs_yh-doc_number.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-item_no&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-item_no.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phlx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh_ph&nbsp;=&nbsp;gs_yh-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-xqsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-lgort_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-lgort.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-cth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-cth.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-datum_ph&nbsp;&nbsp;&nbsp;=&nbsp;g_datum.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-time_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;g_uzeit.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-name_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;sy-uname.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_ph&nbsp;TO&nbsp;gt_ph.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-menge&nbsp;=&nbsp;gs_store-menge&nbsp;-&nbsp;gs_yh-menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;gt_store&nbsp;FROM&nbsp;gs_store&nbsp;INDEX&nbsp;l_tabix&nbsp;TRANSPORTING&nbsp;menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-menge_n&nbsp;=&nbsp;0.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;未满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-menge_y&nbsp;=&nbsp;gs_yh-menge.&nbsp;&nbsp;"&nbsp;本款满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-menge_t&nbsp;=&nbsp;0.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;推荐款满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;gt_yh&nbsp;FROM&nbsp;gs_yh&nbsp;TRANSPORTING&nbsp;menge_n&nbsp;menge_y&nbsp;menge_t.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
   </div>
   <div class="codeComment">
*&nbsp;库存需求比小于100%<br />
*&nbsp;首轮配货<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;gs_store-zrate&nbsp;&lt;&nbsp;gs_yh-zrate.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;gs_store-menge&nbsp;&lt;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;gs_ph.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-doc_number&nbsp;=&nbsp;gs_yh-doc_number.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-item_no&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-item_no.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phlx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh_ph&nbsp;=&nbsp;gs_yh-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-xqsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR:<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_char,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_char1,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_char2.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_char&nbsp;=&nbsp;gs_yh-menge&nbsp;*&nbsp;(&nbsp;gs_store-zrate&nbsp;-&nbsp;gs_yh-zrate&nbsp;)&nbsp;/&nbsp;100.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SPLIT&nbsp;l_char<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AT&nbsp;'.'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;l_char1&nbsp;l_char2.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;库存不足<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;gs_store-menge&nbsp;&lt;&nbsp;l_char1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_char1&nbsp;=&nbsp;gs_store-menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;l_char1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-lgort_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-lgort.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-cth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-cth.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-datum_ph&nbsp;&nbsp;&nbsp;=&nbsp;g_datum.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-time_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;g_uzeit.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-name_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;sy-uname.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_ph&nbsp;TO&nbsp;gt_ph.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-menge&nbsp;=&nbsp;gs_store-menge&nbsp;-&nbsp;l_char1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;gt_store&nbsp;FROM&nbsp;gs_store&nbsp;INDEX&nbsp;l_tabix&nbsp;TRANSPORTING&nbsp;menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-menge_n&nbsp;=&nbsp;gs_yh-menge&nbsp;-&nbsp;l_char1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-menge_y&nbsp;=&nbsp;l_char1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-menge_t&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;gt_yh&nbsp;FROM&nbsp;gs_yh&nbsp;TRANSPORTING&nbsp;menge_n&nbsp;menge_y&nbsp;menge_t.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;第二轮配货<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_yh&nbsp;INTO&nbsp;gs_yh&nbsp;WHERE&nbsp;menge_n&nbsp;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;gt_store&nbsp;INTO&nbsp;gs_store<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;matnr&nbsp;=&nbsp;gs_yh-matnr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ex_xnkh&nbsp;=&nbsp;gs_yh-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0<br />
&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;gs_store-menge&nbsp;&lt;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_tabix&nbsp;=&nbsp;sy-tabix.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_ph&nbsp;INTO&nbsp;gs_ph&nbsp;WHERE&nbsp;doc_number&nbsp;=&nbsp;gs_yh-doc_number<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;item_no&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-item_no<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-matnr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ex_xnkh&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-ex_xnkh<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;matnr_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-matnr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ex_xnkh_ph&nbsp;=&nbsp;gs_yh-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;gs_store-menge&nbsp;&gt;=&nbsp;gs_yh-menge_n.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phsl&nbsp;=&nbsp;gs_ph-phsl&nbsp;+&nbsp;gs_yh-menge_n.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_char&nbsp;=&nbsp;gs_yh-menge_n.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;gt_ph&nbsp;FROM&nbsp;gs_ph&nbsp;TRANSPORTING&nbsp;phsl.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-menge&nbsp;=&nbsp;gs_store-menge&nbsp;-&nbsp;gs_yh-menge_n.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;gt_store&nbsp;FROM&nbsp;gs_store&nbsp;INDEX&nbsp;l_tabix&nbsp;TRANSPORTING&nbsp;menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phsl&nbsp;=&nbsp;gs_ph-phsl&nbsp;+&nbsp;gs_store-menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_char&nbsp;=&nbsp;gs_store-menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;gt_ph&nbsp;FROM&nbsp;gs_ph&nbsp;TRANSPORTING&nbsp;phsl.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-menge&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;gt_store&nbsp;FROM&nbsp;gs_store&nbsp;INDEX&nbsp;l_tabix&nbsp;TRANSPORTING&nbsp;menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;gs_ph.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-doc_number&nbsp;=&nbsp;gs_yh-doc_number.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-item_no&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-item_no.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phlx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh_ph&nbsp;=&nbsp;gs_yh-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-xqsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;l_char.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;gs_store-menge&nbsp;&lt;=&nbsp;gs_yh-menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_char&nbsp;=&nbsp;gs_store-menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_char&nbsp;=&nbsp;gs_yh-menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;l_char.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-lgort_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-lgort.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-cth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-cth.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-datum_ph&nbsp;&nbsp;&nbsp;=&nbsp;g_datum.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-time_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;g_uzeit.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-name_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;sy-uname.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_ph&nbsp;TO&nbsp;gt_ph.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-menge&nbsp;=&nbsp;gs_store-menge&nbsp;-&nbsp;l_char.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;gt_store&nbsp;FROM&nbsp;gs_store&nbsp;INDEX&nbsp;l_tabix&nbsp;TRANSPORTING&nbsp;menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-menge_n&nbsp;=&nbsp;gs_yh-menge_n&nbsp;-&nbsp;l_char.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-menge_y&nbsp;=&nbsp;gs_yh-menge_y&nbsp;+&nbsp;l_char.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-menge_t&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;gt_yh&nbsp;FROM&nbsp;gs_yh&nbsp;TRANSPORTING&nbsp;menge_n&nbsp;menge_y&nbsp;menge_t.<br />
&nbsp;&nbsp;ENDLOOP.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_TJK<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_tjk .<br />
&nbsp;&nbsp;IF&nbsp;g_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_data&nbsp;TYPE&nbsp;zmmrp0040_tjk,<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_batch&nbsp;TYPE&nbsp;zmmrp0210_batch,<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_tjk&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;ty_tjk,<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk&nbsp;TYPE&nbsp;ty_tjk.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;补充推荐款数据的库存<br />
   </div>
   <div class="code">
&nbsp;&nbsp;REFRESH&nbsp;lt_tjk.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_yh&nbsp;INTO&nbsp;gs_yh&nbsp;WHERE&nbsp;menge_n&nbsp;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_data.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;SINGLE&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;ls_data<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmrp0040_tjk<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;zyks&nbsp;=&nbsp;gs_yh-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_batch.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;ls_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UP&nbsp;TO&nbsp;1&nbsp;ROWS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmrp0210_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ex_xnkh&nbsp;=&nbsp;ls_data-ztj1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDSELECT.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_tjk.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-matnr&nbsp;=&nbsp;ls_batch-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-ex_xnkh&nbsp;=&nbsp;ls_data-ztj1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;ls_tjk&nbsp;TO&nbsp;lt_tjk.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_batch.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;ls_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UP&nbsp;TO&nbsp;1&nbsp;ROWS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmrp0210_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ex_xnkh&nbsp;=&nbsp;ls_data-ztj2.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDSELECT.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_tjk.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-matnr&nbsp;=&nbsp;ls_batch-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-ex_xnkh&nbsp;=&nbsp;ls_data-ztj2.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;ls_tjk&nbsp;TO&nbsp;lt_tjk.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_batch.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;ls_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UP&nbsp;TO&nbsp;1&nbsp;ROWS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmrp0210_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ex_xnkh&nbsp;=&nbsp;ls_data-ztj3.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDSELECT.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_tjk.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-matnr&nbsp;=&nbsp;ls_batch-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-ex_xnkh&nbsp;=&nbsp;ls_data-ztj3.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;ls_tjk&nbsp;TO&nbsp;lt_tjk.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_batch.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;ls_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UP&nbsp;TO&nbsp;1&nbsp;ROWS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmrp0210_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ex_xnkh&nbsp;=&nbsp;ls_data-ztj4.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDSELECT.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_tjk.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-matnr&nbsp;=&nbsp;ls_batch-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-ex_xnkh&nbsp;=&nbsp;ls_data-ztj4.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;ls_tjk&nbsp;TO&nbsp;lt_tjk.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_batch.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;ls_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UP&nbsp;TO&nbsp;1&nbsp;ROWS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmrp0210_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ex_xnkh&nbsp;=&nbsp;ls_data-ztj5.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDSELECT.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_tjk.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-matnr&nbsp;=&nbsp;ls_batch-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-ex_xnkh&nbsp;=&nbsp;ls_data-ztj5.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;ls_tjk&nbsp;TO&nbsp;lt_tjk.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_batch.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;ls_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UP&nbsp;TO&nbsp;1&nbsp;ROWS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmrp0210_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ex_xnkh&nbsp;=&nbsp;ls_data-ztj6.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDSELECT.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_tjk.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-matnr&nbsp;=&nbsp;ls_batch-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-ex_xnkh&nbsp;=&nbsp;ls_data-ztj6.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;ls_tjk&nbsp;TO&nbsp;lt_tjk.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_batch.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;ls_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UP&nbsp;TO&nbsp;1&nbsp;ROWS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmrp0210_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ex_xnkh&nbsp;=&nbsp;ls_data-ztj7.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDSELECT.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_tjk.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-matnr&nbsp;=&nbsp;ls_batch-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-ex_xnkh&nbsp;=&nbsp;ls_data-ztj7.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;ls_tjk&nbsp;TO&nbsp;lt_tjk.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_batch.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;ls_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UP&nbsp;TO&nbsp;1&nbsp;ROWS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmrp0210_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ex_xnkh&nbsp;=&nbsp;ls_data-ztj8.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDSELECT.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_tjk.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-matnr&nbsp;=&nbsp;ls_batch-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-ex_xnkh&nbsp;=&nbsp;ls_data-ztj8.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;ls_tjk&nbsp;TO&nbsp;lt_tjk.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_batch.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;ls_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UP&nbsp;TO&nbsp;1&nbsp;ROWS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmrp0210_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ex_xnkh&nbsp;=&nbsp;ls_data-ztj9.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDSELECT.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_tjk.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-matnr&nbsp;=&nbsp;ls_batch-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-ex_xnkh&nbsp;=&nbsp;ls_data-ztj9.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;ls_tjk&nbsp;TO&nbsp;lt_tjk.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_batch.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;ls_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UP&nbsp;TO&nbsp;1&nbsp;ROWS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmrp0210_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;ex_xnkh&nbsp;=&nbsp;ls_data-ztj10.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDSELECT.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_tjk.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-matnr&nbsp;=&nbsp;ls_batch-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_tjk-ex_xnkh&nbsp;=&nbsp;ls_data-ztj10.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;ls_tjk&nbsp;TO&nbsp;lt_tjk.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;DELETE&nbsp;lt_tjk&nbsp;WHERE&nbsp;ex_xnkh&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;SORT&nbsp;lt_tjk.<br />
&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;lt_tjk&nbsp;COMPARING&nbsp;ALL&nbsp;FIELDS.<br />
<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_tjk&nbsp;INTO&nbsp;ls_tjk.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;gt_store&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;matnr&nbsp;&nbsp;&nbsp;=&nbsp;ls_tjk-matnr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ex_xnkh&nbsp;=&nbsp;ls_tjk-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;TABLE&nbsp;lt_tjk&nbsp;FROM&nbsp;ls_tjk.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;IF&nbsp;lt_tjk&nbsp;IS&nbsp;NOT&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;REFRESH&nbsp;gt_tjk.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gt_tjk[]&nbsp;=&nbsp;lt_tjk[].<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;补充推荐款库存数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;frm_add_store.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;分配推荐款<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_char&nbsp;TYPE&nbsp;char13,<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_count&nbsp;TYPE&nbsp;char2,<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_tabix&nbsp;TYPE&nbsp;sy-tabix.<br />
&nbsp;&nbsp;FIELD-SYMBOLS&nbsp;&lt;fs_tjk&gt;&nbsp;TYPE&nbsp;zmmrp0040_tjk-ztj1.<br />
<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_yh&nbsp;INTO&nbsp;gs_yh&nbsp;WHERE&nbsp;menge_n&nbsp;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_data.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;SINGLE&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;ls_data<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmrp0040_tjk<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;zyks&nbsp;=&nbsp;gs_yh-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_char&nbsp;=&nbsp;'LS_DATA-ZTJ'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_count&nbsp;=&nbsp;''.<br />
&nbsp;&nbsp;&nbsp;&nbsp;DO&nbsp;10&nbsp;TIMES.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_count&nbsp;=&nbsp;l_count&nbsp;+&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONDENSE&nbsp;l_count&nbsp;NO-GAPS.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_char+11(2)&nbsp;=&nbsp;l_count.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ASSIGN&nbsp;(l_char)&nbsp;TO&nbsp;&lt;fs_tjk&gt;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;gt_store&nbsp;INTO&nbsp;gs_store<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;ex_xnkh&nbsp;=&nbsp;&lt;fs_tjk&gt;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;gs_store-menge&nbsp;&gt;&nbsp;0<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;gs_yh-menge_n&nbsp;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_tabix&nbsp;=&nbsp;sy-tabix.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;gs_ph.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-doc_number&nbsp;=&nbsp;gs_yh-doc_number.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-item_no&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-item_no.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phlx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh_ph&nbsp;=&nbsp;gs_store-ex_xnkh.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-xqsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-menge.<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;gs_store-menge&nbsp;&gt;&nbsp;gs_yh-menge_n.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-menge_n.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-lgort_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-lgort.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-cth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-cth.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-datum_ph&nbsp;&nbsp;&nbsp;=&nbsp;g_datum.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-time_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;g_uzeit.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-name_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;sy-uname.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_ph&nbsp;TO&nbsp;gt_ph.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-menge&nbsp;=&nbsp;gs_store-menge&nbsp;-&nbsp;gs_ph-phsl.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;gt_store&nbsp;FROM&nbsp;gs_store&nbsp;INDEX&nbsp;l_tabix&nbsp;TRANSPORTING&nbsp;menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-menge_n&nbsp;=&nbsp;gs_yh-menge_n&nbsp;-&nbsp;gs_ph-phsl.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-menge_y&nbsp;=&nbsp;gs_yh-menge_y&nbsp;+&nbsp;gs_ph-phsl.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-menge_t&nbsp;=&nbsp;gs_yh-menge_t&nbsp;+&nbsp;gs_ph-phsl.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;gt_yh&nbsp;FROM&nbsp;gs_yh&nbsp;TRANSPORTING&nbsp;menge_n&nbsp;menge_y&nbsp;menge_t.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDDO.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;SORT&nbsp;gt_ph&nbsp;BY&nbsp;doc_number<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item_no<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matnr_ph<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ex_xnkh_ph<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matnr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ex_xnkh.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_ADD_STORE<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&gt;P_LT_TJK&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_add_store.<br />
<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_batch&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zmmrp0210_batch,<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_batch&nbsp;TYPE&nbsp;zmmrp0210_batch,<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_attr&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;/spe/batch_and_values,<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_attr&nbsp;&nbsp;TYPE&nbsp;/spe/batch_and_values,<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_lgort&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zmm_delevlgort,<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_mchb&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;mchb,<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_store&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;ty_store,<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_mchb&nbsp;&nbsp;TYPE&nbsp;mchb,<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_mara&nbsp;&nbsp;TYPE&nbsp;mara,<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_count&nbsp;&nbsp;TYPE&nbsp;i,<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_flg&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;char1,<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_menge&nbsp;&nbsp;TYPE&nbsp;menge_d,<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_message&nbsp;TYPE&nbsp;char255.<br />
<br />
&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;lt_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmrp0210_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;gt_tjk<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;matnr&nbsp;&nbsp;&nbsp;=&nbsp;gt_tjk-matnr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ex_xnkh&nbsp;=&nbsp;gt_tjk-ex_xnkh.<br />
<br />
&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;'推荐款对应的商品批次附加信息表没有数据!'&nbsp;TYPE&nbsp;'S'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;REFRESH&nbsp;lt_store.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_batch&nbsp;INTO&nbsp;ls_batch.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;批次特性<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;REFRESH&nbsp;lt_attr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'/SPE/READ_CLASSIFICATION_DATA'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_charg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-charg<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-matnr<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-werks<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TABLES<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e_values&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lt_attr<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_attr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lt_attr<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;E_BATCHES&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;no_classification&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;no_classtypes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nothing_found&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plant_missing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;4<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plant_unknown&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;5<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;some_attribs_missing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;6<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_attr_is_empty&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;7<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;8.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_attr&nbsp;INTO&nbsp;ls_attr&nbsp;WHERE&nbsp;(&nbsp;atnam&nbsp;=&nbsp;'抽屉1'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;atwrt&nbsp;&lt;&gt;&nbsp;''<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;atwrt&nbsp;&lt;&gt;&nbsp;'?'&nbsp;)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;(&nbsp;atnam&nbsp;=&nbsp;'抽屉2'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;atwrt&nbsp;&lt;&gt;&nbsp;''<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;atwrt&nbsp;&lt;&gt;&nbsp;'?').<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;SINGLE&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;ls_mara<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;mara<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;matnr&nbsp;=&nbsp;ls_batch-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;取得库存<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;REFRESH&nbsp;lt_lgort.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_lgort&nbsp;INTO&nbsp;gs_lgort&nbsp;WHERE&nbsp;extwg&nbsp;=&nbsp;ls_mara-extwg.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_lgort&nbsp;TO&nbsp;lt_lgort.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;REFRESH&nbsp;lt_mchb.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;lt_mchb<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;mchb<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;lt_lgort<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;matnr&nbsp;=&nbsp;ls_batch-matnr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;werks&nbsp;=&nbsp;lt_lgort-werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;lgort&nbsp;=&nbsp;lt_lgort-lgort<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;charg&nbsp;=&nbsp;ls_batch-charg.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_mchb&nbsp;INTO&nbsp;ls_mchb.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;gs_store.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-matnr&nbsp;&nbsp;&nbsp;=&nbsp;ls_mchb-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-ex_xnkh&nbsp;=&nbsp;ls_batch-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-werks&nbsp;&nbsp;&nbsp;=&nbsp;ls_mchb-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-lgort&nbsp;&nbsp;&nbsp;=&nbsp;ls_mchb-lgort.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;ls_mara-meins&nbsp;=&nbsp;'ST'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-clabs&nbsp;=&nbsp;ls_mchb-clabs.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;ls_mara-tempb&nbsp;=&nbsp;'01'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;ls_mchb-clabs&nbsp;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-clabs&nbsp;=&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSEIF&nbsp;ls_mara-tempb&nbsp;=&nbsp;'02'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;ls_mara-tempb&nbsp;=&nbsp;'03'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;lt_attr&nbsp;INTO&nbsp;ls_attr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;atnam&nbsp;=&nbsp;'金重'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;ls_attr-atwrt&nbsp;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-clabs&nbsp;=&nbsp;ls_mchb-clabs&nbsp;/&nbsp;ls_attr-atwrt.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-clabs&nbsp;=&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COLLECT&nbsp;gs_store&nbsp;INTO&nbsp;lt_store.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;汇总<br />
   </div>
   <div class="code">
&nbsp;&nbsp;DELETE&nbsp;lt_store&nbsp;WHERE&nbsp;clabs&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;SORT&nbsp;lt_store&nbsp;BY&nbsp;matnr&nbsp;ex_xnkh&nbsp;clabs&nbsp;DESCENDING&nbsp;werks&nbsp;lgort.<br />
&nbsp;&nbsp;l_count&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_store&nbsp;INTO&nbsp;gs_store.<br />
&nbsp;&nbsp;&nbsp;&nbsp;AT&nbsp;NEW&nbsp;ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_count&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDAT.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_count&nbsp;=&nbsp;l_count&nbsp;+&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_flg&nbsp;=&nbsp;''.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;l_count&nbsp;&gt;&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;AT&nbsp;END&nbsp;OF&nbsp;ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;l_count&nbsp;&gt;&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDAT.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;l_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;l_message.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONCATENATE&nbsp;'商品'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-matnr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'虚拟款号'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-ex_xnkh<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'在多个库存地点有库存!'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;l_message.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;s001(00)&nbsp;WITH&nbsp;l_message.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;TABLE&nbsp;lt_store&nbsp;FROM&nbsp;gs_store.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
   </div>
   <div class="codeComment">
*&nbsp;编辑数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_store&nbsp;INTO&nbsp;gs_store.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;l_menge.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_yh&nbsp;INTO&nbsp;gs_yh&nbsp;WHERE&nbsp;matnr&nbsp;=&nbsp;gs_store-matnr<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ex_xnkh&nbsp;=&nbsp;gs_store-ex_xnkh.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_menge&nbsp;=&nbsp;l_menge&nbsp;+&nbsp;gs_yh-menge.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;l_menge&nbsp;&gt;&nbsp;0.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-zrate&nbsp;=&nbsp;(&nbsp;gs_store-clabs&nbsp;/&nbsp;l_menge&nbsp;)&nbsp;*&nbsp;100.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;gs_store-menge&nbsp;=&nbsp;gs_store-clabs.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;抽屉号<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;lt_batch&nbsp;INTO&nbsp;ls_batch<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;matnr&nbsp;=&nbsp;gs_store-matnr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ex_xnkh&nbsp;=&nbsp;gs_store-ex_xnkh.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;REFRESH&nbsp;lt_attr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'/SPE/READ_CLASSIFICATION_DATA'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_charg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-charg<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-matnr<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-werks<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TABLES<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e_values&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lt_attr<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_attr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lt_attr<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;E_BATCHES&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;no_classification&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;no_classtypes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nothing_found&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plant_missing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;4<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plant_unknown&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;5<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;some_attribs_missing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;6<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_attr_is_empty&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;7<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;8.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;lt_attr&nbsp;INTO&nbsp;ls_attr&nbsp;WITH&nbsp;KEY&nbsp;atnam&nbsp;=&nbsp;'抽屉1'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-cth&nbsp;=&nbsp;ls_attr-atwrt.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;gs_store-cth&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;lt_attr&nbsp;INTO&nbsp;ls_attr&nbsp;WITH&nbsp;KEY&nbsp;atnam&nbsp;=&nbsp;'抽屉2'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-cth&nbsp;=&nbsp;ls_attr-atwrt.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_store&nbsp;TO&nbsp;gt_store.<br />
&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;DELETE&nbsp;gt_store&nbsp;WHERE&nbsp;menge&nbsp;&lt;=&nbsp;0.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_UPDATE_RESULT<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_update_result .<br />
&nbsp;&nbsp;IF&nbsp;g_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;IF&nbsp;gt_ph&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;'没有产生配货数据'&nbsp;TYPE&nbsp;'S'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_message&nbsp;TYPE&nbsp;char255.<br />
<br />
&nbsp;&nbsp;MODIFY&nbsp;zmm_delevresult&nbsp;FROM&nbsp;TABLE&nbsp;gt_ph.<br />
&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;COMMIT&nbsp;WORK&nbsp;AND&nbsp;WAIT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;l_message.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CONCATENATE&nbsp;'配货完成,开始时间'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_datum<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_uzeit<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'结束时间'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sy-datum<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sy-uzeit<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;l_message.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;s001(00)&nbsp;WITH&nbsp;l_message.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;更新要货单状态<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;frm_doc_status.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;发送配货结果IDOC<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;frm_set_idoc.<br />
&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ROLLBACK&nbsp;WORK.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;'配货结果更新失败'&nbsp;TYPE&nbsp;'S'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_UNLOCK_WERKS<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_unlock_werks .<br />
CALL FUNCTION 'DEQUEUE_EZMMRP0040_WERK'<br />
&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;p_werks.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_SET_IDOC<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_set_idoc .<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_data&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zmm_delevresult.<br />
<br />
&nbsp;&nbsp;REFRESH&nbsp;lt_data.<br />
&nbsp;&nbsp;lt_data[]&nbsp;=&nbsp;gt_ph[].<br />
<br />
&nbsp;&nbsp;SORT&nbsp;lt_data&nbsp;BY&nbsp;doc_number.<br />
&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;lt_data&nbsp;COMPARING&nbsp;doc_number.<br />
<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_data&nbsp;INTO&nbsp;gs_ph.<br />
&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;function&nbsp;<a&nbsp;href&nbsp;="zmmif0110_idoc_output/zmmif0110_idoc_output.html">'ZMMIF0110_IDOC_OUTPUT'</a><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;im_doc_number&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_ph-doc_number.<br />
&nbsp;&nbsp;ENDLOOP.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_DOC_STATUS<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_doc_status .<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_data&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zmm_delevresult,<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_flg&nbsp;TYPE&nbsp;char1.<br />
&nbsp;&nbsp;lt_data[]&nbsp;=&nbsp;gt_ph[].<br />
<br />
&nbsp;&nbsp;SORT&nbsp;lt_data&nbsp;BY&nbsp;doc_number.<br />
&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;lt_data&nbsp;COMPARING&nbsp;doc_number.<br />
<br />
&nbsp;&nbsp;l_flg&nbsp;=&nbsp;''.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_data&nbsp;INTO&nbsp;gs_ph.<br />
&nbsp;&nbsp;&nbsp;&nbsp;UPDATE&nbsp;zsdif0050_head<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SET&nbsp;doc_ind&nbsp;=&nbsp;'1'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;doc_number&nbsp;=&nbsp;gs_ph-doc_number.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;UPDATE&nbsp;zsdif0050_item<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SET&nbsp;item_ind&nbsp;=&nbsp;'1'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;doc_number&nbsp;=&nbsp;gs_ph-doc_number.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;IF&nbsp;l_flg&nbsp;=&nbsp;''.<br />
&nbsp;&nbsp;&nbsp;&nbsp;COMMIT&nbsp;WORK&nbsp;AND&nbsp;WAIT.<br />
&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ROLLBACK&nbsp;WORK.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;'要货单状态更新失败'&nbsp;TYPE&nbsp;'S'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_ADD_PH<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_add_ph .<br />
&nbsp;&nbsp;IF&nbsp;g_flg&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_yh&nbsp;INTO&nbsp;gs_yh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;gt_ph&nbsp;TRANSPORTING&nbsp;NO&nbsp;FIELDS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;doc_number&nbsp;=&nbsp;gs_yh-doc_number<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item_no&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-item_no.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;gs_ph.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-doc_number&nbsp;=&nbsp;gs_yh-doc_number.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-item_no&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-item_no.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phlx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-ex_xnkh.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-matnr.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh_ph&nbsp;=&nbsp;gs_store-ex_xnkh.<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-xqsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;0.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-werks.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-lgort_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-lgort.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-cth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-cth.<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-datum_ph&nbsp;&nbsp;&nbsp;=&nbsp;g_datum.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-time_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;g_uzeit.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-name_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;sy-uname.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_ph&nbsp;TO&nbsp;gt_ph.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
ENDFORM.<br />
<br />
<br />
   </div>
   <div class="codeComment">
*Selection&nbsp;texts<br />
*----------------------------------------------------------<br />
*&nbsp;P_WERKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;地点<br />
<br />
<br />
*Messages<br />
*----------------------------------------------------------<br />
*<br />
*&nbsp;Message&nbsp;class:&nbsp;00<br />
*001&nbsp;&nbsp;&nbsp;&1&2&3&4&5&6&7&8<br />
*<br />
*&nbsp;Message&nbsp;class:&nbsp;Hard&nbsp;coded<br />
*&nbsp;&nbsp;&nbsp;该发货地点在表ZMM_DELEVLGORT中没有配置!<br />
            </div>
          </td>
        </tr>
      </table>
      </td>
      </tr>
   <tr>
<td class="footer">www.bjcaibai.com.cn201609</td>
   </tr>
</table>
</body>
</html>
