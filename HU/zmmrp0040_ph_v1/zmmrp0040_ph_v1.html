<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=GBK" />
<title>ZMMRP0040_PH_V1</title>
<style type="text/css">
.code{ font-family:"Courier New", Courier, monospace; color:#000; font-size:14px; background-color:#F2F4F7 }
  .codeComment {font-family:"Courier New", Courier, monospace; color:#0000F0; font-size:14px; background-color:#F2F4F7 }
  .normalBold{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:12px; font-weight:800 }
  .normalBoldLarge{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:16px; font-weight:800 }
</style>
<style type="text/css">
  .normal{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:12px }
  .footer{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:12px; text-align: center }
  h2{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:16px; font-weight:800 }
  h3{ font-family:Arial, Helvetica, sans-serif; color:#000; font-size:14px; font-weight:800 }
  .outerTable{
   background-color:#E0E7ED;
   width:100%;
   border-top-width: thin;
   border-right-width: thin;
   border-right-width: thin;
   border-left-width: thin;
   border-top-style: solid;
   border-right-style: solid;
   border-bottom-style: solid;
   border-left-style: solid;
  }
  .innerTable{
   background-color:#F2F4F7;
   width:100%;
   border-top-width: thin;
   border-right-width: thin;
   border-bottom-width: thin;
   border-left-width: thin;
   border-top-style: solid;
   border-right-style: solid;
   border-bottom-style: solid;
   border-left-style: solid;
  }
</style>
</head>
<body>
<table class="outerTable">
  <tr class="normalBoldLarge">
     <td><h2>Code listing for: ZMMRP0040_PH_V1</h2>
<h3> Description: 配货规则-要货单配货</h3></td>
   </tr>
  <tr>
     <td>
     <table class="innerTable">
       <tr>
          <td>
   <div class="code">
REPORT zmmrp0040_ph_v1.<br />
<br />
TYPE-POOLS: slis, vrm.<br />
   </div>
   <div class="codeComment">
************************************************************************<br />
*&nbsp;Types<br />
************************************************************************<br />
   </div>
   <div class="code">
TYPES: BEGIN OF ty_yh,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doc_number&nbsp;TYPE&nbsp;zsdif0050_item-doc_number,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item_no&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_item-item_no,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_head-werks,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;extwg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_head-extwg,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orderid&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zmmdeli_config-orderid,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zrate&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zmmdeli_config-zrate,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;matnr,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ex_xnkh&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_item-ex_xnkh,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menge&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_item-menge,&nbsp;&nbsp;"需求数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menge_n&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_item-menge,&nbsp;&nbsp;"未满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menge_y&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_item-menge,&nbsp;&nbsp;"本款满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menge_t&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_item-menge,&nbsp;&nbsp;"推荐款满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;has_ph_ykh&nbsp;TYPE&nbsp;c&nbsp;LENGTH&nbsp;1&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"标志：该要货信息至少产生了一条原款配货结果<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;has_ph_tjk&nbsp;TYPE&nbsp;c&nbsp;LENGTH&nbsp;1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"标志：该要货信息至少产生了一条推荐款配货结果<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;ty_yh,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN&nbsp;OF&nbsp;ty_store,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ex_xnkh&nbsp;TYPE&nbsp;zsdif0050_item-ex_xnkh,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;&nbsp;&nbsp;TYPE&nbsp;werks,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lgort&nbsp;&nbsp;&nbsp;TYPE&nbsp;lgort_d,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;char13,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clabs&nbsp;&nbsp;&nbsp;TYPE&nbsp;mchb-clabs,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;库存件数<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clabs_s&nbsp;TYPE&nbsp;mchb-clabs,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;剩余库存件数<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;menge&nbsp;&nbsp;&nbsp;TYPE&nbsp;zsdif0050_item-menge,&nbsp;"&nbsp;总要货件数<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zrate&nbsp;&nbsp;&nbsp;TYPE&nbsp;zmmdeli_config-zrate,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;ty_store,<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN&nbsp;OF&nbsp;ty_tjk,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matnr&nbsp;&nbsp;&nbsp;TYPE&nbsp;matnr,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ex_xnkh&nbsp;TYPE&nbsp;zsdif0050_item-ex_xnkh,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;ty_tjk,<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN&nbsp;OF&nbsp;ty_xnkh,<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matnr&nbsp;TYPE&nbsp;mara-matnr,<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ex_xnkh&nbsp;TYPE&nbsp;zmmrp0210_batch-ex_xnkh&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;js&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zde_zxsjs&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;总要货件数<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;ty_xnkh,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN&nbsp;OF&nbsp;ty_matnr,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matnr&nbsp;TYPE&nbsp;mara-matnr,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;extwg&nbsp;TYPE&nbsp;mara-extwg,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END&nbsp;OF&nbsp;ty_matnr&nbsp;&nbsp;.<br />
<br />
   </div>
   <div class="codeComment">
************************************************************************<br />
*&nbsp;Tables<br />
************************************************************************<br />
   </div>
   <div class="code">
DATA: gt_lgort TYPE STANDARD TABLE OF zmm_delevlgort,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_lgort&nbsp;TYPE&nbsp;zmm_delevlgort,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_t001w&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;t001w,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_t001w&nbsp;TYPE&nbsp;t001w,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_rule&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zmmdeli_config,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_rule&nbsp;&nbsp;TYPE&nbsp;zmmdeli_config,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_yh&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;ty_yh,&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;要货信息<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;ty_yh,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_store&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;ty_store,&nbsp;"&nbsp;要货虚拟款号的库存<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store&nbsp;TYPE&nbsp;ty_store,<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_tjk&nbsp;&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;ty_tjk,<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_ph&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zmm_delevresult,&nbsp;"&nbsp;配货信息<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;zmm_delevresult.<br />
<br />
DATA: gs_xnkh TYPE ty_xnkh,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_xnkh&nbsp;LIKE&nbsp;TABLE&nbsp;OF&nbsp;gs_xnkh,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;按要货虚拟款号汇总门店要货的总件数<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_xnkh_wmz&nbsp;LIKE&nbsp;TABLE&nbsp;OF&nbsp;gs_xnkh&nbsp;,&nbsp;"首轮和第二轮配货后仍然未满足的要货虚拟款号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_matnr&nbsp;TYPE&nbsp;ty_matnr,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_matnr&nbsp;LIKE&nbsp;TABLE&nbsp;OF&nbsp;gs_matnr&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_msg&nbsp;TYPE&nbsp;bapiret2&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_msg&nbsp;LIKE&nbsp;TABLE&nbsp;OF&nbsp;gs_msg&nbsp;.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;定义ALV显示字段属性内表和工作区<br />
   </div>
   <div class="code">
DATA: gt_fieldcat TYPE slis_t_fieldcat_alv,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_fieldcat&nbsp;TYPE&nbsp;slis_fieldcat_alv,<br />
   </div>
   <div class="codeComment">
*&nbsp;定义ALV屏幕布局工作区<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_layout&nbsp;TYPE&nbsp;slis_layout_alv,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gt_events&nbsp;&nbsp;&nbsp;TYPE&nbsp;slis_t_event,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_events&nbsp;&nbsp;&nbsp;TYPE&nbsp;slis_alv_event.<br />
DATA: gr_grid TYPE REF TO cl_gui_alv_grid.<br />
DATA:<br />
&nbsp;&nbsp;g_flg&nbsp;TYPE&nbsp;char1,<br />
&nbsp;&nbsp;g_datum&nbsp;TYPE&nbsp;sy-datum,<br />
&nbsp;&nbsp;g_uzeit&nbsp;TYPE&nbsp;sy-uzeit.<br />
<br />
   </div>
   <div class="codeComment">
************************************************************************<br />
*&nbsp;Parameters<br />
************************************************************************<br />
   </div>
   <div class="code">
SELECTION-SCREEN BEGIN OF BLOCK B01 WITH FRAME TITLE TEXT-T01.<br />
PARAMETERS      P_WERKS TYPE T001W-WERKS OBLIGATORY .<br />
SELECTION-SCREEN END OF BLOCK B01.<br />
<br />
SELECTION-SCREEN BEGIN OF BLOCK B02 WITH FRAME TITLE TEXT-T02.<br />
PARAMETERS: CBX_1 AS CHECKBOX DEFAULT '' .<br />
PARAMETERS: CBX_2 AS CHECKBOX DEFAULT 'X' .<br />
SELECTION-SCREEN END OF BLOCK B02.<br />
<br />
   </div>
   <div class="codeComment">
************************************************************************<br />
*&nbsp;Start&nbsp;of&nbsp;Selection<br />
************************************************************************<br />
   </div>
   <div class="code">
START-OF-SELECTION.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;锁定地点<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_lock_werks.<br />
   </div>
   <div class="codeComment">
*&nbsp;取得数据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_get_data.<br />
   </div>
   <div class="codeComment">
*&nbsp;配货<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_ph.<br />
   </div>
   <div class="codeComment">
*&nbsp;推荐款匹配<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_tjk.<br />
   </div>
   <div class="codeComment">
*&nbsp;添加没有配货的单据<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_add_ph.<br />
   </div>
   <div class="codeComment">
*&nbsp;更新配货结果<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_update_result.<br />
   </div>
   <div class="codeComment">
*&nbsp;解锁地点<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_unlock_werks.<br />
   </div>
   <div class="codeComment">
*&nbsp;显示配货结果<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_dis_result&nbsp;.<br />
<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_GET_DATA<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_get_data .<br />
<br />
&nbsp;&nbsp;IF&nbsp;G_FLG&nbsp;=&nbsp;'E'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT&nbsp;.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;开始时间<br />
   </div>
   <div class="code">
&nbsp;&nbsp;g_datum&nbsp;=&nbsp;sy-datum.<br />
&nbsp;&nbsp;g_uzeit&nbsp;=&nbsp;sy-uzeit.<br />
   </div>
   <div class="codeComment">
*&nbsp;取得配货地点<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_get_logrt.<br />
   </div>
   <div class="codeComment">
*&nbsp;取得门店<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_get_werks.<br />
   </div>
   <div class="codeComment">
*&nbsp;取得门店配货规则<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_get_rule.<br />
   </div>
   <div class="codeComment">
*&nbsp;获取要处理的门店要货清单<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_get_list.<br />
   </div>
   <div class="codeComment">
*&nbsp;整理要货库存表<br />
   </div>
   <div class="code">
&nbsp;&nbsp;PERFORM&nbsp;frm_sort_store.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_LOCK_WERKS<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_lock_werks .<br />
<br />
&nbsp;&nbsp;GET&nbsp;TIME&nbsp;.<br />
&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'开始配货，日期：'&nbsp;&&&nbsp;SY-DATUM&nbsp;.&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;'，时间：'&nbsp;&&&nbsp;SY-UZEIT&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
<br />
&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'ENQUEUE_EZMMRP0040_WERK'<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MODE_ZMMRP0040_LOCK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'S'<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MANDT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;SY-MANDT<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;p_werks<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;X_WERKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'&nbsp;'<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_SCOPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'2'<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_WAIT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'&nbsp;'<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_COLLECT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'&nbsp;'<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreign_lock&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;system_failure&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3.<br />
&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'E'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'锁定地点'&nbsp;&&&nbsp;p_werks&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;'失败，有其他人在为该地点执行配货程序'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;sy-msgty&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;sy-msgid&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;sy-msgno&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;sy-msgv1&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;sy-msgv2&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;sy-msgv3&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;sy-msgv4&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;G_FLG&nbsp;=&nbsp;'E'&nbsp;.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_GET_LOGRT<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_get_logrt.<br />
&nbsp;&nbsp;REFRESH&nbsp;gt_lgort.<br />
<br />
&nbsp;&nbsp;IF&nbsp;G_FLG&nbsp;=&nbsp;'E'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT&nbsp;.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;gt_lgort<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmm_delevlgort<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;werks&nbsp;=&nbsp;p_werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;kcdflg&nbsp;=&nbsp;'01'.<br />
&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'该发货地点在表ZMM_DELEVLGORT中没有配置!'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;''.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;G_FLG&nbsp;=&nbsp;'E'&nbsp;.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_GET_WERKS<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_get_werks .<br />
<br />
&nbsp;&nbsp;IF&nbsp;g_flg&nbsp;=&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;REFRESH&nbsp;gt_t001w.<br />
&nbsp;&nbsp;SELECT&nbsp;t001w~werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;CORRESPONDING&nbsp;FIELDS&nbsp;OF&nbsp;TABLE&nbsp;gt_t001w<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;t001w&nbsp;INNER&nbsp;JOIN&nbsp;wrf3<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;t001w~kunnr&nbsp;=&nbsp;wrf3~locnr<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;wrf3~loclb&nbsp;=&nbsp;p_werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;wrf3~datbi&nbsp;&gt;=&nbsp;sy-datum<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;wrf3~datab&nbsp;&lt;=&nbsp;sy-datum.<br />
&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'E'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'该发货地点没有对应的门店!'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;g_flg&nbsp;=&nbsp;'E'.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_GET_RULE<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_get_rule .<br />
&nbsp;&nbsp;IF&nbsp;g_flg&nbsp;=&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;gt_rule<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmdeli_config<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;gt_t001w<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;werks&nbsp;=&nbsp;gt_t001w-werks.<br />
&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'没有维护对应门店的配货规则!'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;''.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;g_flg&nbsp;=&nbsp;'E'.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_GET_LIST<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_get_list.<br />
&nbsp;&nbsp;IF&nbsp;g_flg&nbsp;=&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_head&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zsdif0050_head,<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_head&nbsp;TYPE&nbsp;zsdif0050_head,<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_item&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zsdif0050_item,<br />
&nbsp;&nbsp;&nbsp;&nbsp;ls_item&nbsp;TYPE&nbsp;zsdif0050_item.<br />
<br />
&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;lt_head<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zsdif0050_head<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;gt_t001w<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;werks&nbsp;&nbsp;&nbsp;=&nbsp;gt_t001w-werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ord_typ&nbsp;=&nbsp;'LX01'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;act_typ&nbsp;=&nbsp;'PH01'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;doc_ind&nbsp;=&nbsp;'0'.<br />
&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'没有需要处理的门店要货单!'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;g_flg&nbsp;=&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;lt_item<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zsdif0050_item<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;lt_head<br />
&nbsp;&nbsp;&nbsp;WHERE&nbsp;doc_number&nbsp;=&nbsp;lt_head-doc_number.<br />
&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MOVE-CORRESPONDING&nbsp;lt_item&nbsp;to&nbsp;gt_matnr&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;gt_matnr&nbsp;by&nbsp;matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;gt_matnr&nbsp;COMPARING&nbsp;matnr&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;matnr&nbsp;extwg<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;gt_matnr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;mara<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;gt_matnr<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;matnr&nbsp;=&nbsp;gt_matnr-matnr&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'要货信息中商品在SAP不存在!'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_flg&nbsp;=&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'没有需要处理的门店要货单明细!'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;g_flg&nbsp;=&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;REFRESH&nbsp;gt_yh.<br />
&nbsp;&nbsp;SORT&nbsp;gt_matnr&nbsp;BY&nbsp;matnr&nbsp;.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_item&nbsp;INTO&nbsp;ls_item.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_head.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;lt_head&nbsp;INTO&nbsp;ls_head&nbsp;WITH&nbsp;KEY&nbsp;doc_number&nbsp;=&nbsp;ls_item-doc_number.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;gs_yh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-doc_number&nbsp;=&nbsp;ls_head-doc_number.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-item_no&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_item-item_no.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_head-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;gt_matnr&nbsp;INTO&nbsp;gs_matnr&nbsp;WITH&nbsp;KEY&nbsp;matnr&nbsp;=&nbsp;ls_item-matnr&nbsp;BINARY&nbsp;SEARCH&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-extwg&nbsp;=&nbsp;gs_matnr-extwg&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;gt_rule&nbsp;INTO&nbsp;gs_rule&nbsp;WITH&nbsp;KEY&nbsp;extwg&nbsp;=&nbsp;gs_yh-extwg<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;=&nbsp;gs_yh-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-orderid&nbsp;=&nbsp;gs_rule-orderid.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-zrate&nbsp;&nbsp;&nbsp;=&nbsp;gs_rule-zrate.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-orderid&nbsp;=&nbsp;'9999'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-zrate&nbsp;&nbsp;&nbsp;=&nbsp;'1'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-matnr&nbsp;=&nbsp;ls_item-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-ex_xnkh&nbsp;=&nbsp;ls_item-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-menge&nbsp;=&nbsp;ls_item-menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_yh-menge_n&nbsp;=&nbsp;ls_item-menge.&nbsp;"&nbsp;未满足需求数量，默认等于需求数量<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_yh&nbsp;TO&nbsp;gt_yh.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;按虚拟款号汇总要货件数<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;gs_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_xnkh-ex_xnkh&nbsp;=&nbsp;ls_item-ex_xnkh.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_xnkh-js&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_item-menge.&nbsp;"&nbsp;要货件数<br />
&nbsp;&nbsp;&nbsp;&nbsp;COLLECT&nbsp;gs_xnkh&nbsp;INTO&nbsp;gt_xnkh&nbsp;.<br />
&nbsp;&nbsp;ENDLOOP.<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_SORT_STORE<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;Changed&nbsp;by&nbsp;huxiaowei&nbsp;@20150921<br />
*&nbsp;Old&nbsp;version&nbsp;has&nbsp;been&nbsp;copied&nbsp;to&nbsp;FORM&nbsp;frm_sort_store_old_20150921&nbsp;.<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
form frm_sort_store .<br />
&nbsp;&nbsp;DATA:&nbsp;lt_xnkh&nbsp;TYPE&nbsp;zcb01_ty_t_xnkh&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lrt_werks&nbsp;TYPE&nbsp;zcb01_ty_r_werks&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lrs_werks&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;lrt_werks&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lrt_lgort&nbsp;TYPE&nbsp;zcb01_ty_r_lgort&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lrs_lgort&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;lrt_lgort&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lt_stock&nbsp;TYPE&nbsp;zcb01_ty_t_stock,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls_stock&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;lt_stock&nbsp;.<br />
&nbsp;&nbsp;FIELD-SYMBOLS&nbsp;&lt;gs_store&gt;&nbsp;LIKE&nbsp;gs_store&nbsp;.<br />
<br />
&nbsp;&nbsp;IF&nbsp;G_FLG&nbsp;=&nbsp;'E'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT&nbsp;.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;MOVE-CORRESPONDING&nbsp;gt_xnkh&nbsp;TO&nbsp;lt_xnkh&nbsp;.<br />
<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_lgort&nbsp;INTO&nbsp;gs_lgort&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;lrs_lgort&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;lrs_lgort-sign&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;lrs_lgort-option&nbsp;&nbsp;=&nbsp;'EQ'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;lrs_lgort-low&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_lgort-lgort.<br />
&nbsp;&nbsp;&nbsp;&nbsp;lrs_lgort-high&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;lrs_lgort&nbsp;to&nbsp;lrt_lgort&nbsp;.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;lrs_werks-sign&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;lrs_werks-option&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'EQ'&nbsp;.<br />
&nbsp;&nbsp;lrs_werks-low&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;p_werks&nbsp;.<br />
&nbsp;&nbsp;lrs_werks-high&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;APPEND&nbsp;lrs_werks&nbsp;TO&nbsp;lrt_werks&nbsp;.<br />
<br />
&nbsp;&nbsp;call&nbsp;function&nbsp;<a&nbsp;href&nbsp;="zmm_get_stock_xnkh/zmm_get_stock_xnkh.html">'ZMM_GET_STOCK_XNKH'</a><br />
&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IM_HAS_ZCT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'X'<br />
&nbsp;&nbsp;&nbsp;&nbsp;TABLES<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IT_XNKH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lt_xnkh<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IR_WERKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lrt_werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IR_LGORT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lrt_lgort<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ET_STOCK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lt_stock<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EMPTY_IT_XNKH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EMPTY_IR_WERKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3&nbsp;.<br />
&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_stock&nbsp;INTO&nbsp;ls_stock&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;gs_store&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_store-ex_xnkh&nbsp;=&nbsp;ls_stock-ex_xnkh&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_store-werks&nbsp;=&nbsp;ls_stock-werks&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_store-lgort&nbsp;=&nbsp;ls_stock-lgort&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_store-cth&nbsp;=&nbsp;ls_stock-cth&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_store-clabs&nbsp;=&nbsp;ls_stock-clabs&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_store-clabs_s&nbsp;=&nbsp;ls_stock-clabs_s&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;gt_xnkh&nbsp;INTO&nbsp;gs_xnkh&nbsp;WITH&nbsp;KEY&nbsp;ex_xnkh&nbsp;=&nbsp;ls_stock-ex_xnkh&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-menge&nbsp;=&nbsp;gs_xnkh-js&nbsp;.&nbsp;&nbsp;&nbsp;"&nbsp;总要货件数<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;gs_store-menge&nbsp;&gt;&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-zrate&nbsp;=&nbsp;(&nbsp;gs_store-clabs&nbsp;/&nbsp;gs_store-menge&nbsp;)&nbsp;*&nbsp;100.&nbsp;&nbsp;"&nbsp;库存需求比<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_store&nbsp;TO&nbsp;gt_store&nbsp;.<br />
&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;"&nbsp;注意gt_store为空说明要货虚拟款没有库存，但这并不意味着错误，不需要退出；<br />
&nbsp;&nbsp;"&nbsp;因为后面还可以分配推荐款库存<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
**&---------------------------------------------------------------------*<br />
**&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_SORT_STORE<br />
**&---------------------------------------------------------------------*<br />
**&nbsp;Created&nbsp;by&nbsp;huxiaowei&nbsp;@20150921<br />
**&nbsp;公用程序，按商品+虚拟款号取得库存<br />
**----------------------------------------------------------------------*<br />
**&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
**&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
**----------------------------------------------------------------------*<br />
*FORM&nbsp;frm_stock_xnkh&nbsp;TABLES&nbsp;it_xnkh&nbsp;STRUCTURE&nbsp;gs_xnkh<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it_lgort&nbsp;STRUCTURE&nbsp;gs_lgort<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;et_stock&nbsp;STRUCTURE&nbsp;gs_store<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;USING&nbsp;im_werks&nbsp;TYPE&nbsp;werks_d.<br />
**&nbsp;&nbsp;DATA:&nbsp;BEGIN&nbsp;OF&nbsp;ls_mchb,<br />
**&nbsp;&nbsp;&nbsp;&nbsp;matnr&nbsp;TYPE&nbsp;mchb-matnr,<br />
**&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;TYPE&nbsp;mchb-werks,<br />
**&nbsp;&nbsp;&nbsp;&nbsp;lgort&nbsp;TYPE&nbsp;mchb-lgort,<br />
**&nbsp;&nbsp;&nbsp;&nbsp;charg&nbsp;TYPE&nbsp;mchb-charg,<br />
**&nbsp;&nbsp;&nbsp;&nbsp;clabs&nbsp;TYPE&nbsp;mchb-clabs,<br />
**&nbsp;&nbsp;&nbsp;&nbsp;meins&nbsp;TYPE&nbsp;mara-meins,<br />
**&nbsp;&nbsp;&nbsp;&nbsp;ex_xnkh&nbsp;TYPE&nbsp;zmmrp0210_batch-ex_xnkh&nbsp;,<br />
**&nbsp;&nbsp;&nbsp;&nbsp;zjz&nbsp;&nbsp;&nbsp;TYPE&nbsp;zmmrp0210_batch-zjz&nbsp;,<br />
**&nbsp;&nbsp;&nbsp;&nbsp;zct1&nbsp;&nbsp;TYPE&nbsp;zmmrp0210_batch-zct1&nbsp;,<br />
**&nbsp;&nbsp;END&nbsp;OF&nbsp;ls_mchb&nbsp;.<br />
**&nbsp;&nbsp;DATA:&nbsp;lt_mchb&nbsp;LIKE&nbsp;TABLE&nbsp;OF&nbsp;ls_mchb&nbsp;.<br />
*&nbsp;&nbsp;DATA:&nbsp;lrt_lgort&nbsp;TYPE&nbsp;RANGE&nbsp;OF&nbsp;lgort_d,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lrs_lgort&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;lrt_lgort,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls_lgort&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;it_lgort,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls_xnkh&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;it_xnkh,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls_stock&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;et_stock&nbsp;.<br />
*&nbsp;&nbsp;DATA:&nbsp;lv_lines&nbsp;TYPE&nbsp;i&nbsp;.<br />
*<br />
*&nbsp;&nbsp;REFRESH&nbsp;et_stock&nbsp;.<br />
*&nbsp;&nbsp;IF&nbsp;it_xnkh[]&nbsp;IS&nbsp;INITIAL&nbsp;.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;EXIT&nbsp;.<br />
*&nbsp;&nbsp;ENDIF.<br />
*<br />
*&nbsp;&nbsp;IF&nbsp;it_lgort[]&nbsp;IS&nbsp;INITIAL.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;EXIT&nbsp;.<br />
*&nbsp;&nbsp;ENDIF.<br />
*<br />
*&nbsp;&nbsp;IF&nbsp;im_werks&nbsp;IS&nbsp;INITIAL&nbsp;.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;EXIT&nbsp;.<br />
*&nbsp;&nbsp;ENDIF.<br />
*<br />
*&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;it_lgort&nbsp;INTO&nbsp;it_lgort&nbsp;.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;lrs_lgort&nbsp;.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;lrs_lgort-sign&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;lrs_lgort-option&nbsp;&nbsp;=&nbsp;'EQ'&nbsp;.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;lrs_lgort-low&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;it_lgort-lgort.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;lrs_lgort-high&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;''&nbsp;.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;lrs_lgort&nbsp;to&nbsp;lrt_lgort&nbsp;.<br />
*&nbsp;&nbsp;ENDLOOP.<br />
*<br />
*&nbsp;&nbsp;SELECT&nbsp;mchb~matnr&nbsp;mchb~werks&nbsp;mchb~lgort&nbsp;mchb~charg&nbsp;mchb~clabs<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mara~meins<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zmmrp0210_batch~ex_xnkh&nbsp;zmmrp0210_batch~zjz&nbsp;zmmrp0210_batch~zct1<br />
*&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;CORRESPONDING&nbsp;FIELDS&nbsp;OF&nbsp;TABLE&nbsp;lt_mchb<br />
*&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;mchb<br />
*&nbsp;&nbsp;&nbsp;&nbsp;INNER&nbsp;JOIN&nbsp;zmmrp0210_batch&nbsp;on&nbsp;zmmrp0210_batch~matnr&nbsp;=&nbsp;mchb~matnr&nbsp;AND<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zmmrp0210_batch~charg&nbsp;=&nbsp;mchb~charg<br />
*&nbsp;&nbsp;&nbsp;&nbsp;INNER&nbsp;JOIN&nbsp;mara&nbsp;on&nbsp;mara~matnr&nbsp;=&nbsp;mchb~matnr<br />
*&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;it_xnkh<br />
*&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;mchb~werks&nbsp;=&nbsp;im_werks<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;mchb~lgort&nbsp;in&nbsp;lrt_lgort<br />
**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;zmmrp0210_batch~matnr&nbsp;=&nbsp;it_xnkh-matnr<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;zmmrp0210_batch~ex_xnkh&nbsp;=&nbsp;it_xnkh-ex_xnkh<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;zmmrp0210_batch~zct1&nbsp;&lt;&gt;&nbsp;''<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;mchb~clabs&nbsp;&lt;&gt;&nbsp;0&nbsp;.<br />
*&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0&nbsp;.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
*&nbsp;&nbsp;ENDIF.<br />
*<br />
*&nbsp;&nbsp;SORT&nbsp;lt_mchb&nbsp;BY&nbsp;matnr&nbsp;ex_xnkh&nbsp;charg&nbsp;werks&nbsp;lgort&nbsp;.<br />
*&nbsp;&nbsp;"&nbsp;按虚拟款号+地点+库存地点汇总库存<br />
*&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_mchb&nbsp;INTO&nbsp;ls_mchb&nbsp;.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_stock&nbsp;.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ls_stock-ex_xnkh&nbsp;&nbsp;=&nbsp;ls_mchb-ex_xnkh&nbsp;.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ls_stock-werks&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_mchb-werks&nbsp;.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ls_stock-lgort&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_mchb-lgort&nbsp;.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;ls_mchb-meins&nbsp;=&nbsp;'G'&nbsp;.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;ls_mchb-zjz&nbsp;&lt;&gt;&nbsp;0&nbsp;.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls_stock-clabs&nbsp;=&nbsp;ls_mchb-clabs&nbsp;/&nbsp;ls_mchb-zjz&nbsp;.&nbsp;"&nbsp;库存件数<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls_stock-clabs&nbsp;=&nbsp;1&nbsp;.&nbsp;"&nbsp;库存件数<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls_stock-clabs&nbsp;=&nbsp;ls_mchb-clabs&nbsp;.&nbsp;"&nbsp;库存件数<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ls_stock-clabs_s&nbsp;=&nbsp;ls_mchb-clabs&nbsp;.&nbsp;"&nbsp;剩余库存件数<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ls_stock-cth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_mchb-zct1&nbsp;.&nbsp;"&nbsp;抽屉号<br />
*&nbsp;&nbsp;&nbsp;&nbsp;COLLECT&nbsp;ls_stock&nbsp;INTO&nbsp;et_stock&nbsp;.<br />
*&nbsp;&nbsp;ENDLOOP.<br />
*ENDFORM&nbsp;.<br />
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_PH<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_ph .<br />
&nbsp;&nbsp;FIELD-SYMBOLS:&nbsp;&lt;gs_yh&gt;&nbsp;LIKE&nbsp;gs_yh,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_store&gt;&nbsp;LIKE&nbsp;gs_store,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_ph&gt;&nbsp;LIKE&nbsp;gs_ph&nbsp;.<br />
&nbsp;&nbsp;DATA:&nbsp;lv_menge&nbsp;TYPE&nbsp;menge_d&nbsp;.<br />
&nbsp;&nbsp;DATA:&nbsp;lv_line&nbsp;TYPE&nbsp;i&nbsp;.<br />
&nbsp;&nbsp;DATA:&nbsp;ROUND_DOWN&nbsp;TYPE&nbsp;i&nbsp;VALUE&nbsp;5&nbsp;.<br />
<br />
&nbsp;&nbsp;IF&nbsp;g_flg&nbsp;=&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;IF&nbsp;gt_store[]&nbsp;IS&nbsp;INITIAL&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'要货款都没有库存，不需要进行原款配货！'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;REFRESH&nbsp;gt_ph.<br />
&nbsp;&nbsp;SORT&nbsp;gt_store&nbsp;BY&nbsp;ex_xnkh&nbsp;werks&nbsp;lgort&nbsp;.<br />
&nbsp;&nbsp;SORT&nbsp;gt_yh&nbsp;BY&nbsp;ex_xnkh&nbsp;ASCENDING&nbsp;orderid&nbsp;ASCENDING&nbsp;werks&nbsp;ASCENDING.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_yh&nbsp;ASSIGNING&nbsp;&lt;gs_yh&gt;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;gt_lgort&nbsp;INTO&nbsp;gs_lgort&nbsp;WITH&nbsp;KEY&nbsp;extwg&nbsp;=&nbsp;&lt;gs_yh&gt;-extwg<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;=&nbsp;p_werks&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;gt_store&nbsp;ASSIGNING&nbsp;&lt;gs_store&gt;&nbsp;WITH&nbsp;KEY&nbsp;ex_xnkh&nbsp;=&nbsp;&lt;gs_yh&gt;-ex_xnkh<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;=&nbsp;p_werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lgort&nbsp;=&nbsp;gs_lgort-lgort<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;如果没有找到，或者该虚拟商品的剩余库存件数&lt;=0<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0&nbsp;OR&nbsp;&lt;gs_store&gt;-clabs_s&nbsp;&lt;=&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR:&nbsp;gs_ph,&nbsp;lv_menge&nbsp;.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;IF&nbsp;gs_store-zrate&nbsp;&gt;=&nbsp;100.<br />
*&nbsp;&nbsp;将&nbsp;gs_store-zrate&nbsp;修改为&nbsp;&lt;gs_store&gt;-zrate&nbsp;，否则会导致判断条件错误，LK，20151217&nbsp;17:40<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;gs_store&gt;-zrate&nbsp;&gt;=&nbsp;100.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;库存需求比大于100%，库存可以完全满足需求<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lv_menge&nbsp;=&nbsp;&lt;gs_yh&gt;-menge&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
   </div>
   <div class="codeComment">
*&nbsp;库存需求比小于100%<br />
*&nbsp;首轮配货数量&nbsp;=&nbsp;（库存需求比-首轮分配下调比例）&nbsp;*&nbsp;该门店要货数量，并向下取整<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lv_menge&nbsp;=&nbsp;(&nbsp;&lt;gs_store&gt;-zrate&nbsp;-&nbsp;&lt;gs_yh&gt;-zrate&nbsp;)&nbsp;/&nbsp;100&nbsp;&nbsp;*&nbsp;&lt;gs_yh&gt;-menge&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;lv_menge&nbsp;&lt;&nbsp;1&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;向下取整<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lv_menge&nbsp;=&nbsp;ROUND(&nbsp;VAL&nbsp;=&nbsp;lv_menge&nbsp;DEC&nbsp;=&nbsp;0&nbsp;MODE&nbsp;=&nbsp;ROUND_DOWN&nbsp;)&nbsp;&nbsp;.&nbsp;"&nbsp;MOD&nbsp;5&nbsp;指ROUND&nbsp;DOWN<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-doc_number&nbsp;=&nbsp;&lt;gs_yh&gt;-doc_number.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-item_no&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-item_no.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phlx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-matnr.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;要货商品<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-ex_xnkh.&nbsp;&nbsp;&nbsp;"&nbsp;要货虚拟款号<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr_ph&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-matnr.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;实际配货商品<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh_ph&nbsp;=&nbsp;&lt;gs_yh&gt;-ex_xnkh.&nbsp;&nbsp;&nbsp;"&nbsp;实际配货虚拟款号<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks_ph&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_store&gt;-werks.&nbsp;&nbsp;"&nbsp;发货地点<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-lgort_ph&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_store&gt;-lgort.&nbsp;&nbsp;"&nbsp;发货库存地点<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-cth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_store&gt;-cth.&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;抽屉号<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-datum_ph&nbsp;&nbsp;&nbsp;=&nbsp;g_datum.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-time_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;g_uzeit.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-name_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;sy-uname.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-xqsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-menge.&nbsp;&nbsp;&nbsp;"&nbsp;要货数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lv_menge.&nbsp;&nbsp;&nbsp;"&nbsp;配货数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_ph&nbsp;TO&nbsp;gt_ph.<br />
&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;更新虚拟款号的剩余库存件数<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_store&gt;-clabs_s&nbsp;=&nbsp;&lt;gs_store&gt;-clabs_s&nbsp;-&nbsp;lv_menge&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;更新要货信息中的未满足数量、本款满足数量、推荐款满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_yh&gt;-menge_n&nbsp;=&nbsp;&lt;gs_yh&gt;-menge_n&nbsp;-&nbsp;lv_menge.&nbsp;"&nbsp;未满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_yh&gt;-menge_y&nbsp;=&nbsp;&lt;gs_yh&gt;-menge_y&nbsp;+&nbsp;lv_menge&nbsp;.&nbsp;&nbsp;"&nbsp;本款满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_yh&gt;-menge_t&nbsp;=&nbsp;0.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;推荐款满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_yh&gt;-has_ph_ykh&nbsp;&nbsp;=&nbsp;'X'&nbsp;.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;标志，该要货信息至少产生一条原款库存配货信息<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;第二轮配货<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_yh&nbsp;ASSIGNING&nbsp;&lt;gs_yh&gt;&nbsp;WHERE&nbsp;menge_n&nbsp;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;gt_lgort&nbsp;INTO&nbsp;gs_lgort&nbsp;WITH&nbsp;KEY&nbsp;extwg&nbsp;=&nbsp;&lt;gs_yh&gt;-extwg<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;=&nbsp;p_werks&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;gt_store&nbsp;ASSIGNING&nbsp;&lt;gs_store&gt;&nbsp;WITH&nbsp;KEY&nbsp;ex_xnkh&nbsp;=&nbsp;&lt;gs_yh&gt;-ex_xnkh<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;=&nbsp;p_werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lgort&nbsp;=&nbsp;gs_lgort-lgort<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;如果没有找到，或者该虚拟商品的剩余库存件数&lt;=0<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0&nbsp;OR&nbsp;&lt;gs_store&gt;-clabs_s&nbsp;&lt;=&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;收集第二轮配货后剩余要货数量大于0的要货虚拟款号，后面要为这些虚拟款号分配推荐款库存<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR:&nbsp;gs_xnkh&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_xnkh-ex_xnkh&nbsp;=&nbsp;&lt;gs_yh&gt;-ex_xnkh&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_xnkh&nbsp;TO&nbsp;gt_xnkh_wmz&nbsp;.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR:&nbsp;gs_ph,&nbsp;lv_menge&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;确定本次配货数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;gs_yh&gt;-menge_n&nbsp;&lt;=&nbsp;&lt;gs_store&gt;-clabs_s.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;如果要货信息的未满足数量&lt;=虚拟款号的剩余库存数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;本次配货数量&nbsp;=&nbsp;要货信息的未满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lv_menge&nbsp;=&nbsp;&lt;gs_yh&gt;-menge_n&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;否则，本次配货数量&nbsp;=&nbsp;虚拟款号的剩余库存数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lv_menge&nbsp;=&nbsp;&lt;gs_store&gt;-clabs_s&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;如果第一轮配货有配货结果<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;gt_ph&nbsp;ASSIGNING&nbsp;&lt;gs_ph&gt;&nbsp;WITH&nbsp;KEY&nbsp;doc_number&nbsp;=&nbsp;&lt;gs_yh&gt;-doc_number<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item_no&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-item_no&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_ph&gt;-phsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_ph&gt;-phsl&nbsp;+&nbsp;lv_menge.&nbsp;&nbsp;&nbsp;"&nbsp;配货数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-doc_number&nbsp;=&nbsp;&lt;gs_yh&gt;-doc_number.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-item_no&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-item_no.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phlx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-matnr.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;要货商品<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-ex_xnkh.&nbsp;&nbsp;&nbsp;"&nbsp;要货虚拟款号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr_ph&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-matnr.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;实际配货商品<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh_ph&nbsp;=&nbsp;&lt;gs_yh&gt;-ex_xnkh.&nbsp;&nbsp;&nbsp;"&nbsp;实际配货虚拟款号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks_ph&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_store&gt;-werks.&nbsp;&nbsp;"&nbsp;发货地点<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-lgort_ph&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_store&gt;-lgort.&nbsp;&nbsp;"&nbsp;发货库存地点<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-cth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_store&gt;-cth.&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;抽屉号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-datum_ph&nbsp;&nbsp;&nbsp;=&nbsp;g_datum.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-time_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;g_uzeit.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-name_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;sy-uname.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-xqsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-menge.&nbsp;&nbsp;&nbsp;"&nbsp;要货数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lv_menge.&nbsp;&nbsp;&nbsp;"&nbsp;配货数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_ph&nbsp;TO&nbsp;gt_ph&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;更新虚拟款号的剩余库存件数<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_store&gt;-clabs_s&nbsp;=&nbsp;&lt;gs_store&gt;-clabs_s&nbsp;-&nbsp;lv_menge&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;更新要货信息中的未满足数量、本款满足数量、推荐款满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_yh&gt;-menge_n&nbsp;=&nbsp;&lt;gs_yh&gt;-menge_n&nbsp;-&nbsp;lv_menge.&nbsp;"&nbsp;未满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_yh&gt;-menge_y&nbsp;=&nbsp;&lt;gs_yh&gt;-menge_y&nbsp;+&nbsp;lv_menge&nbsp;.&nbsp;&nbsp;"&nbsp;本款满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_yh&gt;-menge_t&nbsp;=&nbsp;0.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;推荐款满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_yh&gt;-has_ph_ykh&nbsp;&nbsp;=&nbsp;'X'&nbsp;.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;标志，该要货信息至少产生一条原款库存配货信息<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;gs_yh&gt;-menge_n&nbsp;&gt;&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;收集第二轮配货后剩余要货数量大于0的要货虚拟款号，后面要为这些虚拟款号分配推荐款库存<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR:&nbsp;gs_xnkh&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_xnkh-ex_xnkh&nbsp;=&nbsp;&lt;gs_yh&gt;-ex_xnkh&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_xnkh&nbsp;TO&nbsp;gt_xnkh_wmz&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;lv_line&nbsp;=&nbsp;lines(&nbsp;gt_ph&nbsp;)&nbsp;.<br />
&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'原款库存配货结束，产生配货信息：'&nbsp;&&&nbsp;lv_line&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;'条！'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_TJK<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_tjk .<br />
<br />
&nbsp;&nbsp;DATA:&nbsp;ls_tjk&nbsp;TYPE&nbsp;zmmrp0040_tjk,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lt_tjk&nbsp;LIKE&nbsp;TABLE&nbsp;OF&nbsp;ls_tjk&nbsp;.<br />
<br />
&nbsp;&nbsp;DATA:&nbsp;lv_menge&nbsp;TYPE&nbsp;menge_d,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lv_len&nbsp;TYPE&nbsp;i,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lv_line&nbsp;TYPE&nbsp;i&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;DATA:&nbsp;lt_xnkh_tjk&nbsp;TYPE&nbsp;zcb01_ty_t_xnkh&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls_xnkh_tjk&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;lt_xnkh_tjk,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lrt_werks&nbsp;TYPE&nbsp;zcb01_ty_r_werks&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lrs_werks&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;lrt_werks&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lrt_lgort&nbsp;TYPE&nbsp;zcb01_ty_r_lgort&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lrs_lgort&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;lrt_lgort&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lt_stock_tjk&nbsp;TYPE&nbsp;zcb01_ty_t_stock,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls_stock_tjk&nbsp;LIKE&nbsp;LINE&nbsp;OF&nbsp;lt_stock_tjk&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls_stock_tjk_tmp&nbsp;LIKE&nbsp;ls_stock_tjk&nbsp;,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lt_stock_tjk_tmp&nbsp;LIKE&nbsp;TABLE&nbsp;OF&nbsp;ls_stock_tjk_tmp.<br />
<br />
&nbsp;&nbsp;FIELD-SYMBOLS:&nbsp;&lt;ls_stock_tjk&gt;&nbsp;LIKE&nbsp;ls_stock_tjk,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ls_stock_tjk_tmp&gt;&nbsp;LIKE&nbsp;ls_stock_tjk_tmp,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_yh&gt;&nbsp;LIKE&nbsp;gs_yh&nbsp;.<br />
<br />
&nbsp;&nbsp;DEFINE&nbsp;tjk_to_line.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&1&nbsp;IS&nbsp;NOT&nbsp;INITIAL&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls_xnkh_tjk-ex_xnkh&nbsp;=&nbsp;&1&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;ls_xnkh_tjk&nbsp;TO&nbsp;lt_xnkh_tjk&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;END-OF-DEFINITION.<br />
<br />
&nbsp;&nbsp;DEFINE&nbsp;tjk_clabs_s.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&1&nbsp;IS&nbsp;NOT&nbsp;INITIAL&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls_stock_tjk_tmp-ex_xnkh&nbsp;=&nbsp;&1&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;lt_stock_tjk&nbsp;INTO&nbsp;ls_stock_tjk&nbsp;WITH&nbsp;KEY&nbsp;ex_xnkh&nbsp;=&nbsp;&1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;=&nbsp;p_werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lgort&nbsp;=&nbsp;gs_lgort-lgort<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;注意，要取推荐款的剩余库存clabs_s<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0&nbsp;AND&nbsp;ls_stock_tjk-clabs_s&nbsp;&gt;&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ls_stock_tjk_tmp&nbsp;=&nbsp;ls_stock_tjk&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;ls_stock_tjk_tmp&nbsp;TO&nbsp;lt_stock_tjk_tmp&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF&nbsp;.<br />
&nbsp;&nbsp;END-OF-DEFINITION.<br />
<br />
&nbsp;&nbsp;IF&nbsp;G_FLG&nbsp;=&nbsp;'E'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT&nbsp;.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;IF&nbsp;gt_xnkh_wmz[]&nbsp;IS&nbsp;INITIAL&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'原款库存全部满足要货需求，不需要进行推荐款配货！'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'原款库存不能全部满足要货需求，开始推荐款配货！'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;SORT&nbsp;gt_xnkh_wmz&nbsp;BY&nbsp;ex_xnkh&nbsp;.<br />
&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;gt_xnkh_wmz&nbsp;COMPARING&nbsp;ex_xnkh&nbsp;.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;取得未满足需求的要货虚拟款的推荐款信息<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SELECT&nbsp;*<br />
&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;lt_tjk<br />
&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmrp0040_tjk<br />
&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;gt_xnkh_wmz<br />
&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;zyks&nbsp;=&nbsp;gt_xnkh_wmz-ex_xnkh&nbsp;.<br />
&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'原款没有推荐款信息，推荐款配货结束！'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT&nbsp;.<br />
&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;"&nbsp;将推荐款从列转换为行<br />
&nbsp;&nbsp;SORT&nbsp;lt_tjk&nbsp;BY&nbsp;zyks&nbsp;.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_tjk&nbsp;INTO&nbsp;ls_tjk.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;ls_xnkh_tjk&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_to_line&nbsp;ls_tjk-ztj1&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_to_line&nbsp;ls_tjk-ztj2&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_to_line&nbsp;ls_tjk-ztj3&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_to_line&nbsp;ls_tjk-ztj4&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_to_line&nbsp;ls_tjk-ztj5&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_to_line&nbsp;ls_tjk-ztj6&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_to_line&nbsp;ls_tjk-ztj7&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_to_line&nbsp;ls_tjk-ztj8&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_to_line&nbsp;ls_tjk-ztj9&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_to_line&nbsp;ls_tjk-ztj10&nbsp;.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;取推荐款库存<br />
   </div>
   <div class="code">
&nbsp;&nbsp;SORT&nbsp;lt_xnkh_tjk&nbsp;BY&nbsp;ex_xnkh&nbsp;.<br />
&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;lt_xnkh_tjk&nbsp;COMPARING&nbsp;ex_xnkh&nbsp;.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_lgort&nbsp;INTO&nbsp;gs_lgort&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;lrs_lgort&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;lrs_lgort-sign&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;lrs_lgort-option&nbsp;&nbsp;=&nbsp;'EQ'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;lrs_lgort-low&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_lgort-lgort.<br />
&nbsp;&nbsp;&nbsp;&nbsp;lrs_lgort-high&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;lrs_lgort&nbsp;to&nbsp;lrt_lgort&nbsp;.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;lrs_werks-sign&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;lrs_werks-option&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'EQ'&nbsp;.<br />
&nbsp;&nbsp;lrs_werks-low&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;p_werks&nbsp;.<br />
&nbsp;&nbsp;lrs_werks-high&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;APPEND&nbsp;lrs_werks&nbsp;TO&nbsp;lrt_werks&nbsp;.<br />
<br />
&nbsp;&nbsp;call&nbsp;function&nbsp;<a&nbsp;href&nbsp;="zmm_get_stock_xnkh/zmm_get_stock_xnkh.html">'ZMM_GET_STOCK_XNKH'</a><br />
&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IM_HAS_ZCT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'X'<br />
&nbsp;&nbsp;&nbsp;&nbsp;TABLES<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IT_XNKH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lt_xnkh_tjk<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IR_WERKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lrt_werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IR_LGORT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lrt_lgort<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ET_STOCK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lt_stock_tjk<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EMPTY_IT_XNKH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EMPTY_IR_WERKS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3&nbsp;.<br />
&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;IF&nbsp;lt_stock_tjk[]&nbsp;IS&nbsp;INITIAL&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'推荐款都没有库存，推荐款配货结束！'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT&nbsp;.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;"&nbsp;分配推荐款库存给未满足的要货需求<br />
&nbsp;&nbsp;SORT&nbsp;lt_stock_tjk&nbsp;BY&nbsp;ex_xnkh&nbsp;werks&nbsp;lgort&nbsp;.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_yh&nbsp;ASSIGNING&nbsp;&lt;gs_yh&gt;&nbsp;WHERE&nbsp;menge_n&nbsp;&gt;&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;gt_lgort&nbsp;INTO&nbsp;gs_lgort&nbsp;WITH&nbsp;KEY&nbsp;extwg&nbsp;=&nbsp;&lt;gs_yh&gt;-extwg<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;=&nbsp;p_werks&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;lt_tjk&nbsp;INTO&nbsp;ls_tjk&nbsp;WITH&nbsp;KEY&nbsp;zyks&nbsp;=&nbsp;&lt;gs_yh&gt;-ex_xnkh<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;将要货款对应的推荐款库存放入临时表<br />
&nbsp;&nbsp;&nbsp;&nbsp;REFRESH:&nbsp;lt_stock_tjk_tmp&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR:&nbsp;ls_stock_tjk_tmp&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_clabs_s&nbsp;ls_tjk-ztj1&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_clabs_s&nbsp;ls_tjk-ztj2&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_clabs_s&nbsp;ls_tjk-ztj3&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_clabs_s&nbsp;ls_tjk-ztj4&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_clabs_s&nbsp;ls_tjk-ztj5&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_clabs_s&nbsp;ls_tjk-ztj6&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_clabs_s&nbsp;ls_tjk-ztj7&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_clabs_s&nbsp;ls_tjk-ztj8&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_clabs_s&nbsp;ls_tjk-ztj9&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;tjk_clabs_s&nbsp;ls_tjk-ztj10&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;lt_stock_tjk_tmp[]&nbsp;IS&nbsp;INITIAL&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;将对应的推荐款按库存从大到小排序<br />
&nbsp;&nbsp;&nbsp;&nbsp;SORT&nbsp;lt_stock_tjk_tmp&nbsp;BY&nbsp;clabs_s&nbsp;DESCENDING&nbsp;ex_xnkh&nbsp;werks&nbsp;lgort&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;lt_stock_tjk_tmp&nbsp;COMPARING&nbsp;ex_xnkh&nbsp;werks&nbsp;lgort&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_stock_tjk_tmp&nbsp;INTO&nbsp;ls_stock_tjk_tmp&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;如果要货款的要货数量已经全部满足，则退出循环<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;gs_yh&gt;-menge_n&nbsp;&lt;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXIT&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR:&nbsp;lv_menge,lv_len&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;确定本次配货数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;&lt;gs_yh&gt;-menge_n&nbsp;&lt;=&nbsp;ls_stock_tjk_tmp-clabs_s.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;如果要货信息的未满足数量&lt;=推荐款号的剩余库存数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;本次配货数量&nbsp;=&nbsp;要货信息的未满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lv_menge&nbsp;=&nbsp;&lt;gs_yh&gt;-menge_n&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;否则，本次配货数量&nbsp;=&nbsp;推荐款号的剩余库存数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lv_menge&nbsp;=&nbsp;ls_stock_tjk_tmp-clabs_s&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-doc_number&nbsp;=&nbsp;&lt;gs_yh&gt;-doc_number.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-item_no&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-item_no.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phlx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-matnr.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;要货商品<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-ex_xnkh.&nbsp;&nbsp;&nbsp;"&nbsp;要货虚拟款号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lv_len&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;strlen(&nbsp;ls_stock_tjk_tmp-ex_xnkh&nbsp;).<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lv_len&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lv_len&nbsp;-&nbsp;4&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;lv_len&nbsp;&gt;&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr_ph&nbsp;&nbsp;&nbsp;=&nbsp;ls_stock_tjk_tmp-ex_xnkh+0(lv_len).&nbsp;"&nbsp;实际配货商品<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr_ph&nbsp;&nbsp;&nbsp;=&nbsp;ls_stock_tjk_tmp-ex_xnkh&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh_ph&nbsp;=&nbsp;ls_stock_tjk_tmp-ex_xnkh.&nbsp;&nbsp;&nbsp;"&nbsp;实际配货虚拟款号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks_ph&nbsp;&nbsp;&nbsp;=&nbsp;ls_stock_tjk_tmp-werks.&nbsp;&nbsp;"&nbsp;发货地点<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-lgort_ph&nbsp;&nbsp;&nbsp;=&nbsp;ls_stock_tjk_tmp-lgort.&nbsp;&nbsp;"&nbsp;发货库存地点<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-cth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_stock_tjk_tmp-cth.&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;抽屉号<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-datum_ph&nbsp;&nbsp;&nbsp;=&nbsp;g_datum.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-time_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;g_uzeit.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-name_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;sy-uname.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-xqsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&lt;gs_yh&gt;-menge.&nbsp;&nbsp;&nbsp;"&nbsp;要货数量<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;该行是推荐款配货，所以要货数量留在原款配货的行，推荐款配货的行要货数量设置为0<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-xqsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;0&nbsp;.&nbsp;&nbsp;&nbsp;"&nbsp;要货数量，<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lv_menge.&nbsp;&nbsp;&nbsp;"&nbsp;配货数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_ph&nbsp;TO&nbsp;gt_ph&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lv_line&nbsp;=&nbsp;lv_line&nbsp;+&nbsp;1&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;更新推荐款号的剩余库存件数<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;lt_stock_tjk&nbsp;ASSIGNING&nbsp;&lt;ls_stock_tjk&gt;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;ex_xnkh&nbsp;=&nbsp;ls_stock_tjk_tmp-ex_xnkh<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;=&nbsp;p_werks<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lgort&nbsp;=&nbsp;gs_lgort-lgort<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BINARY&nbsp;SEARCH&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ls_stock_tjk&gt;-clabs_s&nbsp;=&nbsp;&lt;ls_stock_tjk&gt;-clabs_s&nbsp;-&nbsp;lv_menge&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;更新要货信息中的未满足数量、本款满足数量、推荐款满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_yh&gt;-menge_n&nbsp;=&nbsp;&lt;gs_yh&gt;-menge_n&nbsp;-&nbsp;lv_menge.&nbsp;"&nbsp;未满足数量<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_yh&gt;-menge_y&nbsp;=&nbsp;&lt;gs_yh&gt;-menge_y&nbsp;+&nbsp;lv_menge&nbsp;.&nbsp;&nbsp;"&nbsp;本款满足数量<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_yh&gt;-menge_t&nbsp;=&nbsp;&lt;gs_yh&gt;-menge_t&nbsp;+&nbsp;lv_menge.&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;推荐款满足数量<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;gs_yh&gt;-has_ph_tjk&nbsp;&nbsp;=&nbsp;'X'&nbsp;.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;标志，该要货信息至少产生一条推荐款配货信息<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'推荐款配货结束，产生配货信息：'&nbsp;&&&nbsp;lv_line&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;'条！'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_ADD_STORE<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&gt;P_LT_TJK&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*FORM&nbsp;frm_add_store.<br />
*<br />
*&nbsp;&nbsp;DATA:<br />
*&nbsp;&nbsp;&nbsp;&nbsp;lt_batch&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zmmrp0210_batch,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ls_batch&nbsp;TYPE&nbsp;zmmrp0210_batch,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;lt_attr&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;/spe/batch_and_values,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ls_attr&nbsp;&nbsp;TYPE&nbsp;/spe/batch_and_values,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;lt_lgort&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zmm_delevlgort,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;lt_mchb&nbsp;&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;mchb,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;lt_store&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;ty_store,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ls_mchb&nbsp;&nbsp;TYPE&nbsp;mchb,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ls_mara&nbsp;&nbsp;TYPE&nbsp;mara,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;l_count&nbsp;&nbsp;TYPE&nbsp;i,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;l_flg&nbsp;&nbsp;&nbsp;&nbsp;TYPE&nbsp;char1,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;l_menge&nbsp;&nbsp;TYPE&nbsp;menge_d,<br />
*&nbsp;&nbsp;&nbsp;&nbsp;l_message&nbsp;TYPE&nbsp;char255.<br />
*<br />
*&nbsp;&nbsp;SELECT&nbsp;*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;lt_batch<br />
*&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;zmmrp0210_batch<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;gt_tjk<br />
*&nbsp;&nbsp;&nbsp;WHERE&nbsp;matnr&nbsp;&nbsp;&nbsp;=&nbsp;gt_tjk-matnr<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ex_xnkh&nbsp;=&nbsp;gt_tjk-ex_xnkh.<br />
*<br />
*&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;'推荐款对应的商品批次附加信息表没有数据!'&nbsp;TYPE&nbsp;'S'&nbsp;DISPLAY&nbsp;LIKE&nbsp;'E'.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
*&nbsp;&nbsp;ENDIF.<br />
*<br />
*&nbsp;&nbsp;REFRESH&nbsp;lt_store.<br />
*&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_batch&nbsp;INTO&nbsp;ls_batch.<br />
**&nbsp;&nbsp;&nbsp;批次特性<br />
*&nbsp;&nbsp;&nbsp;&nbsp;REFRESH&nbsp;lt_attr.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'/SPE/READ_CLASSIFICATION_DATA'<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_charg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-charg<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-matnr<br />
**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-werks<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TABLES<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e_values&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lt_attr<br />
**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_attr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lt_attr<br />
**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;E_BATCHES&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;no_classification&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;no_classtypes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nothing_found&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plant_missing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;4<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plant_unknown&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;5<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;some_attribs_missing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;6<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_attr_is_empty&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;7<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;8.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_attr&nbsp;INTO&nbsp;ls_attr&nbsp;WHERE&nbsp;(&nbsp;atnam&nbsp;=&nbsp;'抽屉1'<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;atwrt&nbsp;&lt;&gt;&nbsp;''<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;atwrt&nbsp;&lt;&gt;&nbsp;'?'&nbsp;)<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;(&nbsp;atnam&nbsp;=&nbsp;'抽屉2'<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;atwrt&nbsp;&lt;&gt;&nbsp;''<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;atwrt&nbsp;&lt;&gt;&nbsp;'?').<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;SINGLE&nbsp;*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;ls_mara<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;mara<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;matnr&nbsp;=&nbsp;ls_batch-matnr.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
**&nbsp;&nbsp;&nbsp;取得库存<br />
*&nbsp;&nbsp;&nbsp;&nbsp;REFRESH&nbsp;lt_lgort.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_lgort&nbsp;INTO&nbsp;gs_lgort&nbsp;WHERE&nbsp;extwg&nbsp;=&nbsp;ls_mara-extwg.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_lgort&nbsp;TO&nbsp;lt_lgort.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;REFRESH&nbsp;lt_mchb.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;TABLE&nbsp;lt_mchb<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;mchb<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FOR&nbsp;ALL&nbsp;ENTRIES&nbsp;IN&nbsp;lt_lgort<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;matnr&nbsp;=&nbsp;ls_batch-matnr<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;werks&nbsp;=&nbsp;lt_lgort-werks<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;lgort&nbsp;=&nbsp;lt_lgort-lgort<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;charg&nbsp;=&nbsp;ls_batch-charg.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_mchb&nbsp;INTO&nbsp;ls_mchb.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;gs_store.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-matnr&nbsp;&nbsp;&nbsp;=&nbsp;ls_mchb-matnr.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-ex_xnkh&nbsp;=&nbsp;ls_batch-ex_xnkh.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-werks&nbsp;&nbsp;&nbsp;=&nbsp;ls_mchb-werks.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-lgort&nbsp;&nbsp;&nbsp;=&nbsp;ls_mchb-lgort.<br />
*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;ls_mara-meins&nbsp;=&nbsp;'ST'.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-clabs&nbsp;=&nbsp;ls_mchb-clabs.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;ls_mara-tempb&nbsp;=&nbsp;'01'.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;ls_mchb-clabs&nbsp;&gt;&nbsp;0.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-clabs&nbsp;=&nbsp;1.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSEIF&nbsp;ls_mara-tempb&nbsp;=&nbsp;'02'<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OR&nbsp;ls_mara-tempb&nbsp;=&nbsp;'03'.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;lt_attr&nbsp;INTO&nbsp;ls_attr<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;atnam&nbsp;=&nbsp;'金重'.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;ls_attr-atwrt&nbsp;&gt;&nbsp;0.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-clabs&nbsp;=&nbsp;ls_mchb-clabs&nbsp;/&nbsp;ls_attr-atwrt.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-clabs&nbsp;=&nbsp;1.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COLLECT&nbsp;gs_store&nbsp;INTO&nbsp;lt_store.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
*&nbsp;&nbsp;ENDLOOP.<br />
*<br />
**&nbsp;汇总<br />
*&nbsp;&nbsp;DELETE&nbsp;lt_store&nbsp;WHERE&nbsp;clabs&nbsp;=&nbsp;0.<br />
*&nbsp;&nbsp;SORT&nbsp;lt_store&nbsp;BY&nbsp;matnr&nbsp;ex_xnkh&nbsp;clabs&nbsp;DESCENDING&nbsp;werks&nbsp;lgort.<br />
*&nbsp;&nbsp;l_count&nbsp;=&nbsp;0.<br />
*&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_store&nbsp;INTO&nbsp;gs_store.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;AT&nbsp;NEW&nbsp;ex_xnkh.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_count&nbsp;=&nbsp;0.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDAT.<br />
*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;l_count&nbsp;=&nbsp;l_count&nbsp;+&nbsp;1.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;l_flg&nbsp;=&nbsp;''.<br />
*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;l_count&nbsp;&gt;&nbsp;1.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_flg&nbsp;=&nbsp;'X'.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;AT&nbsp;END&nbsp;OF&nbsp;ex_xnkh.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;l_count&nbsp;&gt;&nbsp;1.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_flg&nbsp;=&nbsp;'X'.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDAT.<br />
*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;l_flg&nbsp;=&nbsp;'X'.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;l_message.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONCATENATE&nbsp;'商品'<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-matnr<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'虚拟款号'<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-ex_xnkh<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'在多个库存地点有库存!'<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;l_message.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;s001(00)&nbsp;WITH&nbsp;l_message.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DELETE&nbsp;TABLE&nbsp;lt_store&nbsp;FROM&nbsp;gs_store.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*&nbsp;&nbsp;ENDLOOP.<br />
**&nbsp;编辑数据<br />
*&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_store&nbsp;INTO&nbsp;gs_store.<br />
**&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;l_menge.<br />
**&nbsp;&nbsp;&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_yh&nbsp;INTO&nbsp;gs_yh&nbsp;WHERE&nbsp;matnr&nbsp;=&nbsp;gs_store-matnr<br />
**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND&nbsp;ex_xnkh&nbsp;=&nbsp;gs_store-ex_xnkh.<br />
**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l_menge&nbsp;=&nbsp;l_menge&nbsp;+&nbsp;gs_yh-menge.<br />
**&nbsp;&nbsp;&nbsp;&nbsp;ENDLOOP.<br />
**&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;l_menge&nbsp;&gt;&nbsp;0.<br />
**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-zrate&nbsp;=&nbsp;(&nbsp;gs_store-clabs&nbsp;/&nbsp;l_menge&nbsp;)&nbsp;*&nbsp;100.<br />
**&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;gs_store-menge&nbsp;=&nbsp;gs_store-clabs.<br />
**&nbsp;&nbsp;&nbsp;抽屉号<br />
*&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;lt_batch&nbsp;INTO&nbsp;ls_batch<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;KEY&nbsp;matnr&nbsp;=&nbsp;gs_store-matnr<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ex_xnkh&nbsp;=&nbsp;gs_store-ex_xnkh.<br />
*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;REFRESH&nbsp;lt_attr.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'/SPE/READ_CLASSIFICATION_DATA'<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_charg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-charg<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-matnr<br />
**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ls_batch-werks<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TABLES<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e_values&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lt_attr<br />
**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_attr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lt_attr<br />
**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;E_BATCHES&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;no_classification&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;no_classtypes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nothing_found&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plant_missing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;4<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plant_unknown&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;5<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;some_attribs_missing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;6<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i_attr_is_empty&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;7<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;8.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTINUE.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;lt_attr&nbsp;INTO&nbsp;ls_attr&nbsp;WITH&nbsp;KEY&nbsp;atnam&nbsp;=&nbsp;'抽屉1'.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-cth&nbsp;=&nbsp;ls_attr-atwrt.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;gs_store-cth&nbsp;IS&nbsp;INITIAL.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;READ&nbsp;TABLE&nbsp;lt_attr&nbsp;INTO&nbsp;ls_attr&nbsp;WITH&nbsp;KEY&nbsp;atnam&nbsp;=&nbsp;'抽屉2'.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs_store-cth&nbsp;=&nbsp;ls_attr-atwrt.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_store&nbsp;TO&nbsp;gt_store.<br />
*&nbsp;&nbsp;ENDLOOP.<br />
*&nbsp;&nbsp;DELETE&nbsp;gt_store&nbsp;WHERE&nbsp;menge&nbsp;&lt;=&nbsp;0.<br />
*ENDFORM.<br />
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_UPDATE_RESULT<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_update_result .<br />
&nbsp;&nbsp;DATA:&nbsp;LV_LINES&nbsp;TYPE&nbsp;I&nbsp;.<br />
<br />
&nbsp;&nbsp;IF&nbsp;g_flg&nbsp;=&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;IF&nbsp;CBX_2&nbsp;=&nbsp;'X'&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LV_LINES&nbsp;=&nbsp;LINES(&nbsp;GT_YH&nbsp;)&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'您选择的是模拟执行，不需要保存数据！'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;'本次为'&nbsp;&&&nbsp;LV_LINES&nbsp;&&&nbsp;'条要货记录进行配货！'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;LV_LINES&nbsp;=&nbsp;LINES(&nbsp;GT_PH&nbsp;)&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;'共产生'&nbsp;&&&nbsp;LV_LINES&nbsp;&&&nbsp;'条配货记录！'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT&nbsp;.<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;IF&nbsp;GT_PH[]&nbsp;IS&nbsp;NOT&nbsp;INITIAL&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MODIFY&nbsp;zmm_delevresult&nbsp;FROM&nbsp;TABLE&nbsp;gt_ph.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;=&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;frm_doc_status.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;G_FLG&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COMMIT&nbsp;WORK&nbsp;AND&nbsp;WAIT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROLLBACK&nbsp;WORK&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXIT&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;发送配货结果IDOC<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WAIT&nbsp;UP&nbsp;TO&nbsp;2&nbsp;SECONDS&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;frm_set_idoc.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROLLBACK&nbsp;WORK.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'保存配货结果到表zmm_delevresult失败！'&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;G_FLG&nbsp;=&nbsp;'E'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_UNLOCK_WERKS<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_unlock_werks .<br />
&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'DEQUEUE_EZMMRP0040_WERK'<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;p_werks.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_SET_IDOC<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_set_idoc .<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_data&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zmm_delevresult.<br />
<br />
&nbsp;&nbsp;REFRESH&nbsp;lt_data.<br />
&nbsp;&nbsp;lt_data[]&nbsp;=&nbsp;gt_ph[].<br />
<br />
&nbsp;&nbsp;SORT&nbsp;lt_data&nbsp;BY&nbsp;doc_number.<br />
&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;lt_data&nbsp;COMPARING&nbsp;doc_number.<br />
<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_data&nbsp;INTO&nbsp;gs_ph.<br />
&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;function&nbsp;<a&nbsp;href&nbsp;="zmmif0110_idoc_output/zmmif0110_idoc_output.html">'ZMMIF0110_IDOC_OUTPUT'</a><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;im_doc_number&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_ph-doc_number.<br />
&nbsp;&nbsp;ENDLOOP.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_DOC_STATUS<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_doc_status .<br />
&nbsp;&nbsp;DATA:<br />
&nbsp;&nbsp;&nbsp;&nbsp;lt_data&nbsp;TYPE&nbsp;STANDARD&nbsp;TABLE&nbsp;OF&nbsp;zmm_delevresult,<br />
&nbsp;&nbsp;&nbsp;&nbsp;l_flg&nbsp;TYPE&nbsp;char1.<br />
&nbsp;&nbsp;lt_data[]&nbsp;=&nbsp;gt_ph[].<br />
<br />
&nbsp;&nbsp;SORT&nbsp;lt_data&nbsp;BY&nbsp;doc_number.<br />
&nbsp;&nbsp;DELETE&nbsp;ADJACENT&nbsp;DUPLICATES&nbsp;FROM&nbsp;lt_data&nbsp;COMPARING&nbsp;doc_number.<br />
<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;lt_data&nbsp;INTO&nbsp;gs_ph.<br />
&nbsp;&nbsp;&nbsp;&nbsp;UPDATE&nbsp;zsdif0050_head<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SET&nbsp;doc_ind&nbsp;=&nbsp;'1'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;doc_number&nbsp;=&nbsp;gs_ph-doc_number.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'更新表zsdif0050_head失败！'&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;G_flg&nbsp;=&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'更新表zsdif0050_head成功！'&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;UPDATE&nbsp;zsdif0050_item<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SET&nbsp;item_ind&nbsp;=&nbsp;'1'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;doc_number&nbsp;=&nbsp;gs_ph-doc_number.<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;sy-subrc&nbsp;&lt;&gt;&nbsp;0.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'更新表zsdif0050_item失败！'&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;G_flg&nbsp;=&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'更新表zsdif0050_item成功！'&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_ADD_PH<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM frm_add_ph .<br />
&nbsp;&nbsp;DATA:&nbsp;lv_line&nbsp;TYPE&nbsp;i&nbsp;.<br />
&nbsp;&nbsp;IF&nbsp;g_flg&nbsp;=&nbsp;'E'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXIT.<br />
&nbsp;&nbsp;ENDIF.<br />
   </div>
   <div class="codeComment">
*&nbsp;如果一个要货信息没有原款配货也要添加到配货结果中：<br />
*<br />
*&nbsp;例如要货款式是A，要货数量是16，有以下五种情况<br />
*<br />
*&nbsp;情况1：原款配货全部满足，返回配货结果如下：<br />
*&nbsp;原款号&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;配货款号&nbsp;&nbsp;&nbsp;&nbsp;需求数量&nbsp;&nbsp;&nbsp;&nbsp;配货数量<br />
*&nbsp;&nbsp;A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;16<br />
*<br />
*&nbsp;情况2：原款配货部分满足，没有推荐款，返回配货结果如下：<br />
*&nbsp;原款号&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;配货款号&nbsp;&nbsp;&nbsp;&nbsp;需求数量&nbsp;&nbsp;&nbsp;&nbsp;配货数量<br />
*&nbsp;&nbsp;A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7<br />
*<br />
*&nbsp;情况3：原款配货部分满足，推荐款部分/全部满足，返回配货结果如下：<br />
*&nbsp;原款号&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;配货款号&nbsp;&nbsp;&nbsp;&nbsp;需求数量&nbsp;&nbsp;&nbsp;&nbsp;配货数量<br />
*&nbsp;&nbsp;A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7<br />
*&nbsp;&nbsp;A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5<br />
*<br />
*&nbsp;情况4：原款配货没有，推荐款部分/全部满足，返回配货结果如下：<br />
*&nbsp;原款号&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;配货款号&nbsp;&nbsp;&nbsp;&nbsp;需求数量&nbsp;&nbsp;&nbsp;&nbsp;配货数量<br />
*&nbsp;&nbsp;A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0<br />
*&nbsp;&nbsp;A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5<br />
*<br />
*&nbsp;情况5：原款配货没有，推荐款没有，返回配货结果如下：<br />
*&nbsp;原款号&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;配货款号&nbsp;&nbsp;&nbsp;&nbsp;需求数量&nbsp;&nbsp;&nbsp;&nbsp;配货数量<br />
*&nbsp;&nbsp;A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0<br />
*<br />
*&nbsp;情况1,2,3的数据在原款配货和推荐款配货中都已经产生；<br />
*&nbsp;情况4,5的第一行通过这段程序产生，gt_yh中has_ph_ykh&nbsp;=&nbsp;''&nbsp;就是这种情况<br />
   </div>
   <div class="code">
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;gt_yh&nbsp;INTO&nbsp;gs_yh&nbsp;WHERE&nbsp;has_ph_ykh&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CLEAR&nbsp;gs_ph.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-doc_number&nbsp;=&nbsp;gs_yh-doc_number.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-item_no&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-item_no.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-werks.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phlx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-matnr.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-ex_xnkh.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-matnr_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-matnr.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-ex_xnkh_ph&nbsp;=&nbsp;gs_store-ex_xnkh.<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-xqsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_yh-menge.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-phsl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;0.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-werks_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-werks.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-lgort_ph&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-lgort.<br />
*&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-cth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;gs_store-cth.<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-datum_ph&nbsp;&nbsp;&nbsp;=&nbsp;g_datum.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-time_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;g_uzeit.<br />
&nbsp;&nbsp;&nbsp;&nbsp;gs_ph-name_ph&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;sy-uname.<br />
&nbsp;&nbsp;&nbsp;&nbsp;APPEND&nbsp;gs_ph&nbsp;TO&nbsp;gt_ph.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;IF&nbsp;gs_yh-has_ph_tjk&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lv_line&nbsp;=&nbsp;lv_line&nbsp;+&nbsp;1&nbsp;.&nbsp;"&nbsp;原款和推荐款都没有配货的行数<br />
&nbsp;&nbsp;&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;ENDLOOP.<br />
<br />
&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'有'&nbsp;&&&nbsp;lv_line&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;'条要货信息完全没有配货数量！'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
<br />
&nbsp;&nbsp;GET&nbsp;TIME&nbsp;.<br />
&nbsp;&nbsp;CLEAR&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-TYPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'I'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'ZCB'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-NUMBER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'000'&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V1&nbsp;=&nbsp;'配货结束，日期：'&nbsp;&&&nbsp;SY-DATUM&nbsp;.&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V2&nbsp;=&nbsp;'，时间：'&nbsp;&&&nbsp;SY-UZEIT&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V3&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;GS_MSG-MESSAGE_V4&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;APPEND&nbsp;GS_MSG&nbsp;TO&nbsp;GT_MSG&nbsp;.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_DIS_RESULT<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FRM_DIS_RESULT .<br />
&nbsp;&nbsp;IF&nbsp;CBX_1&nbsp;=&nbsp;''&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;FRM_WRITE_MSG&nbsp;.<br />
&nbsp;&nbsp;ELSE.<br />
&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;FRM_DIS_ALV&nbsp;.<br />
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_WRITE_MSG<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FRM_WRITE_MSG .<br />
&nbsp;&nbsp;DATA&nbsp;LV_STR&nbsp;TYPE&nbsp;STRING&nbsp;.<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_MSG&nbsp;INTO&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;ID&nbsp;GS_MSG-ID&nbsp;TYPE&nbsp;GS_MSG-TYPE&nbsp;NUMBER&nbsp;GS_MSG-NUMBER<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;LV_STR<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;GS_MSG-MESSAGE_V1&nbsp;GS_MSG-MESSAGE_V2&nbsp;GS_MSG-MESSAGE_V3&nbsp;GS_MSG-MESSAGE_V4&nbsp;&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WRITE:&nbsp;/&nbsp;LV_STR&nbsp;.<br />
&nbsp;&nbsp;ENDLOOP.<br />
ENDFORM.<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_DIS_ALV<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FRM_DIS_ALV .<br />
&nbsp;&nbsp;PERFORM&nbsp;FRM_BUILD_FIELDCAT.&nbsp;&nbsp;&nbsp;"&nbsp;设置显示字段属性<br />
&nbsp;&nbsp;PERFORM&nbsp;FRM_BUILD_LAYOUT.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;设置屏幕布局<br />
&nbsp;&nbsp;PERFORM&nbsp;FRM_ALV_DISPLAY.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"&nbsp;ALV显示<br />
ENDFORM.<br />
<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_BUILD_FIELDCAT<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;设置显示字段属性<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FRM_BUILD_FIELDCAT .<br />
&nbsp;&nbsp;REFRESH&nbsp;GT_FIELDCAT.<br />
<br />
&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'REUSE_ALV_FIELDCATALOG_MERGE'<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I_PROGRAM_NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&nbsp;SY-REPID<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I_INTERNAL_TABNAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I_STRUCTURE_NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&nbsp;'zmm_delevresult'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I_CLIENT_NEVER_DISPLAY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'X'<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I_INCLNAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I_BYPASSING_BUFFER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I_BUFFER_ACTIVE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;CHANGING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CT_FIELDCAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;GT_FIELDCAT<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;EXCEPTIONS<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INCONSISTENT_INTERFACE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROGRAM_ERROR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OTHERS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3<br />
   </div>
   <div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
&nbsp;&nbsp;IF&nbsp;SY-SUBRC&nbsp;&lt;&gt;&nbsp;0.<br />
   </div>
   <div class="codeComment">
*&nbsp;Implement&nbsp;suitable&nbsp;error&nbsp;handling&nbsp;here<br />
   </div>
   <div class="code">
&nbsp;&nbsp;ENDIF.<br />
ENDFORM.                    " FRM_BUILD_FIELDCAT<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;SUB_SET_FIELDS<br />
*&---------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM SUB_SET_FIELDS USING I_FIELDNAME TYPE SLIS_FIELDNAME<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I_REPTEXT&nbsp;TYPE&nbsp;DD03P-REPTEXT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I_OUTPUTLEN&nbsp;TYPE&nbsp;DD03P-OUTPUTLEN.<br />
&nbsp;&nbsp;GS_FIELDCAT-FIELDNAME&nbsp;=&nbsp;I_FIELDNAME.<br />
&nbsp;&nbsp;GS_FIELDCAT-REPTEXT_DDIC&nbsp;=&nbsp;I_REPTEXT.<br />
&nbsp;&nbsp;GS_FIELDCAT-NO_ZERO&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;GS_FIELDCAT-OUTPUTLEN&nbsp;=&nbsp;I_OUTPUTLEN.<br />
&nbsp;&nbsp;IF&nbsp;I_FIELDNAME&nbsp;=&nbsp;'BOX'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_FIELDCAT-CHECKBOX&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;&nbsp;&nbsp;GS_FIELDCAT-EDIT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'X'.<br />
&nbsp;&nbsp;ENDIF.<br />
&nbsp;&nbsp;APPEND&nbsp;GS_FIELDCAT&nbsp;TO&nbsp;GT_FIELDCAT.<br />
&nbsp;&nbsp;CLEAR&nbsp;GS_FIELDCAT.<br />
ENDFORM.                    "SUB_SET_FIELDS<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_BUILD_LAYOUT<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;设置屏幕布局<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FRM_BUILD_LAYOUT .<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;输出长度的最优化设计<br />
*&nbsp;&nbsp;gs_layout-colwidth_optimize&nbsp;=&nbsp;'X'.<br />
*&nbsp;&nbsp;gs_layout-box_fieldname&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;'BOX'.<br />
<br />
   </div>
   <div class="code">
ENDFORM.                    " FRM_BUILD_LAYOUT<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_ALV_DISPLAY<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALV显示<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FRM_ALV_DISPLAY .<br />
<br />
   </div>
   <div class="codeComment">
*&nbsp;调用ALV&nbsp;FUNCTION<br />
   </div>
   <div class="code">
&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'REUSE_ALV_GRID_DISPLAY'<br />
&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I_CALLBACK_PROGRAM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;SY-REPID<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I_CALLBACK_PF_STATUS_SET&nbsp;=&nbsp;'FRM_PF_STATUS_SET'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I_CALLBACK_USER_COMMAND&nbsp;&nbsp;=&nbsp;'FRM_USER_COMMAND'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I_CALLBACK_HTML_TOP_OF_PAGE&nbsp;=&nbsp;'HTML_TOP_OF_PAGE'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IS_LAYOUT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;GS_LAYOUT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IT_FIELDCAT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;GT_FIELDCAT<br />
&nbsp;&nbsp;&nbsp;&nbsp;TABLES<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;T_OUTTAB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;GT_PH.<br />
<br />
ENDFORM.                    " FRM_ALV_DISPLAY<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_PF_STATUS_SET<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;设置状态栏<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FRM_PF_STATUS_SET USING RT_EXTAB TYPE SLIS_T_EXTAB.<br />
<br />
&nbsp;&nbsp;SET&nbsp;PF-STATUS&nbsp;'STANDARD'.<br />
<br />
ENDFORM.                    " FRM_PF_STATUS_SET<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;FRM_USER_COMMAND<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;定义按钮功能<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM FRM_USER_COMMAND  USING R_UCOMM LIKE SY-UCOMM<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RS_SELFIELD&nbsp;TYPE&nbsp;SLIS_SELFIELD.<br />
<br />
&nbsp;&nbsp;DATA&nbsp;G_GRID&nbsp;TYPE&nbsp;REF&nbsp;TO&nbsp;CL_GUI_ALV_GRID.&nbsp;"&nbsp;刷新数据<br />
&nbsp;&nbsp;CALL&nbsp;FUNCTION&nbsp;'GET_GLOBALS_FROM_SLVC_FULLSCR'<br />
&nbsp;&nbsp;&nbsp;&nbsp;IMPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;E_GRID&nbsp;=&nbsp;G_GRID.<br />
&nbsp;&nbsp;CALL&nbsp;METHOD&nbsp;G_GRID-&gt;CHECK_CHANGED_DATA.<br />
&nbsp;&nbsp;IF&nbsp;NOT&nbsp;G_GRID&nbsp;IS&nbsp;INITIAL.<br />
&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;METHOD&nbsp;G_GRID-&gt;REFRESH_TABLE_DISPLAY.&nbsp;"refresh&nbsp;alv<br />
&nbsp;&nbsp;ENDIF.<br />
<br />
&nbsp;&nbsp;CASE&nbsp;R_UCOMM.<br />
&nbsp;&nbsp;&nbsp;&nbsp;WHEN&nbsp;'SAVE'.<br />
   </div>
   <div class="codeComment">
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PERFORM&nbsp;FRM_UPDATE_DATA.<br />
   </div>
   <div class="code">
&nbsp;&nbsp;ENDCASE.<br />
<br />
&nbsp;&nbsp;RS_SELFIELD-REFRESH&nbsp;=&nbsp;'X'.<br />
<br />
ENDFORM.                    " FRM_USER_COMMAND<br />
   </div>
   <div class="codeComment">
*&---------------------------------------------------------------------*<br />
*&&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Form&nbsp;&nbsp;HTML_TOP_OF_PAGE<br />
*&---------------------------------------------------------------------*<br />
*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;定义按钮功能<br />
*----------------------------------------------------------------------*<br />
*&nbsp;&nbsp;--&gt;&nbsp;&nbsp;p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*&nbsp;&nbsp;&lt;--&nbsp;&nbsp;p2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text<br />
*----------------------------------------------------------------------*<br />
   </div>
   <div class="code">
FORM HTML_TOP_OF_PAGE USING CL_DD TYPE REF TO CL_DD_DOCUMENT.<br />
&nbsp;&nbsp;DATA&nbsp;LV_TEXT&nbsp;TYPE&nbsp;C&nbsp;LENGTH&nbsp;255&nbsp;.<br />
<br />
&nbsp;&nbsp;LOOP&nbsp;AT&nbsp;GT_MSG&nbsp;INTO&nbsp;GS_MSG&nbsp;.<br />
&nbsp;&nbsp;&nbsp;&nbsp;MESSAGE&nbsp;ID&nbsp;GS_MSG-ID&nbsp;TYPE&nbsp;GS_MSG-TYPE&nbsp;NUMBER&nbsp;GS_MSG-NUMBER<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTO&nbsp;LV_TEXT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH&nbsp;GS_MSG-MESSAGE_V1&nbsp;GS_MSG-MESSAGE_V2&nbsp;GS_MSG-MESSAGE_V3&nbsp;GS_MSG-MESSAGE_V4&nbsp;&nbsp;.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;METHOD&nbsp;CL_DD-&gt;ADD_TEXT<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXPORTING<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TEXT&nbsp;=&nbsp;LV_TEXT&nbsp;.<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;CALL&nbsp;METHOD&nbsp;CL_DD-&gt;NEW_LINE&nbsp;.<br />
&nbsp;&nbsp;ENDLOOP.<br />
ENDFORM .<br />
<br />
<br />
   </div>
   <div class="codeComment">
*Selection&nbsp;texts<br />
*----------------------------------------------------------<br />
*&nbsp;CBX_1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;以ALV显示相似款匹配结果（数据量大时请勿选择）<br />
*&nbsp;CBX_2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;模拟执行，不将结果保存到数据库<br />
*&nbsp;P_WERKS&nbsp;D&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<br />
            </div>
          </td>
        </tr>
      </table>
      </td>
      </tr>
   <tr>
<td class="footer">www.bjcaibai.com.cn201609</td>
   </tr>
</table>
</body>
</html>
